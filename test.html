<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>拓展包管理器</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
        }
        
        .sidebar {
            width: 60px;
            background-color: #333;
            height: 100vh;
            padding-top: 20px;
        }
        
        .sidebar button {
            width: 50px;
            height: 50px;
            margin: 5px;
            border: none;
            background-color: #444;
            color: white;
            cursor: pointer;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .top-buttons {
            margin-bottom: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .settings-form {
            max-width: 500px;
        }
        
        .settings-form textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group select {
            padding: 5px;
            width: 200px;
        }
        
        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .planets-container {
            display: flex;
            gap: 20px;
        }
        
        .planets-list {
            width: 250px;
            border-right: 1px solid #ccc;
        }
        
        .list-header {
            margin-bottom: 15px;
        }
        
        .planet-buttons {
            display: flex;
            gap: 10px;
        }
        
        .list-content {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .planet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .planet-item span {
            flex: 1;
        }
        
        .planet-item-buttons {
            display: flex;
            gap: 5px;
        }
        
        .planet-item-buttons button {
            padding: 2px 5px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
        
        .planet-item-buttons button:hover {
            background-color: #eee;
            border-radius: 3px;
        }
        
        .planet-item:hover {
            background-color: #f5f5f5;
        }
        
        .planet-item.selected {
            background-color: #e3e3e3;
        }
        
        .planet-editor {
            flex: 1;
        }
        
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .module-toggles {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .module-toggles button {
            margin-right: 5px;
            padding: 5px 10px;
        }
        
        .module-toggles button.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .save-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .module-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .fog-key {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .fog-key h6 {
            margin: 0 0 10px 0;
        }
        
        select {
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        
        .module-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .module-section {
            margin-bottom: 15px;
        }
        
        .module-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        /* 地形模块的基本样式 */
        .module-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .module-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .module-section h5 {
            margin: 10px 0;
            color: #495057;
        }

        /* 表单组样式 */
        .form-group {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .form-group label {
            display: inline-block;
            width: 120px;
            margin-right: 10px;
            color: #495057;
        }

        .form-group input[type="number"],
        .form-group input[type="text"] {
            width: 100px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 15px;
        }

        .form-group select {
            width: 200px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 15px;
            background-color: white;
        }

        .form-group input[type="checkbox"] {
            margin-right: 5px;
        }

        /* 地形公式相关样式 */
        .difficulty-section {
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .formula-list {
            margin-bottom: 10px;
        }

        .formula-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .formula-item input {
            flex: 1;
            margin-right: 10px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .formula-item button {
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .formula-item button:hover {
            background: #c82333;
        }

        /* 按钮样式 */
        button {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        /* 响应式布局 */
        @media (max-width: 768px) {
            .form-group label {
                display: block;
                margin-bottom: 5px;
            }

            .form-group input[type="number"],
            .form-group input[type="text"],
            .form-group select {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        /* 添加新的CSS样式 */
        .formula-editor {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .formula-editor select,
        .formula-editor input {
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .formula-editor .heightmap-select {
            width: 150px;
        }

        .formula-editor .scale-input,
        .formula-editor .height-input {
            width: 100px;
        }

        .formula-editor .curve-select {
            width: 120px;
        }

        .flat-zone-editor {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .flat-zone-editor input {
            width: 100px;
        }

        #flatZonesList,
        #textureFormulas {
            margin-top: 10px;
        }

        .formula-item,
        .flat-zone-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .formula-item button,
        .flat-zone-item button {
            padding: 2px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        /* 轨道模块的基本样式 */
        .module-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .field-container {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .field-container label {
            width: 150px;
            margin-right: 10px;
        }

        .field-container input,
        .field-container select {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* 难度缩放部分的样式 */
        .difficulty-scale-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .difficulty-scale-section h5 {
            margin-bottom: 10px;
            color: #333;
        }

        .difficulty-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .difficulty-group label {
            width: 100px;
            margin-right: 10px;
        }

        .difficulty-group input {
            width: 80px;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* 输入框和选择框的悬停效果 */
        .field-container input:hover,
        .field-container select:hover,
        .difficulty-group input:hover {
            border-color: #999;
        }

        /* 输入框和选择框的焦点效果 */
        .field-container input:focus,
        .field-container select:focus,
        .difficulty-group input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }

        /* 后期处理模块的基本样式 */
        .keyframes-list {
            margin-bottom: 15px;
        }

        .keyframe-editor {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .keyframe-editor .field-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .keyframe-editor .field-container label {
            width: 100px;
            margin-right: 10px;
        }

        .keyframe-editor .field-container input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* 删除按钮样式 */
        .keyframe-editor .delete-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .keyframe-editor .delete-button:hover {
            background-color: #ff0000;
        }

        /* 添加关键帧按钮样式 */
        #postProcessingKeyframes + button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }

        #postProcessingKeyframes + button:hover {
            background-color: #45a049;
        }

        /* 输入框悬停和焦点效果 */
        .keyframe-editor .field-container input:hover {
            border-color: #999;
        }

        .keyframe-editor .field-container input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }

        /* 响应式布局 */
        @media (min-width: 768px) {
            .keyframe-editor .field-container {
                display: inline-flex;
                width: calc(50% - 10px);
                margin-right: 10px;
            }
        }

        @media (min-width: 1200px) {
            .keyframe-editor .field-container {
                width: calc(33.33% - 10px);
            }
        }

        /* 地标模块的基本样式 */
        .landmarks-list {
            margin-bottom: 15px;
        }

        .landmark-editor {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        /* 地标编辑器中的字段容器 */
        .landmark-editor .field-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .landmark-editor .field-container label {
            width: 80px;
            margin-right: 10px;
        }

        .landmark-editor .field-container input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* 名称输入框特殊样式 */
        .landmark-editor .field-container input[type="text"] {
            width: 200px;
        }

        /* 数字输入框特殊样式 */
        .landmark-editor .field-container input[type="number"] {
            width: 100px;
        }

        /* 删除按钮样式 */
        .landmark-editor .delete-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .landmark-editor .delete-button:hover {
            background-color: #ff0000;
        }

        /* 添加地标按钮样式 */
        #landmarksList + button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }

        #landmarksList + button:hover {
            background-color: #45a049;
        }

        /* 输入框悬停和焦点效果 */
        .landmark-editor .field-container input:hover {
            border-color: #999;
        }

        .landmark-editor .field-container input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }

        /* 响应式布局 */
        @media (min-width: 768px) {
            .landmark-editor {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                padding-right: 50px; /* 为删除按钮留出空间 */
            }

            .landmark-editor .field-container {
                width: calc(50% - 10px);
                margin-right: 10px;
            }
        }

        @media (min-width: 1200px) {
            .landmark-editor .field-container {
                width: calc(25% - 10px);
            }
        }

        .landmarks-group {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .landmark-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .landmark-item input[type="text"] {
            width: 200px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .landmark-item input[type="number"] {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .delete-landmark {
            padding: 2px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .add-landmark {
            margin-top: 10px;
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .delete-landmark:hover {
            background: #c82333;
        }

        .add-landmark:hover {
            background: #218838;
        }

        .heightmaps-layout {
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .heightmaps-list {
            width: 250px;
            border-right: 1px solid #ccc;
            padding-right: 20px;
        }

        .heightmap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: white;
        }

        .heightmap-name {
            flex: 1;
            padding: 5px;
            cursor: pointer;
            color: #2196F3;
        }

        .heightmap-name:hover {
            background-color: #f5f5f5;
            border-radius: 3px;
        }

        .delete-button {
            padding: 2px 8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }

        .delete-button:hover {
            background: #d32f2f;
        }

        /* 高度图预览部分的样式优化 */
        .heightmap-preview-container {
            flex: 1;
            padding: 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #heightmapPreview {
            max-width: 100%;
            overflow-x: auto;
        }

        #heightmapPreview canvas {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: crosshair;
        }

        .heightmap-data {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
        }

        .heightmap-data th {
            background-color: #f5f5f5;
            padding: 12px 8px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .heightmap-data td {
            padding: 8px;
            border: 1px solid #eee;
        }

        .heightmap-data tr:nth-child(even) {
            background-color: #fafafa;
        }

        .heightmap-toolbar {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .tool-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tool-button:hover {
            background: #eee;
        }

        .tool-button.active {
            background: #2196F3;
            color: white;
        }

        .tool-properties {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-property {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-property input[type="number"] {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tool-property label {
            font-size: 14px;
            color: #333;
        }

        #brushSizeValue, #brushStrengthValue, #noiseAmountValue {
            margin-left: 10px;
        }

        .heightmap-buttons {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }

        .heightmap-buttons button {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .heightmap-buttons button:hover {
            background: #45a049;
        }

        .textures-layout {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 150px);
        }

        .textures-list {
            width: 250px;
            border-right: 1px solid #ccc;
            padding-right: 20px;
            overflow-y: auto;
        }

        .texture-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .texture-item:hover {
            background-color: #f5f5f5;
        }

        .texture-name {
            color: #2196F3;
        }

        .texture-preview-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .texture-preview-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .texture-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .texture-item:hover {
            background-color: #f5f5f5;
        }

        .texture-item.selected {
            background-color: #e3f2fd;
        }

        .texture-name {
            color: #2196F3;
        }

        .texture-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .texture-preview-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button onclick="switchPage('settings')" title="设置">⚙️</button>
        <button onclick="switchPage('planets')" title="星球">🌍</button>
        <button onclick="switchPage('heightmaps')" title="高度图">📊</button>
        <button onclick="switchPage('textures')" title="图层">🖼️</button>
    </div>
    
    <div class="main-content">
        <div class="top-buttons">
            <button onclick="loadPack()">加载拓展包</button>
            <button onclick="createPack()">新建拓展包</button>
        </div>
        
        <div id="settings" class="page active">
            <h2>设置</h2>
            <div class="settings-form">
                <h3>导入设置</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeDefaultPlanets"> 
                        包含默认星球
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeDefaultHeightmaps"> 
                        包含默认地形图
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeDefaultTextures"> 
                        包含默认纹理
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="hideStarsInAtmosphere"> 
                        在大气层中隐藏星星
                    </label>
                </div>

                <h3>发射台设置</h3>
                <div class="form-group">
                    <label>所在星球：</label>
                    <select id="planetAddress">
                        <!-- 选项将通过JavaScript动态加载 -->
                    </select>
                </div>
                <div class="form-group">
                    <label>角度：</label>
                    <input type="number" id="launchAngle" step="0.1"> 度
                </div>
                <div class="form-group">
                    <label>水平位置：</label>
                    <input type="number" id="horizontalPosition" step="0.1"> 米
                </div>
                <div class="form-group">
                    <label>高度：</label>
                    <input type="number" id="height" step="0.1"> 米
                </div>

                <h3>版本信息</h3>
                <div class="form-group">
                    <label>版本号：</label>
                    <input type="text" id="version" placeholder="例如: 1.5.10.2">
                </div>

                <button onclick="saveSettings()">保存设置</button>
            </div>
        </div>
        
        <div id="planets" class="page">
            <h2>星球管理</h2>
            <div class="planets-container">
                <div class="planets-list">
                    <div class="list-header">
                        <h3>星球列表</h3>
                        <div class="planet-buttons">
                            <button onclick="loadPlanetFile()">加载星球</button>
                            <button onclick="createNewPlanet()">新建星球</button>
                        </div>
                    </div>
                    <div id="planetsList" class="list-content">
                        <!-- 星球列表将在这里动态显示 -->
                    </div>
                </div>
                
                <div class="planet-editor">
                    <div id="noPlanetSelected" style="display: block;">
                        请选择或创建一个星球
                    </div>
                    
                    <div id="planetEditForm" style="display: none;">
                        <h3 id="editingPlanetName"></h3>
                        
                        <div class="form-section">
                            <label>版本：</label>
                            <input type="text" id="planetVersion" value="1.5">
                        </div>

                        <div class="form-section">
                            <h4>基础数据</h4>
                            <div class="form-group">
                                <label>半径 (米)：</label>
                                <input type="number" id="planetRadius" step="1000">
                            </div>
                            <div class="form-group">
                                <label>重力 (m/s²)：</label>
                                <input type="number" id="planetGravity" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>时间加速高度 (米)：</label>
                                <input type="number" id="timewarpHeight">
                            </div>
                            <div class="form-group">
                                <label>速度箭头高度 (米)：</label>
                                <input type="number" id="velocityArrowsHeight">
                            </div>
                            <div class="form-group">
                                <label>地图颜色：</label>
                                <input type="color" id="mapColor">
                                <input type="range" id="mapColorAlpha" min="0" max="1" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="significant">
                                    重要天体
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="rotateCamera">
                                    相机旋转
                                </label>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>可选模块</h4>
                            <div class="module-toggles">
                                <button id="btnAtmospherePhysics" onclick="toggleModule('atmospherePhysics')">大气层物理</button>
                                <button id="btnAtmosphereVisuals" onclick="toggleModule('atmosphereVisuals')">大气层视觉</button>
                                <button id="btnTerrain" onclick="toggleModule('terrain')">地形</button>
                                <button id="btnOrbit" onclick="toggleModule('orbit')">轨道</button>
                                <button id="btnPostProcessing" onclick="toggleModule('postProcessing')">后期处理</button>
                            </div>
                            
                            <div id="moduleContent" class="module-content">
                                <!-- 模块内容将动态加载 -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>成就设置</h4>
                            <div class="achievements-group">
                                <label>
                                    <input type="checkbox" id="achieveLanded">
                                    着陆成就
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveTakeoff">
                                    起飞成就
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveAtmosphere">
                                    大气层成就
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveOrbit">
                                    轨道成就
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveCrash">
                                    坠毁成就
                                </label>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>地标设置</h4>
                            <div class="landmarks-group">
                                <!-- 添加地标列表 -->
                                <div id="landmarksList"></div>
                                <!-- 添加新地标按钮 -->
                                <button class="add-landmark">添加地标</button>
                            </div>
                        </div>

                        <button onclick="savePlanet()" class="save-button">保存星球</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="heightmaps" class="page">
            <h2>高度图</h2>
            <div class="heightmaps-layout">
                <div class="heightmaps-list">
                    <h3>高度图列表</h3>
                    <div id="heightmapsList"></div>
                </div>
                <div class="heightmap-preview-container">
                    <div id="heightmapPreview"></div>
                </div>
            </div>
        </div>
        
        <div id="textures" class="page">
            <h2>图层</h2>
            <div class="textures-layout">
                <div class="textures-list">
                    <h3>图层列表</h3>
                    <div id="texturesList"></div>
                </div>
                <div class="texture-preview-container">
                    <div id="texturePreview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 首先在文件顶部声明全局变量
        let heightmaps = ['Perlin']; // 默认值
        let currentPlanetData = null;

        // 在文件顶部添加全局变量
        let extensionDirHandle = null;

        // 在文件最顶部，和其他全局变量一起声明
        let currentDirHandle = null;
        let currentTool = 'brush';
        let isDrawing = false;
        let currentPoints = [];
        let currentHeightmapName = null;  // 添加这个全局变量声明

        // 在文件顶部的全局变量声明中添加
        let currentPage = 'settings'; // 默认显示设置页面

        const defaultSettings = {
            importSettings: {
                includeDefaultPlanets: false,
                includeDefaultHeightmaps: false,
                includeDefaultTextures: false,
                hideStarsInAtmosphere: false
            },
            spaceCenterData: {
                address: "",
                angle: 0.0,
                position_LaunchPad: {
                    horizontalPosition: 0.0,
                    height: 0.0
                }
            },
            version: ""
        };

        // 添加页面切换函数
        function switchPage(pageId) {
            console.log('切换页面到:', pageId); // 调试日志
            const targetPage = document.getElementById(pageId);
            if (!targetPage) {
                console.error(`找不到页面: ${pageId}`);
                return;
            }
            
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示选中的页面
            targetPage.classList.add('active');
            
            // 更新当前页面
            currentPage = pageId;
            
            // 如果切换到图层页面，重新加载图层列表
            if (pageId === 'textures' && currentDirHandle) {
                console.log('当前是图层页面'); // 调试日志
                console.log('currentDirHandle:', !!currentDirHandle); // 检查目录句柄是否存在
                if (currentDirHandle) {
                    console.log('开始加载图层列表...'); // 调试日志
                    loadTextures(currentDirHandle);
                } else {
                    console.log('未加载拓展包，无法加载图层列表'); // 调试日志
                }
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        async function loadPack() {
            console.log('开始加载拓展包...'); // 调试日志
            try {
                const dirHandle = await window.showDirectoryPicker();
                currentDirHandle = dirHandle; // 保存目录句柄以供续使用
                console.log('已获取目录句柄'); // 调试日志
                
                // 读取设置文件
                await loadSettingsFiles(dirHandle);
                console.log('已加载设置文件'); // 调试日志
                
                // 加载星球列表
                await loadPlanets(dirHandle);
                console.log('已加载星球列表'); // 调试日志
                
                // 加载高度图列表
                await loadHeightmaps(dirHandle);
                console.log('已加载高度图列表'); // 调试日志
                
                // 加载图层列表
                console.log('准备加载图层列表...'); // 调试日志
                await loadTextures(dirHandle);
                console.log('已加载图层列表'); // 调试日志
                
            } catch (err) {
                console.error('加载拓展包失败:', err);
            }
        }
// 在创建新拓展包的函数中添加以下代码
        async function createInitialHeightmap(dirHandle) {
            try {
                // 创建TEST.txt文件的内容
                const initialData = {
                    points: [0.5, 0.5]
                };
                
                // 创建并写入TEST.txt文件
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data')
                const fileHandle = await heightmapDir.getFileHandle('TEST.txt', { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(initialData, null, 4));
                await writable.close();
                
                console.log('成功创建初始高度图文件 TEST.txt');
            } catch (err) {
                console.error('创建初始高度图文件失败:', err);
            }
        }
        async function createPack() {
            const packName = prompt('请输入新拓展包名称：');
            if (!packName) return;

            try {
                const dirHandle = await window.showDirectoryPicker();
                const newDirHandle = await dirHandle.getDirectoryHandle(packName, { create: true });
                
                // 创建子目录
                await newDirHandle.getDirectoryHandle('Heightmap Data', { create: true });
                await newDirHandle.getDirectoryHandle('Planet Data', { create: true });
                await newDirHandle.getDirectoryHandle('Texture Data', { create: true });
                await createInitialHeightmap(dirHandle);
                // 创建设置文件
                await createSettingsFiles(newDirHandle);
                currentDirHandle = newDirHandle;
                await loadHeightmaps(currentDirHandle);
                alert('拓展包创建成功！');
            } catch (err) {
                console.error('错误:', err);
                alert('创建拓展包失败！');
            }
        }

        async function createSettingsFiles(dirHandle) {
            const files = {
                'Import_Settings.txt': JSON.stringify(defaultSettings.importSettings, null, 2),
                'Space_Center_Data.txt': JSON.stringify(defaultSettings.spaceCenterData, null, 2),
                'Version.txt': defaultSettings.version
            };

            for (const [filename, content] of Object.entries(files)) {
                const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
            }
        }

        async function loadSettingsFiles(dirHandle) {
            try {
                const importSettingsFile = await dirHandle.getFileHandle('Import_Settings.txt');
                const spaceCenterFile = await dirHandle.getFileHandle('Space_Center_Data.txt');
                const versionFile = await dirHandle.getFileHandle('Version.txt');

                const importSettings = JSON.parse(await (await importSettingsFile.getFile()).text());
                const spaceCenterData = JSON.parse(await (await spaceCenterFile.getFile()).text());
                const versionContent = await (await versionFile.getFile()).text();

                // 设置复选框状态
                document.getElementById('includeDefaultPlanets').checked = importSettings.includeDefaultPlanets;
                document.getElementById('includeDefaultHeightmaps').checked = importSettings.includeDefaultHeightmaps;
                document.getElementById('includeDefaultTextures').checked = importSettings.includeDefaultTextures;
                document.getElementById('hideStarsInAtmosphere').checked = importSettings.hideStarsInAtmosphere;

                // 加载行星列表并设置发射台数据
                await loadPlanetList(dirHandle);
                document.getElementById('planetAddress').value = spaceCenterData.address;
                document.getElementById('launchAngle').value = spaceCenterData.angle;
                document.getElementById('horizontalPosition').value = spaceCenterData.position_LaunchPad.horizontalPosition;
                document.getElementById('height').value = spaceCenterData.position_LaunchPad.height;

                // 设置版本
                document.getElementById('version').value = versionContent;
            } catch (err) {
                console.error('读取文件错误:', err);
                alert('读取设置文件失败！');
            }
        }

        async function saveSettings() {
            try {
                // 获取设置数据
                const settings = {
                    importSettings: {
                        includeDefaultPlanets: document.getElementById('includeDefaultPlanets').checked,
                        includeDefaultHeightmaps: document.getElementById('includeDefaultHeightmaps').checked,
                        includeDefaultTextures: document.getElementById('includeDefaultTextures').checked,
                        hideStarsInAtmosphere: document.getElementById('hideStarsInAtmosphere').checked
                    },
                    spaceCenterData: {
                        address: document.getElementById('planetAddress').value,
                        angle: parseFloat(document.getElementById('launchAngle').value),
                        position_LaunchPad: {
                            horizontalPosition: parseFloat(document.getElementById('horizontalPosition').value),
                            height: parseFloat(document.getElementById('height').value)
                        }
                    },
                    version: document.getElementById('version').value
                };

                // 保存 Import_Settings.txt
                const importSettingsFile = await currentDirHandle.getFileHandle('Import_Settings.txt', { create: true });
                const importSettingsWritable = await importSettingsFile.createWritable();
                await importSettingsWritable.write(JSON.stringify(settings.importSettings, null, 2));
                await importSettingsWritable.close();

                // 保存 Space_Center_Data.txt  
                const spaceCenterFile = await currentDirHandle.getFileHandle('Space_Center_Data.txt', { create: true });
                const spaceCenterWritable = await spaceCenterFile.createWritable();
                await spaceCenterWritable.write(JSON.stringify(settings.spaceCenterData, null, 2));
                await spaceCenterWritable.close();

                // 保存 Version.txt
                const versionFile = await currentDirHandle.getFileHandle('Version.txt', { create: true });
                const versionWritable = await versionFile.createWritable();
                await versionWritable.write(settings.version);
                await versionWritable.close();

                alert('设置已成功保存!');
            } catch (err) {
                console.error('保存设置失败:', err);
                alert('保存设置失败!错误信息: ' + err.message);
            }
        }

        async function loadPlanetList(dirHandle) {
            try {
                const planetDataDir = await dirHandle.getDirectoryHandle('Planet Data');
                const select = document.getElementById('planetAddress');
                select.innerHTML = ''; // 清空现有选项
                
                for await (const entry of planetDataDir.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                        const planetName = entry.name.replace('.txt', '');
                        const option = document.createElement('option');
                        option.value = planetName;
                        option.textContent = planetName;
                        select.appendChild(option);
                    }
                }
            } catch (err) {
                console.error('加载行星列表失败:', err);
            }
        }


        // 加载星球文件
        async function loadPlanetFile() {
            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: '星球文件',
                        accept: {
                            'text/plain': ['.txt']
                        }
                    }]
                });
                
                const file = await fileHandle.getFile();
                const content = await file.text();
                const planetData = JSON.parse(content);
                
                // 将文件加到列表中
                addPlanetToList(fileHandle.name.replace('.txt', ''), planetData);
            } catch (err) {
                console.error('加载星球文件失败:', err);
            }
        }

        // 创建新星球
        async function createNewPlanet() {
            const planetName = prompt('请输入星球名称：');
            if (!planetName) return;

            const newPlanetData = {
                version: "1.5",
                BASE_DATA: {
                    radius: 315000.0,
                    radiusDifficultyScale: {},
                    gravity: 9.8,
                    gravityDifficultyScale: {},
                    timewarpHeight: 25000.0,
                    velocityArrowsHeight: 5000.0,
                    mapColor: {
                        r: 0.45,
                        g: 0.68,
                        b: 1.0,
                        a: 1.0
                    },
                    significant: true,
                    rotateCamera: true
                },
                ACHIEVEMENT_DATA: {
                    Landed: false,
                    Takeoff: false,
                    Atmosphere: false,
                    Orbit: false,
                    Crash: false
                },
                LANDMARKS: []
            };

            addPlanetToList(planetName, newPlanetData);
        }

        // 将星球添加到列表中
        function addPlanetToList(planetName, planetData) {
            const planetsList = document.getElementById('planetsList');
            const planetItem = document.createElement('div');
            planetItem.className = 'planet-item';
            
            // 创建星���名称和操作按钮容器
            const nameSpan = document.createElement('span');
            nameSpan.textContent = planetName;
            nameSpan.onclick = () => selectPlanet(planetName, planetData);
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'planet-item-buttons';
            
            // 复制按钮
            const copyBtn = document.createElement('button');
            copyBtn.textContent = '复��';
            copyBtn.title = '复制';
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                copyPlanet(planetName, planetData);
            };
            
            // 删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '❌';
            deleteBtn.title = '删除';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deletePlanet(planetName, planetItem);
            };
            
            buttonsDiv.appendChild(copyBtn);
            buttonsDiv.appendChild(deleteBtn);
            
            planetItem.appendChild(nameSpan);
            planetItem.appendChild(buttonsDiv);
            planetsList.appendChild(planetItem);
        }

        // 添加复制星球功能
        async function copyPlanet(planetName, planetData) {
            const newName = prompt('请输入新星球名称：', planetName + '_copy');
            if (!newName) return;
            
            // 深拷贝星球数据
            const newPlanetData = JSON.parse(JSON.stringify(planetData));
            addPlanetToList(newName, newPlanetData);
            
            // 如果有当前目录句柄，保存到文件
            if (currentDirHandle) {
                try {
                    const planetDataDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                    await savePlanetToFile(planetDataDir, newName, newPlanetData);
                } catch (err) {
                    console.error('保存复制的星球失败:', err);
                }
            }
        }

        // 添加删除星���功能
        async function deletePlanet(planetName, planetItem) {
            if (!confirm(`确定要删除星球 "${planetName}" 吗？`)) return;
            
            if (currentDirHandle) {
                try {
                    const planetDataDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                    await planetDataDir.removeEntry(planetName + '.txt');
                } catch (err) {
                    console.error('删除星球文件失败:', err);
                    return;
                }
            }
            
            planetItem.remove();
        }

        // 添加文件保存功能
        async function savePlanetToFile(dirHandle, planetName, planetData) {
            const fileHandle = await dirHandle.getFileHandle(planetName + '.txt', { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(planetData, null, 2));
            await writable.close();
        }

        // 选择星球进行编辑
        function selectPlanet(planetName, planetData) {
            document.querySelectorAll('.planet-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            currentPlanetData = planetData;
            document.getElementById('noPlanetSelected').style.display = 'none';
            document.getElementById('planetEditForm').style.display = 'block';
            document.getElementById('editingPlanetName').textContent = planetName;

            // 填充基础数据
            document.getElementById('planetVersion').value = planetData.version;
            document.getElementById('planetRadius').value = planetData.BASE_DATA.radius;
            document.getElementById('planetGravity').value = planetData.BASE_DATA.gravity;
            document.getElementById('timewarpHeight').value = planetData.BASE_DATA.timewarpHeight;
            document.getElementById('velocityArrowsHeight').value = planetData.BASE_DATA.velocityArrowsHeight;
            
            // 设置地图颜色
            const color = planetData.BASE_DATA.mapColor;
            const hexColor = rgbaToHex(color.r, color.g, color.b);
            document.getElementById('mapColor').value = hexColor;
            document.getElementById('mapColorAlpha').value = color.a;
            
            document.getElementById('significant').checked = planetData.BASE_DATA.significant;
            document.getElementById('rotateCamera').checked = planetData.BASE_DATA.rotateCamera;

            // 设置成就数据
            document.getElementById('achieveLanded').checked = planetData.ACHIEVEMENT_DATA.Landed;
            document.getElementById('achieveTakeoff').checked = planetData.ACHIEVEMENT_DATA.Takeoff;
            document.getElementById('achieveAtmosphere').checked = planetData.ACHIEVEMENT_DATA.Atmosphere;
            document.getElementById('achieveOrbit').checked = planetData.ACHIEVEMENT_DATA.Orbit;
            document.getElementById('achieveCrash').checked = planetData.ACHIEVEMENT_DATA.Crash;

            // 清空并更新模块状态
            document.getElementById('moduleContent').innerHTML = '';
            updateModuleButtons(planetData);

            // 初始化地标列表
            initializeLandmarks();
        }

        // 修改 updateModuleButtons 函数
        async function updateModuleButtons(planetData) {
            // 清空所有模块容器
            document.getElementById('moduleContent').innerHTML = '';
            
            // 更新按钮状态
            const btnPhysics = document.getElementById('btnAtmospherePhysics');
            const btnVisuals = document.getElementById('btnAtmosphereVisuals');
            const btnTerrain = document.getElementById('btnTerrain');
            const btnOrbit = document.getElementById('btnOrbit');
            const btnPostProcessing = document.getElementById('btnPostProcessing');

            // 设置按钮状态
            btnPhysics.classList.toggle('active', !!planetData.ATMOSPHERE_PHYSICS_DATA);
            btnVisuals.classList.toggle('active', !!planetData.ATMOSPHERE_VISUALS_DATA);
            btnTerrain.classList.toggle('active', !!planetData.TERRAIN_DATA);
            btnOrbit.classList.toggle('active', !!planetData.ORBIT_DATA);
            btnPostProcessing.classList.toggle('active', !!planetData.POST_PROCESSING);

            // 显示所有激活的模块编辑界面
            if (btnPhysics.classList.contains('active')) {
                await showModuleEditor('atmospherePhysics');
            }
            if (btnVisuals.classList.contains('active')) {
                await showModuleEditor('atmosphereVisuals');
            }
            if (btnTerrain.classList.contains('active')) {
                await showModuleEditor('terrain');
            }
            if (btnOrbit.classList.contains('active')) {
                await showModuleEditor('orbit');
            }
            if (btnPostProcessing.classList.contains('active')) {
                await showModuleEditor('postProcessing');
            }
        }

        // 修改 toggleModule 函数
        async function toggleModule(moduleName) {
            if (!currentPlanetData) return;
            
            const btn = document.getElementById('btn' + moduleName.charAt(0).toUpperCase() + moduleName.slice(1));
            const moduleContainer = document.getElementById(`${moduleName}Container`);
            
            if (btn.classList.contains('active')) {
                // 只移除当前模块
                btn.classList.remove('active');
                if (moduleContainer) {
                    moduleContainer.remove();
                }
                
                // 只删除对应的数据
                switch(moduleName) {
                    case 'atmospherePhysics':
                        delete currentPlanetData.ATMOSPHERE_PHYSICS_DATA;
                        break;
                    case 'atmosphereVisuals':
                        delete currentPlanetData.ATMOSPHERE_VISUALS_DATA;
                        break;
                    case 'terrain':
                        delete currentPlanetData.TERRAIN_DATA;
                        break;
                    case 'orbit':
                        delete currentPlanetData.ORBIT_DATA;
                        break;
                    case 'postProcessing':
                        delete currentPlanetData.POST_PROCESSING;
                        break;
                }
            } else {
                // 添加模块
                btn.classList.add('active');
                
                switch(moduleName) {
                    case 'atmospherePhysics':
                        currentPlanetData.ATMOSPHERE_PHYSICS_DATA = {
                            height: 30000.0,
                            density: 0.005,
                            curve: 10.0,
                            curveScale: {},
                            parachuteMultiplier: 1.0,
                            upperAtmosphere: 0.333,
                            heightDifficultyScale: {},
                            shockwaveIntensity: 1.0,
                            minHeatingVelocityMultiplier: 1.0
                        };
                        break;
                    case 'atmosphereVisuals':
                        currentPlanetData.ATMOSPHERE_VISUALS_DATA = {
                            GRADIENT: {
                                positionZ: 4000,
                                height: 45000.0,
                                texture: "Atmo_Default"
                            },
                            CLOUDS: {
                                texture: "None",
                                startHeight: 1200.0,
                                width: 40000.0,
                                height: 36000.0,
                                alpha: 0.1,
                                velocity: 2.0
                            },
                            FOG: {
                                keys: []
                            }
                        };
                        break;
                    case 'terrain':
                        currentPlanetData.TERRAIN_DATA = {
                            TERRAIN_TEXTURE_DATA: {
                                planetTexture: "Earth",
                                planetTextureCutout: 1.0,
                                surfaceTexture_A: "Blured",
                                surfaceTextureSize_A: {
                                    x: 20.0,
                                    y: 8.0
                                },
                                surfaceTexture_B: "None",
                                surfaceTextureSize_B: {
                                    x: -1.0,
                                    y: -1.0
                                },
                                terrainTexture_C: "Blured",
                                terrainTextureSize_C: {
                                    x: 100.0,
                                    y: 30.0
                                },
                                surfaceLayerSize: 40.0,
                                minFade: 0.0,
                                maxFade: 1.0,
                                shadowIntensity: 6.0,
                                shadowHeight: 15.0
                            },
                            terrainFormulaDifficulties: {},
                            textureFormula: [],
                            verticeSize: 4.0,
                            collider: true,
                            flatZones: [],
                            rocks: {}
                        };
                        break;
                    // ... 其他模块的默认数据
                }
                
                // 显示相应的编辑界面
                await showModuleEditor(moduleName);
            }
        }

        // 添加模块顺序定义
        const MODULE_ORDER = [
            'atmospherePhysics',
            'atmosphereVisuals',
            'terrain',
            'orbit',
            'postProcessing'
        ];

        // 修改 showModuleEditor 函数开头的容器创建部分


        // 添加雾效果关键帧列表管理
        function updateFogKeysList(fogKeys) {
            const container = document.getElementById('fogKeysList');
            container.innerHTML = '';

            fogKeys.forEach((key, index) => {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'fog-key';
                keyDiv.innerHTML = `
                    <h6>关��帧 ${index + 1}</h6>
                    <div class="form-group">
                        <label>颜色：</label>
                        <input type="color" 
                               value="${rgbaToHex(key.color.r, key.color.g, key.color.b)}"
                               onchange="updateFogKeyColor(${index}, this.value)">
                        <input type="range" 
                               min="0" max="1" step="0.01" 
                               value="${key.color.a}"
                               onchange="updateFogKeyAlpha(${index}, this.value)">
                    </div>
                    <div class="form-group">
                        <label>距离：</label>
                        <input type="number" 
                               value="${key.distance}"
                               onchange="updateFogKeyDistance(${index}, this.value)">
                    </div>
                    <button onclick="removeFogKey(${index})">删除</button>
                `;
                container.appendChild(keyDiv);
            });
        }

        // 添加新的雾效果关键帧
        function addFogKey() {
            if (!currentPlanetData.ATMOSPHERE_VISUALS_DATA) {
                currentPlanetData.ATMOSPHERE_VISUALS_DATA = {
                    FOG: { keys: [] }
                };
            }
            
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys.push({
                color: { r: 0.5, g: 0.5, b: 0.5, a: 0.5 },
                distance: 1000.0
            });
            
            updateFogKeysList(currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys);
        }

        // 更新雾效果关键帧的颜色
        function updateFogKeyColor(index, hexColor) {
            const keys = currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys;
            const rgb = hexToRgb(hexColor);
            keys[index].color.r = rgb.r;
            keys[index].color.g = rgb.g;
            keys[index].color.b = rgb.b;
        }

        // 更新雾效果关键帧的透明度
        function updateFogKeyAlpha(index, alpha) {
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys[index].color.a = parseFloat(alpha);
        }

        // 更新雾效果关键帧的距离
        function updateFogKeyDistance(index, distance) {
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys[index].distance = parseFloat(distance);
        }

        // 删除雾效果关键帧
        function removeFogKey(index) {
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys.splice(index, 1);
            updateFogKeysList(currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys);
        }

        // RGBA转十六进制颜色
        function rgbaToHex(r, g, b) {
            const toHex = (n) => {
                const hex = Math.round(n * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        // 保存星球数据
        async function savePlanet() {
            if (!currentPlanetData || !currentDirHandle) return;

            // 获取当前编辑的星球名称
            const planetName = document.getElementById('editingPlanetName').textContent;
            try {
                // 更新基础数据
                currentPlanetData.version = document.getElementById('planetVersion').value;
                currentPlanetData.BASE_DATA = {
                    radius: parseFloat(document.getElementById('planetRadius').value),
                    gravity: parseFloat(document.getElementById('planetGravity').value),
                    timewarpHeight: parseFloat(document.getElementById('timewarpHeight').value),
                    velocityArrowsHeight: parseFloat(document.getElementById('velocityArrowsHeight').value),
                    mapColor: {
                        r: parseInt(document.getElementById('mapColor').value.substr(1,2), 16) / 255,
                        g: parseInt(document.getElementById('mapColor').value.substr(3,2), 16) / 255,
                        b: parseInt(document.getElementById('mapColor').value.substr(5,2), 16) / 255,
                        a: parseFloat(document.getElementById('mapColorAlpha').value)
                    },
                    significant: document.getElementById('significant').checked,
                    rotateCamera: document.getElementById('rotateCamera').checked
                };
                // 更新大气层物理数据
                if (document.getElementById('btnAtmospherePhysics').classList.contains('active')) {
                    currentPlanetData.ATMOSPHERE_PHYSICS_DATA = {
                        height: parseFloat(document.getElementById('atmoHeight').value),
                        density: parseFloat(document.getElementById('atmoDensity').value),
                        curve: parseFloat(document.getElementById('atmoCurve').value),
                        parachuteMultiplier: parseFloat(document.getElementById('atmoParachuteMultiplier').value),
                        upperAtmosphere: parseFloat(document.getElementById('atmoUpperAtmosphere').value),
                        shockwaveIntensity: parseFloat(document.getElementById('atmoShockwaveIntensity').value),
                        minHeatingVelocityMultiplier: parseFloat(document.getElementById('atmoMinHeatingVelocityMultiplier').value)
                    };
                }
                // 更新大气层视觉数据
                if (document.getElementById('btnAtmosphereVisuals').classList.contains('active')) {
                    currentPlanetData.ATMOSPHERE_VISUALS_DATA = {
                        GRADIENT: {
                            positionZ: parseFloat(document.getElementById('atmoGradientPositionZ').value),
                            height: parseFloat(document.getElementById('atmoGradientHeight').value),
                            texture: document.getElementById('atmoGradientTexture').value
                        },
                        CLOUDS: {
                            texture: document.getElementById('atmoCloudTexture').value,
                            startHeight: parseFloat(document.getElementById('atmoCloudStartHeight').value),
                            width: parseFloat(document.getElementById('atmoCloudWidth').value),
                            height: parseFloat(document.getElementById('atmoCloudHeight').value),
                            alpha: parseFloat(document.getElementById('atmoCloudAlpha').value),
                            velocity: parseFloat(document.getElementById('atmoCloudVelocity').value)
                        },
                        FOG: {
                            keys: currentPlanetData.ATMOSPHERE_VISUALS_DATA?.FOG?.keys || []
                        }
                    };
                }
                // 更新地形数据
                if (document.getElementById('btnTerrain').classList.contains('active')) {
                    currentPlanetData.TERRAIN_DATA = {
                        TERRAIN_TEXTURE_DATA: {
                            planetTexture: document.getElementById('planetTexture').value,
                            planetTextureCutout: parseFloat(document.getElementById('planetTextureCutout').value),
                            surfaceTexture_A: document.getElementById('surfaceTexture_A').value,
                            surfaceTextureSize_A: {
                                x: parseFloat(document.getElementById('surfaceTextureSize_A_x').value),
                                y: parseFloat(document.getElementById('surfaceTextureSize_A_y').value)
                            },
                            surfaceTexture_B: document.getElementById('surfaceTexture_B').value,
                            surfaceTextureSize_B: {
                                x: parseFloat(document.getElementById('surfaceTextureSize_B_x').value),
                                y: parseFloat(document.getElementById('surfaceTextureSize_B_y').value)
                            },
                            terrainTexture_C: document.getElementById('terrainTexture_C').value,
                            terrainTextureSize_C: {
                                x: parseFloat(document.getElementById('terrainTextureSize_C_x').value),
                                y: parseFloat(document.getElementById('terrainTextureSize_C_y').value)
                            },
                            surfaceLayerSize: parseFloat(document.getElementById('surfaceLayerSize').value),
                            minFade: parseFloat(document.getElementById('minFade').value),
                            maxFade: parseFloat(document.getElementById('maxFade').value),
                            shadowIntensity: parseFloat(document.getElementById('shadowIntensity').value),
                            shadowHeight: parseFloat(document.getElementById('shadowHeight').value)
                        },
                        terrainFormulaDifficulties: currentPlanetData.TERRAIN_DATA?.terrainFormulaDifficulties || {},
                        textureFormula: currentPlanetData.TERRAIN_DATA?.textureFormula || [],
                        verticeSize: parseFloat(document.getElementById('verticeSize').value),
                        collider: document.getElementById('terrainCollider').checked,
                        flatZones: currentPlanetData.TERRAIN_DATA?.flatZones || [],
                        rocks: currentPlanetData.TERRAIN_DATA?.rocks || {}
                    };
                }

                // 更新成就数据
                currentPlanetData.ACHIEVEMENT_DATA = {
                    Landed: document.getElementById('achieveLanded').checked,
                    Takeoff: document.getElementById('achieveTakeoff').checked,
                    Atmosphere: document.getElementById('achieveAtmosphere').checked,
                    Orbit: document.getElementById('achieveOrbit').checked,
                    Crash: document.getElementById('achieveCrash').checked
                };
                // 更新地标数据
                const landmarksList = document.getElementById('landmarksList');
                const landmarks = [];
                landmarksList.querySelectorAll('.landmark-item').forEach(item => {
                    landmarks.push({
                        name: item.querySelector('input[type="text"]').value,
                        angle: parseFloat(item.querySelector('input[type="number"]').value)
                    });
                });
                currentPlanetData.LANDMARKS = landmarks;
                // 更新轨道数据
                if (document.getElementById('btnOrbit').classList.contains('active')) {
                    currentPlanetData.ORBIT_DATA = {
                        parent: document.getElementById('parent').value,
                        semiMajorAxis: parseFloat(document.getElementById('semiMajorAxis').value),
                        eccentricity: parseFloat(document.getElementById('eccentricity').value),
                        argumentOfPeriapsis: parseFloat(document.getElementById('argumentOfPeriapsis').value),
                        direction: parseFloat(document.getElementById('direction').value),
                        multiplierSOI: parseFloat(document.getElementById('multiplierSOI').value)
                    };
                }

                // 更新后期处理数据
                if (document.getElementById('btnPostProcessing').classList.contains('active')) {
                    currentPlanetData.POST_PROCESSING = {
                        keys: []
                    };

                    // 获取所有关键帧编辑器
                    const keyframeEditors = document.querySelectorAll('.keyframe-editor');
                    keyframeEditors.forEach(editor => {
                        const inputs = editor.querySelectorAll('input[type="number"]');
                        const keyframe = {
                            height: parseFloat(inputs[0].value),
                            shadowIntensity: parseFloat(inputs[1].value), 
                            starIntensity: parseFloat(inputs[2].value),
                            hueShift: parseFloat(inputs[3].value),
                            saturation: parseFloat(inputs[4].value),
                            contrast: parseFloat(inputs[5].value),
                            red: parseFloat(inputs[6].value),
                            green: parseFloat(inputs[7].value),
                            blue: parseFloat(inputs[8].value)
                        };
                        currentPlanetData.POST_PROCESSING.keys.push(keyframe);
                    });

                    // 按高度排序
                    currentPlanetData.POST_PROCESSING.keys.sort((a, b) => a.height - b.height);
                }

                // 保存到文件
                const planetDataDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                await savePlanetToFile(planetDataDir, planetName, currentPlanetData);
                alert('星球数据已保存成功！');

            } catch (err) {
                console.error('保存星球失败:', err);
                alert('保存星球失败!错误信息: ' + err.message);
            }
        }

        // 十六进制颜色转RGBA
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return { r, g, b, a: alpha };
        }

        // 添加这个函数来加载所有星球
        async function loadPlanets(dirHandle) {
            try {
                const planetDataDir = await dirHandle.getDirectoryHandle('Planet Data');
                // 清空现有列表
                document.getElementById('planetsList').innerHTML = '';
                
                // 遍历Planet Data目录下的所有文件
                for await (const entry of planetDataDir.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                        const file = await entry.getFile();
                        const content = await file.text();
                        const planetData = JSON.parse(content);
                        const planetName = entry.name.replace('.txt', '');
                        addPlanetToList(planetName, planetData);
                    }
                }
            } catch (err) {
                console.error('加载星球列表失败:', err);
            }
        }

        // 更新地形纹理数据
        function updateTerrainTexture(field, value) {
            if (!currentPlanetData?.TERRAIN_DATA?.TERRAIN_TEXTURE_DATA) return;
            
            const numValue = field.includes('Cutout') || field.includes('Fade') ? 
                parseFloat(value) : value;
            
            if (typeof numValue === 'number' && isNaN(numValue)) return;
            
            currentPlanetData.TERRAIN_DATA.TERRAIN_TEXTURE_DATA[field] = numValue;
        }

        // 更新纹理尺寸
        function updateTerrainTextureSize(type, axis, value) {
            if (!currentPlanetData?.TERRAIN_DATA?.TERRAIN_TEXTURE_DATA) return;
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return;
            
            const field = type === 'C' ? 
                `terrainTextureSize_C` : 
                `surfaceTextureSize_${type}`;
            
            currentPlanetData.TERRAIN_DATA.TERRAIN_TEXTURE_DATA[field][axis] = numValue;
        }

        // 更新地形数据
        function updateTerrainData(field, value) {
            if (!currentPlanetData?.TERRAIN_DATA) return;
            
            if (field === 'collider') {
                currentPlanetData.TERRAIN_DATA[field] = value;
            } else {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    currentPlanetData.TERRAIN_DATA[field] = numValue;
                }
            }}

        // 更新公式列表显示
        function updateFormulaList(difficulty, formulas) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            formulas.forEach((formula, index) => {
                const formulaDiv = document.createElement('div');
                formulaDiv.className = 'formula-item';
                formulaDiv.innerHTML = `
                    <input type="text" value="${formula}" 
                           onchange="updateFormula('${difficulty}', ${index}, this.value)">
                    <button onclick="removeFormula('${difficulty}', ${index})">删除</button>
                `;
                container.appendChild(formulaDiv);
            });
        }

        // 添加新公式
        function addTerrainFormula(difficulty) {
            if (!currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties = {};
            }
            
            if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = [];
            }
            
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].push(
                "OUTPUT = AddHeightMap(Perlin,1000, 10)"
            );
            
            updateFormulaList(
                difficulty, 
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]
            );
        }

        // 更新公式
        function updateFormula(difficulty, index, value) {
            if (!currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties?.[difficulty]) return;
            
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty][index] = value;
        }

        // 删除公式
        function removeFormula(difficulty, index) {
            if (!currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties?.[difficulty]) return;
            
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].splice(index, 1);
            updateFormulaList(
                difficulty, 
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]
            );
        }

        // 添加新的CSS样式
        const additionalStyle = document.createElement('style');
        additionalStyle.textContent = `
            .formula-editor {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
            }

            .formula-editor select,
            .formula-editor input {
                padding: 5px;
                border: 1px solid #ced4da;
                border-radius: 4px;
            }

            .formula-editor .heightmap-select {
                width: 150px;
            }

            .formula-editor .scale-input,
            .formula-editor .height-input {
                width: 100px;
            }

            .formula-editor .curve-select {
                width: 120px;
            }

            .flat-zone-editor {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .flat-zone-editor input {
                width: 100px;
            }

            #flatZonesList,
            #textureFormulas {
                margin-top: 10px;
            }

            .formula-item,
            .flat-zone-item {
                display: flex;
                gap: 10px;
                align-items: center;
                margin-bottom: 5px;
                padding: 5px;
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 4px;
            }

            .formula-item button,
            .flat-zone-item button {
                padding: 2px 8px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }
        `;

        document.head.appendChild(additionalStyle);

        // 添加数据处理函数
        function updateFormulaList(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] || [];
            formulas.forEach((formula, index) => {
                const item = document.createElement('div');
                item.className = 'formula-item';
                item.innerHTML = `
                    <span>${formula}</span>
                    <button onclick="removeFormula('${difficulty}', ${index})">删除</button>
                `;
                container.appendChild(item);
            });
        }

        function removeFormula(difficulty, index) {
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].splice(index, 1);
            updateFormulaList(difficulty);
        }

        function updateTextureFormulaList() {
            const container = document.getElementById('textureFormulas');
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.textureFormula || [];
            formulas.forEach((formula, index) => {
                const item = document.createElement('div');
                item.className = 'formula-item';
                item.innerHTML = `
                    <span>${formula}</span>
                    <button onclick="removeTextureFormula(${index})">删除</button>
                `;
                container.appendChild(item);
            });
        }

        function removeTextureFormula(index) {
            currentPlanetData.TERRAIN_DATA.textureFormula.splice(index, 1);
            updateTextureFormulaList();
        }

        function updateFlatZonesList() {
            const container = document.getElementById('flatZonesList');
            container.innerHTML = '';
            
            currentPlanetData.TERRAIN_DATA.flatZones.forEach((zone, index) => {
                const item = document.createElement('div');
                item.className = 'flat-zone-item';
                item.innerHTML = `
                    <span>高度: ${zone.height}, 角度: ${zone.angle}, 宽度: ${zone.width}, 过渡: ${zone.transition}</span>
                    <button onclick="removeFlatZone(${index})">删除</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFlatZone(index) {
            currentPlanetData.TERRAIN_DATA.flatZones.splice(index, 1);
            updateFlatZonesList();
        }

        function updateRocksForm() {
            const rocks = currentPlanetData.TERRAIN_DATA.rocks;
            if (!rocks) return;

            document.getElementById('rockType').value = rocks.rockType;
            document.getElementById('rockDensity').value = rocks.rockDensity;
            document.getElementById('rockMinSize').value = rocks.minSize;
            document.getElementById('rockMaxSize').value = rocks.maxSize;
            document.getElementById('rockPowerCurve').value = rocks.powerCurve;
            document.getElementById('rockMaxAngle').value = rocks.maxAngle;
        }

        // 添加岩石设置的更新函数
        function updateRockSetting(field, value) {
            if (!currentPlanetData.TERRAIN_DATA.rocks) return;
            
            if (field === 'rockType') {
                currentPlanetData.TERRAIN_DATA.rocks[field] = value;
            } else {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    currentPlanetData.TERRAIN_DATA.rocks[field] = numValue;
                }
            }
        }

        // 修改 showModuleEditor 函数中的数据加载部分
        if (currentPlanetData.TERRAIN_DATA) {
            const terrainData = currentPlanetData.TERRAIN_DATA;
            
            // ... 之前的纹理数据加载代码 ...

            // 加载地形公式
            Object.keys(terrainData.terrainFormulaDifficulties || {}).forEach(difficulty => {
                updateFormulaList(difficulty);
            });

            // 加载纹理公式
            if (terrainData.textureFormula) {
                updateTextureFormulaList();
            }

            // 加载平坦区域
            if (terrainData.flatZones && terrainData.flatZones.length > 0) {
                document.getElementById('flatZonesContainer').style.display = 'block';
                updateFlatZonesList();
            }

            // 加载岩石设置
            if (terrainData.rocks) {
                document.getElementById('rocksContainer').style.display = 'block';
                updateRocksForm();
            }
        }

        // 添加事件监听器
        function addEventListeners() {
            // 岩石设置的事件监听器
            document.getElementById('rockType')?.addEventListener('change', e => 
                updateRockSetting('rockType', e.target.value));
            document.getElementById('rockDensity')?.addEventListener('input', e => 
                updateRockSetting('rockDensity', e.target.value));
            document.getElementById('rockMinSize')?.addEventListener('input', e => 
                updateRockSetting('minSize', e.target.value));
            document.getElementById('rockMaxSize')?.addEventListener('input', e => 
                updateRockSetting('maxSize', e.target.value));
            document.getElementById('rockPowerCurve')?.addEventListener('input', e => 
                updateRockSetting('powerCurve', e.target.value));
            document.getElementById('rockMaxAngle')?.addEventListener('input', e => 
                updateRockSetting('maxAngle', e.target.value));
        }

        // 在showModuleEditor函数末尾调���
        addEventListeners();

        // 修改公式添加函数
        function addFormula(difficulty) {
            const container = document.querySelector(`#${difficulty.toLowerCase()}Formulas`).previousElementSibling;
            const outputType = container.querySelector('.output-type').value;
            const heightmap = container.querySelector('.heightmap-select').value;
            const scale = parseFloat(container.querySelector('.scale-input').value);
            const height = parseFloat(container.querySelector('.height-input').value);
            const mask = container.querySelector('.mask-select').value;
            const curve = container.querySelector('.curve-select').value;

            // 格式化数字，保持精确度
            const formattedScale = scale.toString().includes('e') ? 
                scale.toFixed(9) : scale.toString();

            // 构建公式字符串
            let formula = `${outputType} = AddHeightMap( ${heightmap}, ${formattedScale}, ${height}`;
            if (curve) formula += `, ${curve}`;
            if (mask) formula += `, ${mask}`;
            formula += ')';

            if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = [];
            }
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].push(formula);
            updateFormulaList(difficulty);
        }

        // 修改公式列表更新函数
        function updateFormulaList(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] || [];
            formulas.forEach((formula, index) => {
                const item = document.createElement('div');
                item.className = 'formula-item';
                
                // 解析公式以便编辑
                const parsed = parseFormula(formula);
                
                item.innerHTML = `
                    <div class="formula-display">${formula}</div>
                    <div class="formula-controls">
                        <button onclick="editFormula('${difficulty}', ${index})">编辑</button>
                        <button onclick="moveFormula('${difficulty}', ${index}, -1)">↑</button>
                        <button onclick="moveFormula('${difficulty}', ${index}, 1)">↓</button>
                        <button onclick="removeFormula('${difficulty}', ${index})">删除</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 添加公式解析函数
        function parseFormula(formula) {
            try {
                // 匹配格式: OUTPUT = AddHeightMap( Phobos, 6283.18530718, 300, Curve4, M)
                const parts = formula.trim().split('=');
                const outputType = parts[0].trim();
                
                // 解析 AddHeightMap 的参数
                const params = parts[1].match(/AddHeightMap\(\s*([^,]+),\s*([^,]+),\s*([^,\)]+)(?:,\s*([^,\)]+))?(?:,\s*([^,\)]+))?\)/);
                
                if (params) {
                    return {
                        outputType: outputType,
                        heightmap: params[1].trim(),
                        scale: params[2].trim(),
                        height: params[3].trim(),
                        curve: params[4]?.trim() || '',
                        mask: params[5]?.trim() || ''
                    };
                }
            } catch (e) {
                console.error('公式解析错误:', e);
            }
            
            // 默认值
            return {
                outputType: 'OUTPUT',
                heightmap: 'Perlin',
                scale: '6283.18530718',
                height: '1',
                curve: '',
                mask: ''
            };
        }

        // 添加公式编辑函数
        function editFormula(difficulty, index) {
            const formula = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty][index];
            const parsed = parseFormula(formula);
            if (!parsed) return;

            const editor = document.querySelector(`#${difficulty.toLowerCase()}Formulas`).previousElementSibling;
            editor.querySelector('.output-type').value = parsed.outputType;
            editor.querySelector('.heightmap-select').value = parsed.heightmap;
            editor.querySelector('.scale-input').value = parsed.scale;
            editor.querySelector('.height-input').value = parsed.height;
            editor.querySelector('.curve-select').value = parsed.curve;
            editor.querySelector('.mask-select').value = parsed.mask;

            // 删除原公式
            removeFormula(difficulty, index);
        }

        // 添加公式移动函数
        function moveFormula(difficulty, index, direction) {
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty];
            if (index + direction >= 0 && index + direction < formulas.length) {
                const temp = formulas[index];
                formulas[index] = formulas[index + direction];
                formulas[index + direction] = temp;
                updateFormulaList(difficulty);
            }
        }

        // 添加相应的CSS样式
        const formulaStyle = document.createElement('style');
        formulaStyle.textContent = `
            .formula-editor {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 10px;
            }

            .formula-inputs {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .formula-type-select {
                margin-bottom: 10px;
            }

            .formula-item {
                background: white;
                padding: 10px;
                margin-bottom: 5px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .formula-display {
                font-family: monospace;
                white-space: pre;
            }

            .formula-controls {
                display: flex;
                gap: 5px;
            }

            .formula-controls button {
                padding: 2px 8px;
                font-size: 12px;
            }
        `;

        document.head.appendChild(formulaStyle);

        // 修改公式添加函数
        function createFormulaEditor(formula = null) {
            const editor = document.createElement('div');
            editor.className = 'formula-editor';
            
            const parsed = parseFormula(formula || '');

            // 使用已有的 heightmaps 数组生成选项
            const heightmapOptions = heightmaps.map(name => 
                `<option value="${name}" ${parsed.heightmap === name ? 'selected' : ''}>${name}</option>`
            ).join('');

            editor.innerHTML = `
                <select class="output-type">
                    <option value="OUTPUT" ${parsed.outputType === 'OUTPUT' ? 'selected' : ''}>OUTPUT</option>
                    <option value="M" ${parsed.outputType === 'M' ? 'selected' : ''}>M</option>
                </select>
                =
                AddHeightMap(
                <select class="heightmap-select">
                    ${heightmapOptions}
                </select>
                ,
                <input type="number" class="scale-input" value="${parsed.scale}" step="0.00000001">
                ,
                <input type="number" class="height-input" value="${parsed.height}" step="0.1">
                ,
                <select class="curve-select">
                    <option value="" ${!parsed.curve ? 'selected' : ''}>无曲线</option>
                    ${Array.from({length: 7}, (_, i) => i + 1).map(num => 
                        `<option value="Curve${num}" ${parsed.curve === `Curve${num}` ? 'selected' : ''}>Curve${num}</option>`
                    ).join('')}
                    <option value="null" ${parsed.curve === 'null' ? 'selected' : ''}>null</option>
                </select>
                ,
                <select class="mask-select">
                    <option value="" ${!parsed.mask ? 'selected' : ''}>无遮罩</option>
                    <option value="M" ${parsed.mask === 'M' ? 'selected' : ''}>M</option>
                    <option value="null" ${parsed.mask === 'null' ? 'selected' : ''}>null</option>
                </select>
                )
                <button class="delete-formula">×</button>
            `;

            // 添加删除事件监听
            editor.querySelector('.delete-formula').onclick = () => {
                editor.remove();
                updateFormulas();
            };

            // 添加更改事件监听
            editor.querySelectorAll('select, input').forEach(element => {
                element.onchange = updateFormulas;
            });

            return editor;
        }

        // 更新公式列表的函数
        function updateFormulas() {
            // 更新地形公式
            ['Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
                if (container) {
                    const formulas = Array.from(container.querySelectorAll('.formula-editor')).map(editor => {
                        const outputType = editor.querySelector('.output-type').value;
                        const heightmap = editor.querySelector('.heightmap-select').value;
                        const scale = editor.querySelector('.scale-input').value;
                        const height = editor.querySelector('.height-input').value;
                        const curve = editor.querySelector('.curve-select').value;
                        const mask = editor.querySelector('.mask-select').value;

                        let formula = `${outputType} = AddHeightMap( ${heightmap}, ${scale}, ${height}`;
                        if (curve) formula += `, ${curve}`;
                        if (mask) formula += `, ${mask}`;
                        formula += ')';

                        return formula;
                    });

                    if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties) {
                        currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties = {};
                    }
                    currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = formulas;
                }
            });

            // 更新纹理公式
            const textureContainer = document.getElementById('textureFormulas');
            if (textureContainer) {
                const formulas = Array.from(textureContainer.querySelectorAll('.formula-editor')).map(editor => {
                    // 使用相同的公式构建逻辑
                    const outputType = editor.querySelector('.output-type').value;
                    const heightmap = editor.querySelector('.heightmap-select').value;
                    const scale = editor.querySelector('.scale-input').value;
                    const height = editor.querySelector('.height-input').value;
                    const curve = editor.querySelector('.curve-select').value;
                    const mask = editor.querySelector('.mask-select').value;

                    let formula = `${outputType} = AddHeightMap( ${heightmap}, ${scale}, ${height}`;
                    if (curve) formula += `, ${curve}`;
                    if (mask) formula += `, ${mask}`;
                    formula += ')';

                    return formula;
                });
                currentPlanetData.TERRAIN_DATA.textureFormula = formulas;
            }
        }

        function updateTextureFormulaList() {
            const container = document.getElementById('textureFormulas');
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.textureFormula || [];
            formulas.forEach(formula => {
                container.appendChild(createFormulaEditor(formula));
            });
        }

        function addFormulaEditor(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.appendChild(createFormulaEditor());
        }

        function addTextureFormulaEditor() {
            const container = document.getElementById('textureFormulas');
            container.appendChild(createFormulaEditor());
        }

        // 修改平坦区域和岩石设��的切换函数
        function toggleFlatZones() {
            const container = document.getElementById('flatZonesContainer');
            const button = document.getElementById('toggleFlatZonesBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = '禁用平坦区域';
                if (!currentPlanetData.TERRAIN_DATA.flatZones) {
                    currentPlanetData.TERRAIN_DATA.flatZones = [];
                }
            } else {
                container.style.display = 'none';
                button.textContent = '启用平坦区域';
                currentPlanetData.TERRAIN_DATA.flatZones = [];
            }
            updateFlatZonesList();
        }

        function toggleRocks() {
            const container = document.getElementById('rocksContainer');
            const button = document.getElementById('toggleRocksBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = '禁用岩石';
                if (!currentPlanetData.TERRAIN_DATA.rocks) {
                    currentPlanetData.TERRAIN_DATA.rocks = {
                        rockType: 'Rock Square',
                        rockDensity: 0.5,
                        minSize: 1,
                        maxSize: 2,
                        powerCurve: 1,
                        maxAngle: 45
                    };
                }
                updateRocksForm();
            } else {
                container.style.display = 'none';
                button.textContent = '启用岩石';
                delete currentPlanetData.TERRAIN_DATA.rocks;
            }
        }

        // 修改公式更新函数
        function updateFormulaFromEditor(button) {
            const editor = button.parentElement;
            const outputType = editor.querySelector('.output-type').value;
            const heightmap = editor.querySelector('.heightmap-select').value;
            const scale = editor.querySelector('.scale-input').value;
            const height = editor.querySelector('.height-input').value;
            const curve = editor.querySelector('.curve-select').value;
            const mask = editor.querySelector('.mask-select').value;

            let formula = `${outputType} = ${heightmap}(${scale})`;
            if (height) formula += ` * ${height}`;
            if (curve) formula += ` * ${curve}`;
            if (mask) formula += ` * ${mask}`;

            // 更新公式列表
            updateFormulas();
        }

        async function getPlanetsList() {
            let planets = []; // 默认包含太阳
            
            // 获取拓展包文件夹中的星球列表
            if (extensionDirHandle) {
                try {
                    const planetDir = await extensionDirHandle.getDirectoryHandle('Planet Data');
                    for await (const entry of planetDir.values()) {
                        if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                            planets.push(entry.name.replace('.txt', ''));
                        }
                    }
                } catch (err) {
                    console.error('读取拓展包星球目录失败:', err);
                }
            }
            
            // 从当前目录获取星球列表（如果需要的话）
            if (currentDirHandle) {
                try {
                    const planetDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                    for await (const entry of planetDir.values()) {
                        if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                            const planetName = entry.name.replace('.txt', '');
                            // 避免重复添加
                            if (!planets.includes(planetName)) {
                                planets.push(planetName);
                            }
                        }
                    }
                } catch (err) {
                    console.error('读取当前星球目录失败:', err);
                }
            }
            
            return planets;
        }
        // 修改后的 showModuleEditor 函数
        async function showModuleEditor(moduleName) {
            console.log(`显示模块编辑器: ${moduleName}`);
            let moduleContainer = document.getElementById(`${moduleName}Container`);
            if (!moduleContainer) {
                moduleContainer = document.createElement('div');
                moduleContainer.id = `${moduleName}Container`;
                moduleContainer.className = 'module-container';
                document.getElementById('moduleContent').appendChild(moduleContainer);
            }

            if (moduleName === 'atmospherePhysics') {
                // 创建所有元素
                const section = document.createElement('div');
                section.className = 'module-section';
                
                const title = document.createElement('h4');
                title.textContent = '大气层物理参数';
                section.appendChild(title);

                // 定义要创建的输入字段
                const fields = [
                    { id: 'atmoHeight', label: '大气层高度 (米):', step: '1000' },
                    { id: 'atmoDensity', label: '密度:', step: '0.001' },
                    { id: 'atmoCurve', label: '曲线:', step: '0.1' },
                    { id: 'atmoParachuteMultiplier', label: '降落伞系数:', step: '0.1' },
                    { id: 'atmoUpperAtmosphere', label: '上层大气:', step: '0.001' },
                    { id: 'atmoShockwaveIntensity', label: '冲击波强度:', step: '0.1' },
                    { id: 'atmoMinHeatingVelocityMultiplier', label: '最小加热速度系数:', step: '0.1' }
                ];

                // 创建每个��入字段
                fields.forEach(field => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';

                    const label = document.createElement('label');
                    label.textContent = field.label;
                    formGroup.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = field.id;
                    input.step = field.step;
                    
                    // 如果有数据，立即设置值
                    if (currentPlanetData?.ATMOSPHERE_PHYSICS_DATA) {
                        const dataKey = field.id.replace('atmo', '').charAt(0).toLowerCase() + 
                                      field.id.replace('atmo', '').slice(1);
                        input.value = currentPlanetData.ATMOSPHERE_PHYSICS_DATA[dataKey] || '';
                    }

                    // 添加事件监听器
                    input.addEventListener('input', e => {
                        const dataKey = field.id.replace('atmo', '').charAt(0).toLowerCase() + 
                                      field.id.replace('atmo', '').slice(1);
                        updatePhysicsData(dataKey, parseFloat(e.target.value));
                    });

                    formGroup.appendChild(input);
                    section.appendChild(formGroup);
                });

                // 清空容器并添加新创建的元素
                moduleContainer.innerHTML = '';
                moduleContainer.appendChild(section);
            }
            else if (moduleName === 'atmosphereVisuals') {
                // 定义可用的纹理列表
                const defaultTextures = [
                    'None', 'Atmo_Earth', 'Earth_Clouds', 'Atmo_Europa',
                    'Atmo_Jupiter', 'Atmo_Mars', 'Atmo_Sun', 'Atmo_Venus'
                ];

                // 获取自定义纹理
                let customTextures = [];
                if (currentDirHandle) {
                    try {
                        const textureDir = await currentDirHandle.getDirectoryHandle('Texture Data');
                        for await (const entry of textureDir.values()) {
                            if (entry.kind === 'file' && entry.name.match(/\.(png|jpg|jpeg)$/i)) {
                                customTextures.push(entry.name.replace(/\.[^/.]+$/, ''));
                            }
                        }
                    } catch (err) {
                        console.error('读取纹理目录失败:', err);
                    }
                }

                // 合并纹理列表
                const allTextures = [...defaultTextures, ...customTextures];

                // 创建主容器
                const section = document.createElement('div');
                section.className = 'module-section';

                // 创建标题
                const title = document.createElement('h4');
                title.textContent = '大气层视觉效果';
                section.appendChild(title);

                // 创建渐变设置组
                const gradientGroup = document.createElement('div');
                gradientGroup.className = 'form-group';
                
                const gradientTitle = document.createElement('h5');
                gradientTitle.textContent = '渐变';
                gradientGroup.appendChild(gradientTitle);

                // 创建渐变设置字段
                const gradientFields = [
                    { id: 'atmoGradientPositionZ', label: '位置 Z:', type: 'number', step: '0.1' },
                    { id: 'atmoGradientHeight', label: '高度:', type: 'number', step: '0.1' },
                    { id: 'atmoGradientTexture', label: '纹理:', type: 'select', options: allTextures }
                ];

                gradientFields.forEach(field => {
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    gradientGroup.appendChild(label);

                    if (field.type === 'select') {
                        const select = document.createElement('select');
                        select.id = field.id;
                        field.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            select.appendChild(opt);
                        });
                        select.addEventListener('change', e => {
                            updateVisualsData('gradient', field.id.replace('atmoGradient', '').toLowerCase(), e.target.value);
                        });
                        gradientGroup.appendChild(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = field.type;
                        input.id = field.id;
                        input.step = field.step;
                        input.addEventListener('input', e => {
                            updateVisualsData('gradient', field.id.replace('atmoGradient', '').toLowerCase(), e.target.value);
                        });
                        gradientGroup.appendChild(input);
                    }
                });

                section.appendChild(gradientGroup);

                // 创建云层设置组
                const cloudGroup = document.createElement('div');
                cloudGroup.className = 'form-group';

                const cloudTitle = document.createElement('h5');
                cloudTitle.textContent = '云层';
                cloudGroup.appendChild(cloudTitle);

                // 创建云层设置字段
                const cloudFields = [
                    { id: 'atmoCloudTexture', label: '纹理:', type: 'select', options: allTextures },
                    { id: 'atmoCloudStartHeight', label: '起始高度:', type: 'number', step: '100' },
                    { id: 'atmoCloudWidth', label: '宽度:', type: 'number', step: '100' },
                    { id: 'atmoCloudHeight', label: '高度:', type: 'number', step: '100' },
                    { id: 'atmoCloudAlpha', label: '透明度:', type: 'number', step: '0.01', min: '0', max: '1' },
                    { id: 'atmoCloudVelocity', label: '速度:', type: 'number', step: '0.1' }
                ];

                cloudFields.forEach(field => {
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    cloudGroup.appendChild(label);

                    if (field.type === 'select') {
                        const select = document.createElement('select');
                        select.id = field.id;
                        field.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            select.appendChild(opt);
                        });
                        select.addEventListener('change', e => {
                            updateVisualsData('clouds', field.id.replace('atmoCloud', '').toLowerCase(), e.target.value);
                        });
                        cloudGroup.appendChild(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = field.type;
                        input.id = field.id;
                        input.step = field.step;
                        if (field.min) input.min = field.min;
                        if (field.max) input.max = field.max;
                        input.addEventListener('input', e => {
                            updateVisualsData('clouds', field.id.replace('atmoCloud', '').toLowerCase(), e.target.value);
                        });
                        cloudGroup.appendChild(input);
                    }
                });

                section.appendChild(cloudGroup);

                // 创建雾效果设置组
                const fogGroup = document.createElement('div');
                fogGroup.className = 'form-group';

                const fogTitle = document.createElement('h5');
                fogTitle.textContent = '雾效果';
                fogGroup.appendChild(fogTitle);

                const fogKeysList = document.createElement('div');
                fogKeysList.id = 'fogKeysList';
                fogGroup.appendChild(fogKeysList);

                const addFogKeyBtn = document.createElement('button');
                addFogKeyBtn.textContent = '添加关键帧';
                addFogKeyBtn.onclick = addFogKey;
                fogGroup.appendChild(addFogKeyBtn);

                section.appendChild(fogGroup);

                // 清空容器并添加新创建的元素
                moduleContainer.innerHTML = '';
                moduleContainer.appendChild(section);

                // 设置初始值
                if (currentPlanetData?.ATMOSPHERE_VISUALS_DATA) {
                    const visualsData = currentPlanetData.ATMOSPHERE_VISUALS_DATA;
                    
                    // 设置渐变值
                    if (visualsData.GRADIENT) {
                        document.getElementById('atmoGradientPositionZ').value = visualsData.GRADIENT.positionZ;
                        document.getElementById('atmoGradientHeight').value = visualsData.GRADIENT.height;
                        document.getElementById('atmoGradientTexture').value = visualsData.GRADIENT.texture;
                    }

                    // 设置云层值
                    if (visualsData.CLOUDS) {
                        document.getElementById('atmoCloudTexture').value = visualsData.CLOUDS.texture;
                        document.getElementById('atmoCloudStartHeight').value = visualsData.CLOUDS.startHeight;
                        document.getElementById('atmoCloudWidth').value = visualsData.CLOUDS.width;
                        document.getElementById('atmoCloudHeight').value = visualsData.CLOUDS.height;
                        document.getElementById('atmoCloudAlpha').value = visualsData.CLOUDS.alpha;
                        document.getElementById('atmoCloudVelocity').value = visualsData.CLOUDS.velocity;
                    }

                    // 更新雾效果关键帧列表
                    if (visualsData.FOG?.keys) {
                        updateFogKeysList(visualsData.FOG.keys);
                    }
                }
            }
            else if (moduleName === 'terrain') {
                try {
                    // 重置 heightmaps
                    heightmaps = [];
                    
                    // 加载高度图数据
                    if (currentDirHandle) {
                        try {
                            const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                            for await (const entry of heightmapDir.values()) {
                                if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                                    heightmaps.push(entry.name.replace('.txt', ''));
                                }
                            }
                        } catch (e) {
                            console.log('No Heightmap Data directory found');
                        }
                    }

                    // 定义默认纹理列表
                    const defaultPlanetTextures = [
                        'None', 'Callisto', 'Deimos', 'Earth', 'Europa', 
                        'Ganymede', 'Io', 'Jupiter', 'Mars', 'Mercury', 
                        'Moon', 'Asteroid', 'Phobos'
                    ];

                    const defaultSurfaceTextures = [
                        'None', 'Soft_Rocks', 'Limestone', 'Hard_Rocks', 
                        'Blured', 'Ice', 'Dark_Dust', 'Dust', 'Circles'
                    ];

                    // 获取自定义纹理
                    let customTextures = [];
                    if (currentDirHandle) {
                        try {
                            const textureDir = await currentDirHandle.getDirectoryHandle('Texture Data');
                            for await (const entry of textureDir.values()) {
                                if (entry.kind === 'file' && entry.name.match(/\.(png|jpg|jpeg)$/i)) {
                                    customTextures.push(entry.name.replace(/\.[^/.]+$/, ''));
                                }
                            }
                        } catch (err) {
                            console.error('读取纹理目录失败:', err);
                        }
                    }

                    // 合并纹理列表
                    const allPlanetTextures = [...defaultPlanetTextures, ...customTextures];
                    const allSurfaceTextures = [...defaultSurfaceTextures, ...customTextures];

                    // 创建主容器
                    const container = document.createElement('div');

                    // 创建地形纹理部分
                    const textureSection = document.createElement('div');
                    textureSection.className = 'module-section';
                    
                    const textureTitle = document.createElement('h4');
                    textureTitle.textContent = '地形纹理';
                    textureSection.appendChild(textureTitle);

                    // 创建行星纹设置
                    const planetTextureGroup = document.createElement('div');
                    planetTextureGroup.className = 'form-group';
                    
                    // 行星纹理选择器
                    const planetTextureLabel = document.createElement('label');
                    planetTextureLabel.textContent = '行星纹理：';
                    const planetTextureSelect = document.createElement('select');
                    planetTextureSelect.id = 'planetTexture';
                    allPlanetTextures.forEach(texture => {
                        const option = document.createElement('option');
                        option.value = texture;
                        option.textContent = texture;
                        planetTextureSelect.appendChild(option);
                    });
                    planetTextureSelect.onchange = e => updateTerrainTexture('planetTexture', e.target.value);
                    
                    // 纹理裁剪输入
                    const cutoutLabel = document.createElement('label');
                    cutoutLabel.textContent = '纹理裁剪：';
                    const cutoutInput = document.createElement('input');
                    cutoutInput.type = 'number';
                    cutoutInput.id = 'planetTextureCutout';
                    cutoutInput.step = '0.01';
                    cutoutInput.min = '0';
                    cutoutInput.max = '1';
                    cutoutInput.oninput = e => updateTerrainTexture('planetTextureCutout', e.target.value);

                    planetTextureGroup.appendChild(planetTextureLabel);
                    planetTextureGroup.appendChild(planetTextureSelect);
                    planetTextureGroup.appendChild(cutoutLabel);
                    planetTextureGroup.appendChild(cutoutInput);
                    textureSection.appendChild(planetTextureGroup);

                    // 创建表面纹理 A/B/C 设置
                    ['A', 'B', 'C'].forEach(type => {
                        const group = document.createElement('div');
                        group.className = 'form-group';
                        
                        const title = document.createElement('h5');
                        title.textContent = type === 'C' ? '地形纹理 C' : `表面纹理 ${type}`;
                        group.appendChild(title);

                        // 纹理选择器
                        const textureSelect = document.createElement('select');
                        textureSelect.id = type === 'C' ? 'terrainTexture_C' : `surfaceTexture_${type}`;
                        allSurfaceTextures.forEach(texture => {
                            const option = document.createElement('option');
                            option.value = texture;
                            option.textContent = texture;
                            textureSelect.appendChild(option);
                        });
                        textureSelect.onchange = e => updateTerrainTexture(textureSelect.id, e.target.value);
                        group.appendChild(textureSelect);

                        // 尺寸 X/Y 输入
                        ['x', 'y'].forEach(axis => {
                            const label = document.createElement('label');
                            label.textContent = `尺寸 ${axis.toUpperCase()}：`;
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.id = type === 'C' ? `terrainTextureSize_C_${axis}` : `surfaceTextureSize_${type}_${axis}`;
                            input.step = '0.1';
                            input.oninput = e => updateTerrainTextureSize(type, axis, e.target.value);
                            group.appendChild(label);
                            group.appendChild(input);
                        });

                        textureSection.appendChild(group);
                    });

                    container.appendChild(textureSection);

                    // 创建其他纹理设置
                    const otherTextureSettings = [
                        { id: 'surfaceLayerSize', label: '表面层大小：', step: '0.1' },
                        { id: 'minFade', label: '最小淡出：', step: '0.1', min: '0', max: '1' },
                        { id: 'maxFade', label: '最大淡出：', step: '0.1', min: '0', max: '1' },
                        { id: 'shadowIntensity', label: '阴影强度：', step: '0.1' },
                        { id: 'shadowHeight', label: '阴影高度：', step: '0.1' }
                    ];

                    const otherSettingsGroup = document.createElement('div');
                    otherSettingsGroup.className = 'form-group';

                    otherTextureSettings.forEach(setting => {
                        const label = document.createElement('label');
                        label.textContent = setting.label;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.id = setting.id;
                        input.step = setting.step;
                        if (setting.min) input.min = setting.min;
                        if (setting.max) input.max = setting.max;
                        input.oninput = e => updateTerrainTexture(setting.id, e.target.value);
                        otherSettingsGroup.appendChild(label);
                        otherSettingsGroup.appendChild(input);
                    });

                    textureSection.appendChild(otherSettingsGroup);

                    // ... 继续添加地形公式、平坦区域和岩石设置部分 ...

                    // 创建地形公式部分
                    const formulaSection = document.createElement('div');
                    formulaSection.className = 'module-section';
                    
                    const formulaTitle = document.createElement('h4');
                    formulaTitle.textContent = '地形公式';
                    formulaSection.appendChild(formulaTitle);

                    // 创建不同难度的公式编��器
                    ['Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                        const difficultySection = document.createElement('div');
                        difficultySection.className = 'difficulty-section';
                        
                        const difficultyTitle = document.createElement('h5');
                        difficultyTitle.textContent = `${difficulty} 难度`;
                        difficultySection.appendChild(difficultyTitle);

                        const formulaList = document.createElement('div');
                        formulaList.id = `${difficulty.toLowerCase()}Formulas`;
                        formulaList.className = 'formula-list';
                        difficultySection.appendChild(formulaList);

                        const addButton = document.createElement('button');
                        addButton.textContent = '添加公式';
                        addButton.onclick = () => addFormulaEditor(difficulty);
                        difficultySection.appendChild(addButton);

                        formulaSection.appendChild(difficultySection);
                    });

                    container.appendChild(formulaSection);

                    // 创建纹理公式部分
                    const textureFormulaSection = document.createElement('div');
                    textureFormulaSection.className = 'module-section';
                    
                    const textureFormulaTitle = document.createElement('h4');
                    textureFormulaTitle.textContent = '纹理公式';
                    textureFormulaSection.appendChild(textureFormulaTitle);

                    const textureFormulaList = document.createElement('div');
                    textureFormulaList.id = 'textureFormulas';
                    textureFormulaList.className = 'formula-list';
                    textureFormulaSection.appendChild(textureFormulaList);

                    const addTextureFormulaBtn = document.createElement('button');
                    addTextureFormulaBtn.textContent = '添加纹理公式';
                    addTextureFormulaBtn.onclick = addTextureFormulaEditor;
                    textureFormulaSection.appendChild(addTextureFormulaBtn);

                    container.appendChild(textureFormulaSection);

                    // 创建���坦区���部分
                    const flatZoneSection = document.createElement('div');
                    flatZoneSection.className = 'module-section';
                    
                    const flatZoneTitle = document.createElement('h4');
                    flatZoneTitle.textContent = '平坦区域';
                    flatZoneSection.appendChild(flatZoneTitle);

                    const toggleFlatZonesBtn = document.createElement('button');
                    toggleFlatZonesBtn.id = 'toggleFlatZonesBtn';
                    toggleFlatZonesBtn.textContent = '启用平坦区域';
                    toggleFlatZonesBtn.onclick = toggleFlatZones;
                    flatZoneSection.appendChild(toggleFlatZonesBtn);

                    const flatZonesContainer = document.createElement('div');
                    flatZonesContainer.id = 'flatZonesContainer';
                    flatZonesContainer.style.display = 'none';

                    // 创建平坦区域编辑器
                    const flatZoneEditor = document.createElement('div');
                    flatZoneEditor.className = 'flat-zone-editor';

                    const flatZoneInputs = [
                        { placeholder: '高度', step: '0.1', class: 'height-input' },
                        { placeholder: '角度', step: '0.0001', class: 'angle-input' },
                        { placeholder: '宽度', step: '0.1', class: 'width-input' },
                        { placeholder: '过渡', step: '0.1', class: 'transition-input' }
                    ];

                    flatZoneInputs.forEach(input => {
                        const inputElem = document.createElement('input');
                        inputElem.type = 'number';
                        inputElem.placeholder = input.placeholder;
                        inputElem.step = input.step;
                        inputElem.className = input.class;
                        flatZoneEditor.appendChild(inputElem);
                    });

                    const addFlatZoneBtn = document.createElement('button');
                    addFlatZoneBtn.textContent = '添加';
                    addFlatZoneBtn.onclick = addFlatZone;
                    flatZoneEditor.appendChild(addFlatZoneBtn);

                    flatZonesContainer.appendChild(flatZoneEditor);

                    const flatZonesList = document.createElement('div');
                    flatZonesList.id = 'flatZonesList';
                    flatZonesContainer.appendChild(flatZonesList);

                    flatZoneSection.appendChild(flatZonesContainer);
                    container.appendChild(flatZoneSection);

                    // 创建岩石设置部分
                    const rocksSection = document.createElement('div');
                    rocksSection.className = 'module-section';
                    
                    const rocksTitle = document.createElement('h4');
                    rocksTitle.textContent = '岩石设置';
                    rocksSection.appendChild(rocksTitle);

                    const toggleRocksBtn = document.createElement('button');
                    toggleRocksBtn.id = 'toggleRocksBtn';
                    toggleRocksBtn.textContent = '启用岩石';
                    toggleRocksBtn.onclick = toggleRocks;
                    rocksSection.appendChild(toggleRocksBtn);

                    const rocksContainer = document.createElement('div');
                    rocksContainer.id = 'rocksContainer';
                    rocksContainer.style.display = 'none';

                    const rocksForm = document.createElement('div');
                    rocksForm.className = 'form-group';

                    // 创建岩石类型选择器
                    const rockTypeLabel = document.createElement('label');
                    rockTypeLabel.textContent = '岩石类型：';
                    const rockTypeSelect = document.createElement('select');
                    rockTypeSelect.id = 'rockType';
                    ['Rock Square', 'Rock Round'].forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type === 'Rock Square' ? '方形岩石' : '圆形岩石';
                        rockTypeSelect.appendChild(option);
                    });
                    rocksForm.appendChild(rockTypeLabel);
                    rocksForm.appendChild(rockTypeSelect);

                    // 创建其他岩石设置
                    const rockSettings = [
                        { id: 'rockDensity', label: '密度：', step: '0.1', min: '0', max: '1' },
                        { id: 'rockMinSize', label: '最小尺寸：', step: '0.01', min: '0' },
                        { id: 'rockMaxSize', label: '最大尺寸：', step: '0.01', min: '0' },
                        { id: 'rockPowerCurve', label: '幂曲线：', step: '0.1' },
                        { id: 'rockMaxAngle', label: '最大角度：', step: '1', min: '0', max: '90' }
                    ];

                    rockSettings.forEach(setting => {
                        const label = document.createElement('label');
                        label.textContent = setting.label;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.id = setting.id;
                        input.step = setting.step;
                        if (setting.min) input.min = setting.min;
                        if (setting.max) input.max = setting.max;
                        rocksForm.appendChild(label);
                        rocksForm.appendChild(input);
                    });

                    rocksContainer.appendChild(rocksForm);
                    rocksSection.appendChild(rocksContainer);
                    container.appendChild(rocksSection);

                    // 清空容器并添加新创建的元素
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(container);

                    // 初始化现有的公式
                    if (currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties) {
                        Object.entries(currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties).forEach(([difficulty, formulas]) => {
                            const formulaContainer = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
                            if (formulaContainer && Array.isArray(formulas)) {
                                formulas.forEach(formula => {
                                    try {
                                        const editor = createFormulaEditor(formula);
                                        if (editor) {
                                            formulaContainer.appendChild(editor);
                                        }
                                    } catch (err) {
                                        console.error('Error creating formula editor:', err);
                                    }
                                });
                            }
                        });
                    }

                    // 初始化纹理公式
                    if (currentPlanetData?.TERRAIN_DATA?.textureFormula) {
                        const textureContainer = document.getElementById('textureFormulas');
                        if (textureContainer && Array.isArray(currentPlanetData.TERRAIN_DATA.textureFormula)) {
                            currentPlanetData.TERRAIN_DATA.textureFormula.forEach(formula => {
                                try {
                                    const editor = createFormulaEditor(formula);
                                    if (editor) {
                                        textureContainer.appendChild(editor);
                                    }
                                } catch (err) {
                                    console.error('Error creating texture formula editor:', err);
                                }
                            });
                        }
                    }

                    // 初始化平坦区域
                    if (currentPlanetData?.TERRAIN_DATA?.flatZones?.length > 0) {
                        const flatZonesContainer = document.getElementById('flatZonesContainer');
                        const toggleFlatZonesBtn = document.getElementById('toggleFlatZonesBtn');
                        if (flatZonesContainer && toggleFlatZonesBtn) {
                            flatZonesContainer.style.display = 'block';
                            toggleFlatZonesBtn.textContent = '禁用平坦区域';
                            updateFlatZonesList();
                        }
                    }

                    // 初始化岩石设置
                    if (currentPlanetData?.TERRAIN_DATA?.rocks) {
                        const rocks = currentPlanetData.TERRAIN_DATA.rocks;
                        const rocksContainer = document.getElementById('rocksContainer');
                        const toggleRocksBtn = document.getElementById('toggleRocksBtn');
                        if (rocksContainer && toggleRocksBtn) {
                            rocksContainer.style.display = 'block';
                            toggleRocksBtn.textContent = '禁用岩石';
                            
                            const elements = {
                                'rockType': rocks.rockType,
                                'rockDensity': rocks.rockDensity,
                                'rockMinSize': rocks.minSize,
                                'rockMaxSize': rocks.maxSize,
                                'rockPowerCurve': rocks.powerCurve,
                                'rockMaxAngle': rocks.maxAngle
                            };

                            Object.entries(elements).forEach(([id, value]) => {
                                const element = document.getElementById(id);
                                if (element) {
                                    element.value = value;
                                }
                            });
                        }
                    
                    }
                    const terrainSettingsGroup = document.createElement('div');
                    terrainSettingsGroup.className = 'form-group';
                    
                    // 顶点大小设置
                    const verticeSizeLabel = document.createElement('label');
                    verticeSizeLabel.textContent = '顶点大小:';
                    const verticeSizeInput = document.createElement('input');
                    verticeSizeInput.type = 'number';
                    verticeSizeInput.id = 'verticeSize';
                    verticeSizeInput.step = '0.1';
                    verticeSizeInput.min = '0';
                    verticeSizeInput.value = currentPlanetData?.TERRAIN_DATA?.verticeSize || 4.0;
                    verticeSizeInput.onchange = (e) => {
                        if (!currentPlanetData.TERRAIN_DATA) {
                            currentPlanetData.TERRAIN_DATA = {};
                        }
                        currentPlanetData.TERRAIN_DATA.verticeSize = parseFloat(e.target.value);
                    };

                    // 碰撞体设置
                    const colliderLabel = document.createElement('label');
                    colliderLabel.textContent = '启用碰撞:';
                    const colliderCheckbox = document.createElement('input');
                    colliderCheckbox.type = 'checkbox';
                    colliderCheckbox.id = 'terrainCollider';
                    colliderCheckbox.checked = currentPlanetData?.TERRAIN_DATA?.collider !== false; // 默认为true
                    colliderCheckbox.onchange = (e) => {
                        if (!currentPlanetData.TERRAIN_DATA) {
                            currentPlanetData.TERRAIN_DATA = {};
                        }
                        currentPlanetData.TERRAIN_DATA.collider = e.target.checked;
                    };

                    // 添加到设置组
                    terrainSettingsGroup.appendChild(verticeSizeLabel);
                    terrainSettingsGroup.appendChild(verticeSizeInput);
                    terrainSettingsGroup.appendChild(document.createElement('br'));
                    terrainSettingsGroup.appendChild(colliderLabel);
                    terrainSettingsGroup.appendChild(colliderCheckbox);

                    // 添加到地形容器
                    moduleContainer.appendChild(terrainSettingsGroup);
                } catch (error) {
                    console.error('Error in terrain module:', error);
                }
            }
            else if (moduleName === 'orbit') {
                try {
                    // 创建��容器
                    const section = document.createElement('div');
                    section.className = 'module-section';

                    // 创建标题
                    const title = document.createElement('h4');
                    title.textContent = '轨道参数';
                    section.appendChild(title);

                    // 创建轨道参数表单
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';

                    // 获取星球列表并创建表单
                    const planets = await getPlanetsList();
                    
                    // 定义���道参数字段
                    const orbitFields = [
                        {
                            id: 'parent',
                            label: '母星：',
                            type: 'select',
                            options: planets,
                            value: currentPlanetData?.ORBIT_DATA?.parent || 'Sun'
                        },
                        {
                            id: 'semiMajorAxis',
                            label: '半长轴 (米)：',
                            type: 'number',
                            step: '1000000',
                            value: currentPlanetData?.ORBIT_DATA?.semiMajorAxis || 0
                        },
                        {
                            id: 'eccentricity',
                            label: '偏心率：',
                            type: 'number',
                            step: '0.01',
                            min: '0',
                            max: '0.99',
                            value: currentPlanetData?.ORBIT_DATA?.eccentricity || 0
                        },
                        {
                            id: 'argumentOfPeriapsis',
                            label: '近��幅角 (度)：',
                            type: 'number',
                            step: '1',
                            min: '0',
                            max: '360',
                            value: currentPlanetData?.ORBIT_DATA?.argumentOfPeriapsis || 0
                        },
                        {
                            id: 'direction',
                            label: '轨道方向：',
                            type: 'select',
                            options: [
                                { value: 1, text: '顺行' },
                                { value: -1, text: '逆行' }
                            ],
                            value: currentPlanetData?.ORBIT_DATA?.direction ?? 1
                        },
                        {
                            id: 'multiplierSOI',
                            label: 'SOI系数：',
                            type: 'number',
                            step: '0.1',
                            min: '0',
                            value: currentPlanetData?.ORBIT_DATA?.multiplierSOI || 2.5
                        }
                    ];

                    // 创建表单字段
                    orbitFields.forEach(field => {
                        const fieldContainer = document.createElement('div');
                        fieldContainer.className = 'field-container';

                        const label = document.createElement('label');
                        label.textContent = field.label;
                        fieldContainer.appendChild(label);

                        if (field.type === 'select') {
                            const select = document.createElement('select');
                            select.id = field.id;
                            
                            if (Array.isArray(field.options) && typeof field.options[0] !== 'object') {
                                // 简单选项列表（用于母星选择）
                                field.options.forEach(option => {
                                    const opt = document.createElement('option');
                                    opt.value = option;
                                    opt.textContent = option;
                                    select.appendChild(opt);
                                });
                            } else {
                                // 对象选项列表（用于轨道方向）
                                field.options.forEach(option => {
                                    const opt = document.createElement('option');
                                    opt.value = option.value;
                                    opt.textContent = option.text;
                                    select.appendChild(opt);
                                });
                            }
                            
                            select.value = field.value;
                            select.onchange = e => {
                                const value = field.id === 'direction' ? parseInt(e.target.value) : e.target.value;
                                updateOrbitData(field.id, value);
                            };
                            fieldContainer.appendChild(select);
                        } else {
                            const input = document.createElement('input');
                            input.type = field.type;
                            input.id = field.id;
                            if (field.step) input.step = field.step;
                            if (field.min) input.min = field.min;
                            if (field.max) input.max = field.max;
                            input.value = field.value;
                            input.oninput = e => updateOrbitData(field.id, parseFloat(e.target.value));
                            fieldContainer.appendChild(input);
                        }

                        formGroup.appendChild(fieldContainer);
                    });

                    // 创建难度缩放部分
                    const difficultyScaleSection = document.createElement('div');
                    difficultyScaleSection.className = 'difficulty-scale-section';

                    // SMA难度缩放
                    const smaScaleTitle = document.createElement('h5');
                    smaScaleTitle.textContent = '半长轴难度缩放';
                    difficultyScaleSection.appendChild(smaScaleTitle);

                    const smaScaleContainer = document.createElement('div');
                    smaScaleContainer.id = 'smaScaleContainer';
                    ['Easy', 'Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                        const diffGroup = document.createElement('div');
                        diffGroup.className = 'difficulty-group';
                        
                        const label = document.createElement('label');
                        label.textContent = `${difficulty}：`;
                        
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.value = currentPlanetData?.ORBIT_DATA?.smaDifficultyScale?.[difficulty] || 1;
                        input.oninput = e => updateOrbitDifficultyScale('sma', difficulty, parseFloat(e.target.value));
                        
                        diffGroup.appendChild(label);
                        diffGroup.appendChild(input);
                        smaScaleContainer.appendChild(diffGroup);
                    });
                    difficultyScaleSection.appendChild(smaScaleContainer);

                    // SOI难度缩放
                    const soiScaleTitle = document.createElement('h5');
                    soiScaleTitle.textContent = 'SOI难度缩放';
                    difficultyScaleSection.appendChild(soiScaleTitle);

                    const soiScaleContainer = document.createElement('div');
                    soiScaleContainer.id = 'soiScaleContainer';
                    ['Easy', 'Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                        const diffGroup = document.createElement('div');
                        diffGroup.className = 'difficulty-group';
                        
                        const label = document.createElement('label');
                        label.textContent = `${difficulty}：`;
                        
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.value = currentPlanetData?.ORBIT_DATA?.soiDifficultyScale?.[difficulty] || 1;
                        input.oninput = e => updateOrbitDifficultyScale('soi', difficulty, parseFloat(e.target.value));
                        
                        diffGroup.appendChild(label);
                        diffGroup.appendChild(input);
                        soiScaleContainer.appendChild(diffGroup);
                    });
                    difficultyScaleSection.appendChild(soiScaleContainer);

                    // 添加所有元素到主容器
                    section.appendChild(formGroup);
                    section.appendChild(difficultyScaleSection);

                    // 清空容器并添加新创建的元素
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(section);

                } catch (error) {
                    console.error('Error in orbit module:', error);
                }
            }
            else if (moduleName === 'postProcessing') {
                try {
                    // 创建主容器
                    const section = document.createElement('div');
                    section.className = 'module-section';

                    // 创建标题
                    const title = document.createElement('h4');
                    title.textContent = '后期处理';
                    section.appendChild(title);

                    // 创建关键帧列表容器
                    const keyframesList = document.createElement('div');
                    keyframesList.id = 'postProcessingKeyframes';
                    keyframesList.className = 'keyframes-list';

                    // 创建添加关键帧按钮
                    const addButton = document.createElement('button');
                    addButton.textContent = '添加关帧';
                    addButton.onclick = addPostProcessingKeyframe;

                    // 如果存在现有的关键帧数据，创建关键帧编辑器
                    if (currentPlanetData?.POST_PROCESSING?.keys) {
                        currentPlanetData.POST_PROCESSING.keys.forEach((keyframe, index) => {
                            const keyframeEditor = createPostProcessingKeyframeEditor(keyframe, index);
                            keyframesList.appendChild(keyframeEditor);
                        });
                    }

                    section.appendChild(keyframesList);
                    section.appendChild(addButton);

                    // 清空容器并添加新创建的元素
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(section);

                } catch (error) {
                    console.error('Error in post processing module:', error);
                }
            }
            else if (moduleName === 'landmarks') {
                try {
                    // 创建主容器
                    const section = document.createElement('div');
                    section.className = 'module-section landmarks-section';

                    // 创建标题
                    const title = document.createElement('h4');
                    title.textContent = '地标设置';
                    section.appendChild(title);

                    // 创建地标列表容器
                    const landmarksGroup = document.createElement('div');
                    landmarksGroup.className = 'landmarks-group';

                    // 如果存在现有的地标数据，创建地标编辑器
                    if (currentPlanetData?.LANDMARKS) {
                        currentPlanetData.LANDMARKS.forEach((landmark, index) => {
                            const landmarkContainer = document.createElement('div');
                            landmarkContainer.className = 'landmark-item';

                            // 地标名称
                            const nameInput = document.createElement('input');
                            nameInput.type = 'text';
                            nameInput.value = landmark.name;
                            nameInput.placeholder = '地标名称';
                            nameInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'name', e.target.value);
                            });

                            // 角度输入
                            const angleInput = document.createElement('input');
                            angleInput.type = 'number';
                            angleInput.value = landmark.angle;
                            angleInput.step = '0.1';
                            angleInput.placeholder = '角度';
                            angleInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'angle', parseFloat(e.target.value));
                            });

                            // 起始角度输入
                            const startAngleInput = document.createElement('input');
                            startAngleInput.type = 'number';
                            startAngleInput.value = landmark.startAngle;
                            startAngleInput.step = '0.1';
                            startAngleInput.placeholder = '起始角度';
                            startAngleInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'startAngle', parseFloat(e.target.value));
                            });

                            // 结束角度输入
                            const endAngleInput = document.createElement('input');
                            endAngleInput.type = 'number';
                            endAngleInput.value = landmark.endAngle;
                            endAngleInput.step = '0.1';
                            endAngleInput.placeholder = '结束角���';
                            endAngleInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'endAngle', parseFloat(e.target.value));
                            });

                            // 删除按钮
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = '×';
                            deleteButton.className = 'delete-landmark';
                            deleteButton.addEventListener('click', function() {
                                removeLandmark(index);
                            });

                            // 将所有元素添加到容器中
                            landmarkContainer.appendChild(nameInput);
                            landmarkContainer.appendChild(angleInput);
                            landmarkContainer.appendChild(startAngleInput);
                            landmarkContainer.appendChild(endAngleInput);
                            landmarkContainer.appendChild(deleteButton);

                            landmarksGroup.appendChild(landmarkContainer);
                        });
                    }

                    // 添加新地标按钮
                    const addButton = document.createElement('button');
                    addButton.textContent = '添加地标';
                    addButton.className = 'add-landmark';
                    addButton.addEventListener('click', function() {
                        if (!currentPlanetData.LANDMARKS) {
                            currentPlanetData.LANDMARKS = [];
                        }

                        const newLandmark = {
                            name: "新地标",
                            angle: 0.0,
                            startAngle: 0.0,
                            endAngle: 0.0
                        };

                        currentPlanetData.LANDMARKS.push(newLandmark);
                        showModuleEditor('landmarks'); // 重新渲染地标模块
                    });

                    section.appendChild(landmarksGroup);
                    section.appendChild(addButton);

                    // 清空容器并添���新创建的元素
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(section);

                } catch (error) {
                    console.error('Error in landmarks module:', error);
                }
            }
        }

        // 添加平坦区域相关函数
        function addFlatZone() {
            console.log('添加平坦区域');
            const editor = document.querySelector('.flat-zone-editor');
            const inputs = editor.querySelectorAll('input');
            
            const flatZone = {
                height: parseFloat(inputs[0].value),
                angle: parseFloat(inputs[1].value),
                width: parseFloat(inputs[2].value),
                transition: parseFloat(inputs[3].value)
            };

            if (!currentPlanetData.TERRAIN_DATA.flatZones) {
                currentPlanetData.TERRAIN_DATA.flatZones = [];
            }
            
            currentPlanetData.TERRAIN_DATA.flatZones.push(flatZone);
            updateFlatZonesList();
            
            // 清空输入框
            inputs.forEach(input => input.value = '');
        }

        function updateFlatZonesList() {
            const list = document.getElementById('flatZonesList');
            list.innerHTML = '';
            
            currentPlanetData.TERRAIN_DATA.flatZones.forEach((zone, index) => {
                const item = document.createElement('div');
                item.className = 'flat-zone-item';
                item.innerHTML = `
                    <span>高度: ${zone.height}, 角度: ${zone.angle}, 宽度: ${zone.width}, 过渡: ${zone.transition}</span>
                    <button onclick="removeFlatZone(${index})">删除</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFlatZone(index) {
            currentPlanetData.TERRAIN_DATA.flatZones.splice(index, 1);
            updateFlatZonesList();
        }

        function toggleFlatZones() {
            const container = document.getElementById('flatZonesContainer');
            const button = document.getElementById('toggleFlatZonesBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = '禁用平坦区域';
                if (!currentPlanetData.TERRAIN_DATA.flatZones) {
                    currentPlanetData.TERRAIN_DATA.flatZones = [];
                }
            } else {
                container.style.display = 'none';
                button.textContent = '启用平坦区域';
                delete currentPlanetData.TERRAIN_DATA.flatZones;
            }
        }

        // 添加岩石相关函数
        function toggleRocks() {
            console.log('切换岩石显示状态');
            const container = document.getElementById('rocksContainer');
            const button = document.getElementById('toggleRocksBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = '禁用岩石';
                if (!currentPlanetData.TERRAIN_DATA.rocks) {
                    currentPlanetData.TERRAIN_DATA.rocks = {
                        rockType: 'Rock Square',
                        rockDensity: 0.5,
                        minSize: 1,
                        maxSize: 2,
                        powerCurve: 1,
                        maxAngle: 45
                    };
                }
                updateRocksForm();
            } else {
                container.style.display = 'none';
                button.textContent = '启用岩石';
                delete currentPlanetData.TERRAIN_DATA.rocks;
            }
        }

        function updateRocksForm() {
            const rocks = currentPlanetData.TERRAIN_DATA.rocks;
            if (rocks) {
                document.getElementById('rockType').value = rocks.rockType;
                document.getElementById('rockDensity').value = rocks.rockDensity;
                document.getElementById('rockMinSize').value = rocks.minSize;
                document.getElementById('rockMaxSize').value = rocks.maxSize;
                document.getElementById('rockPowerCurve').value = rocks.powerCurve;
                document.getElementById('rockMaxAngle').value = rocks.maxAngle;
            }
        }

        // 添加公式相关函数
        function addFormulaEditor(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.appendChild(createFormulaEditor());
        }

        function addTextureFormulaEditor() {
            const container = document.getElementById('textureFormulas');
            container.appendChild(createFormulaEditor());
        }

        function updateFormulaList(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty];
            if (formulas) {
                formulas.forEach(formula => {
                    container.appendChild(createFormulaEditor(formula));
                });
            }
        }

        function updateTextureFormulaList() {
            const container = document.getElementById('textureFormulas');
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.textureFormula;
            if (formulas) {
                formulas.forEach(formula => {
                    container.appendChild(createFormulaEditor(formula));
                });
            }
        }
        function updateOrbitData(field, value) {
            console.log(`更新轨道数据: ${field} = ${value}`);
            if (!currentPlanetData.ORBIT_DATA) {
                currentPlanetData.ORBIT_DATA = {};
            }
            
            if (field === 'direction' || field === 'parent') {
                currentPlanetData.ORBIT_DATA[field] = value;
            } else {
                currentPlanetData.ORBIT_DATA[field] = parseFloat(value);
            }
        }

        function updateOrbitDifficultyScale(type, difficulty, value) {
            if (!currentPlanetData.ORBIT_DATA) {
                currentPlanetData.ORBIT_DATA = {};
            }
            
            const scaleType = type === 'sma' ? 'smaDifficultyScale' : 'soiDifficultyScale';
            
            if (!currentPlanetData.ORBIT_DATA[scaleType]) {
                currentPlanetData.ORBIT_DATA[scaleType] = {};
            }
            
            currentPlanetData.ORBIT_DATA[scaleType][difficulty] = value;
        }

        // 修改打开拓展包文件夹的函数
        async function openExtensionFolder() {
            try {
                extensionDirHandle = await window.showDirectoryPicker();
                console.log('成功打开拓展包文件夹');
                // 可以在这里添加其他初始化逻辑
            } catch (err) {
                console.error('打开拓展包文件夹失败:', err);
            }
        }

        // 创建关键帧编辑器
        function createPostProcessingKeyframeEditor(keyframe, index) {
            const editor = document.createElement('div');
            editor.className = 'keyframe-editor';
            editor.dataset.index = index;

            // 定义关键帧参数
            const fields = [
                { id: 'height', label: '高度', step: '1000', value: keyframe.height },
                { id: 'shadowIntensity', label: '阴影强度', step: '0.05', value: keyframe.shadowIntensity },
                { id: 'starIntensity', label: '星空强度', step: '0.1', value: keyframe.starIntensity },
                { id: 'hueShift', label: '色相偏移', step: '0.1', value: keyframe.hueShift },
                { id: 'saturation', label: '饱和度', step: '0.05', value: keyframe.saturation },
                { id: 'contrast', label: '对比度', step: '0.05', value: keyframe.contrast },
                { id: 'red', label: '红色', step: '0.01', value: keyframe.red },
                { id: 'green', label: '绿色', step: '0.01', value: keyframe.green },
                { id: 'blue', label: '蓝色', step: '0.01', value: keyframe.blue }
            ];

            // 创建表单字段
            fields.forEach(field => {
                const container = document.createElement('div');
                container.className = 'field-container';

                const label = document.createElement('label');
                label.textContent = field.label;

                const input = document.createElement('input');
                input.type = 'number';
                input.step = field.step;
                input.value = field.value;
                input.onchange = e => updatePostProcessingKeyframe(index, field.id, parseFloat(e.target.value));

                container.appendChild(label);
                container.appendChild(input);
                editor.appendChild(container);
            });

            // 添加删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => removePostProcessingKeyframe(index);
            editor.appendChild(deleteButton);

            return editor;
        }

        // 添加新关键帧
        function addPostProcessingKeyframe() {
            if (!currentPlanetData.POST_PROCESSING) {
                currentPlanetData.POST_PROCESSING = { keys: [] };
            }

            const newKeyframe = {
                height: 0.0,
                shadowIntensity: 1.0,
                starIntensity: 0.0,
                hueShift: 0.0,
                saturation: 1.0,
                contrast: 1.0,
                red: 1.0,
                green: 1.0,
                blue: 1.0
            };

            currentPlanetData.POST_PROCESSING.keys.push(newKeyframe);
            const keyframesList = document.getElementById('postProcessingKeyframes');
            const editor = createPostProcessingKeyframeEditor(newKeyframe, currentPlanetData.POST_PROCESSING.keys.length - 1);
            keyframesList.appendChild(editor);
        }

        // 更新关键帧数据
        function updatePostProcessingKeyframe(index, field, value) {
            if (currentPlanetData?.POST_PROCESSING?.keys?.[index]) {
                currentPlanetData.POST_PROCESSING.keys[index][field] = value;
                // 按高度排序
                currentPlanetData.POST_PROCESSING.keys.sort((a, b) => a.height - b.height);
                // 重新渲染关键帧列表
                const keyframesList = document.getElementById('postProcessingKeyframes');
                keyframesList.innerHTML = '';
                currentPlanetData.POST_PROCESSING.keys.forEach((keyframe, idx) => {
                    const editor = createPostProcessingKeyframeEditor(keyframe, idx);
                    keyframesList.appendChild(editor);
                });
            }
        }

        // 删除关���帧
        function removePostProcessingKeyframe(index) {
            if (currentPlanetData?.POST_PROCESSING?.keys) {
                currentPlanetData.POST_PROCESSING.keys.splice(index, 1);
                // 重新渲染关键帧列表
                const keyframesList = document.getElementById('postProcessingKeyframes');
                keyframesList.innerHTML = '';
                currentPlanetData.POST_PROCESSING.keys.forEach((keyframe, idx) => {
                    const editor = createPostProcessingKeyframeEditor(keyframe, idx);
                    keyframesList.appendChild(editor);
                });
            }
        }

        // 创建地标编辑器
        function createLandmarkEditor(landmark, index) {
            console.log(`创建地标编辑器: 索引=${index}`);
            const editor = document.createElement('div');
            editor.className = 'landmark-editor';
            editor.dataset.index = index;

            // 定义地标参数
            const fields = [
                { id: 'name', label: '名称', type: 'text', value: landmark.name },
                { id: 'angle', label: '角度', type: 'number', step: '0.1', value: landmark.angle },
                { id: 'startAngle', label: '起始角度', type: 'number', step: '0.1', value: landmark.startAngle },
                { id: 'endAngle', label: '结束角度', type: 'number', step: '0.1', value: landmark.endAngle }
            ];

            // 创建表单字段
            fields.forEach(field => {
                const container = document.createElement('div');
                container.className = 'field-container';

                const label = document.createElement('label');
                label.textContent = field.label;

                const input = document.createElement('input');
                input.type = field.type;
                if (field.type === 'number') {
                    input.step = field.step;
                }
                input.value = field.value;
                input.onchange = e => updateLandmark(
                    index, 
                    field.id, 
                    field.type === 'number' ? parseFloat(e.target.value) : e.target.value
                );

                container.appendChild(label);
                container.appendChild(input);
                editor.appendChild(container);
            });

            // 添加删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => removeLandmark(index);
            editor.appendChild(deleteButton);

            return editor;
        }

        // 添加新地标
        function addLandmark() {
            if (!currentPlanetData.LANDMARKS) {
                currentPlanetData.LANDMARKS = [];
            }

            const newLandmark = {
                name: "新地标",
                angle: 0.0,
                startAngle: 0.0,
                endAngle: 0.0
            };

            currentPlanetData.LANDMARKS.push(newLandmark);
            updatePlanetEditForm(); // 重新渲染地标模块
        }

        // 更新地标数据
        function updateLandmark(index, field, value) {
            if (currentPlanetData?.LANDMARKS?.[index]) {
                currentPlanetData.LANDMARKS[index][field] = value;
                // 按角度排序
                currentPlanetData.LANDMARKS.sort((a, b) => a.angle - b.angle);
                // 重新渲染地标模块
                showModuleEditor('landmarks');
            }
        }

        // 删除地标
        function removeLandmark(index) {
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.splice(index, 1);
                // 重新渲染地标模块
                showModuleEditor('landmarks');
            }
        }

        // 在星球编辑表单中添��地标部分
        function updatePlanetEditForm() {
            // ... 其他表单部分的代码 ...

            // 获取或创建地标部分容器
            let landmarksSection = document.querySelector('.form-section.landmarks-section');
            if (!landmarksSection) {
                landmarksSection = document.createElement('div');
                landmarksSection.className = 'form-section landmarks-section';
                document.querySelector('#planetEditForm').appendChild(landmarksSection);
            }

            // 清空现有内容
            landmarksSection.innerHTML = '';
            
            // 创建标题
            const landmarksTitle = document.createElement('h4');
            landmarksTitle.textContent = '地标设置';
            landmarksSection.appendChild(landmarksTitle);

            // 创建地标组
            const landmarksGroup = document.createElement('div');
            landmarksGroup.className = 'landmarks-group';

            // 添加现有地标
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.forEach((landmark, index) => {
                    const landmarkContainer = document.createElement('div');
                    landmarkContainer.className = 'landmark-item';

                    // 地标名称
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = landmark.name;
                    nameInput.placeholder = '地标名称';
                    nameInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'name', e.target.value);
                    });

                    // 角度输入
                    const angleInput = document.createElement('input');
                    angleInput.type = 'number';
                    angleInput.value = landmark.angle;
                    angleInput.step = '0.1';
                    angleInput.placeholder = '角度';
                    angleInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'angle', parseFloat(e.target.value));
                    });

                    // 起始角度输入
                    const startAngleInput = document.createElement('input');
                    startAngleInput.type = 'number';
                    startAngleInput.value = landmark.startAngle;
                    startAngleInput.step = '0.1';
                    startAngleInput.placeholder = '起始角度';
                    startAngleInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'startAngle', parseFloat(e.target.value));
                    });

                    // 结束角度输入
                    const endAngleInput = document.createElement('input');
                    endAngleInput.type = 'number';
                    endAngleInput.value = landmark.endAngle;
                    endAngleInput.step = '0.1';
                    endAngleInput.placeholder = '结束角';
                    endAngleInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'endAngle', parseFloat(e.target.value));
                    });

                    // 删除按钮
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '×';
                    deleteButton.className = 'delete-landmark';
                    deleteButton.addEventListener('click', function() {
                        removeLandmark(index);
                    });

                    // 将所有元素添加到容器中
                    landmarkContainer.appendChild(nameInput);
                    landmarkContainer.appendChild(angleInput);
                    landmarkContainer.appendChild(startAngleInput);
                    landmarkContainer.appendChild(endAngleInput);
                    landmarkContainer.appendChild(deleteButton);

                    landmarksGroup.appendChild(landmarkContainer);
                });
            }

            // 添加新地标按钮
            const addButton = document.createElement('button');
            addButton.textContent = '添加地标';
            addButton.className = 'add-landmark';
            addButton.addEventListener('click', function() {
                if (!currentPlanetData.LANDMARKS) {
                    currentPlanetData.LANDMARKS = [];
                }

                const newLandmark = {
                    name: "新地标",
                    angle: 0.0,
                    startAngle: 0.0,
                    endAngle: 0.0
                };

                currentPlanetData.LANDMARKS.push(newLandmark);
                showModuleEditor('landmarks'); // 重新渲染地标模块
            });

            landmarksSection.appendChild(landmarksGroup);
            landmarksSection.appendChild(addButton);
        }

        // 添加相应的 CSS 样式
        const style = document.createElement('style');
        style.textContent = `
            .landmarks-group {
                margin: 10px 0;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 4px;
            }

            .landmark-item {
                display: flex;
                gap: 10px;
                margin-bottom: 8px;
                align-items: center;
            }

            .landmark-item input[type="text"] {
                width: 200px;
                padding: 5px;
                border: 1px solid #ddd;
                border-radius: 3px;
            }

            .landmark-item input[type="number"] {
                width: 100px;
                padding: 5px;
                border: 1px solid #ddd;
                border-radius: 3px;
            }

            .delete-landmark {
                padding: 2px 8px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .add-landmark {
                margin-top: 10px;
                padding: 8px 15px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .delete-landmark:hover {
                background: #c82333;
            }

            .add-landmark:hover {
                background: #218838;
            }
        `;
        document.head.appendChild(style);

        // 修改基础数据字段的处理
        function updateBaseData(field, value) {
            console.log(`更新基础数据: ${field} = ${value}`);
            if (!currentPlanetData.BASE_DATA) {
                currentPlanetData.BASE_DATA = {};
            }

            // 特殊处理 velocityArrowsHeight 字段
            if (field === 'velocityArrowsHeight') {
                // 如果值是 "NaN"，直接存储字符串 "NaN"
                if (value === "NaN" || value === "") {
                    currentPlanetData.BASE_DATA[field] = "NaN";
                } else {
                    currentPlanetData.BASE_DATA[field] = parseFloat(value);
                }
            } else {
                // 其他字段正常处理
                currentPlanetData.BASE_DATA[field] = parseFloat(value);
            }
        }

        // 修改基础数据字段的创建
        const baseFields = [
            // ... 其他字段 ...
            {
                id: 'velocityArrowsHeight',
                label: '速度箭头高度：',
                type: 'text', // 改为 text 类型而不是 number
                value: currentPlanetData?.BASE_DATA?.velocityArrowsHeight || "NaN"
            },
            // ... 其他字段 ...
        ];

        // 修改字段创建逻辑
        if (field.type === 'number') {
            input.type = 'number';
            if (field.step) input.step = field.step;
            if (field.min) input.min = field.min;
            if (field.max) input.max = field.max;
            input.value = field.value;
            input.oninput = e => updateBaseData(field.id, e.target.value);
        } else {
            input.type = 'text';
            input.value = field.value;
            input.oninput = e => updateBaseData(field.id, e.target.value);
        }

        // 添加地标初始化函数
        function initializeLandmarks() {
            const landmarksList = document.getElementById('landmarksList');
            const addLandmarkButton = document.querySelector('.add-landmark');
            
            // 清空现有列表
            landmarksList.innerHTML = '';
            
            // 显示现有地标
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.forEach((landmark, index) => {
                    const landmarkItem = createLandmarkItem(landmark, index);
                    landmarksList.appendChild(landmarkItem);
                });
            }

            // 绑定添加地标按钮事件
            addLandmarkButton.onclick = addNewLandmark;
        }

        // 创建单个地标项
        function createLandmarkItem(landmark, index) {
            const item = document.createElement('div');
            item.className = 'landmark-item';

            // 名称输入
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = landmark.name;
            nameInput.placeholder = '地标名称';
            nameInput.addEventListener('change', (e) => updateLandmarkField(index, 'name', e.target.value));

            // 角度输入
            const angleInput = document.createElement('input');
            angleInput.type = 'number';
            angleInput.value = landmark.angle;
            angleInput.step = '0.1';
            angleInput.placeholder = '角度';
            angleInput.addEventListener('change', (e) => updateLandmarkField(index, 'angle', parseFloat(e.target.value)));

            // 起始角度输入
            const startAngleInput = document.createElement('input');
            startAngleInput.type = 'number';
            startAngleInput.value = landmark.startAngle;
            startAngleInput.step = '0.1';
            startAngleInput.placeholder = '起始角度';
            startAngleInput.addEventListener('change', (e) => updateLandmarkField(index, 'startAngle', parseFloat(e.target.value)));

            // 结束角度输入
            const endAngleInput = document.createElement('input');
            endAngleInput.type = 'number';
            endAngleInput.value = landmark.endAngle;
            endAngleInput.step = '0.1';
            endAngleInput.placeholder = '结束角度';
            endAngleInput.addEventListener('change', (e) => updateLandmarkField(index, 'endAngle', parseFloat(e.target.value)));

            // 删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '×';
            deleteButton.className = 'delete-landmark';
            deleteButton.addEventListener('click', () => deleteLandmark(index));

            // 添加所有元素到容器
            item.appendChild(nameInput);
            item.appendChild(angleInput);
            item.appendChild(startAngleInput);
            item.appendChild(endAngleInput);
            item.appendChild(deleteButton);

            return item;
        }

        // 添加新地标
        function addNewLandmark() {
            if (!currentPlanetData.LANDMARKS) {
                currentPlanetData.LANDMARKS = [];
            }

            const newLandmark = {
                name: "新地标",
                angle: 0.0,
                startAngle: 0.0,
                endAngle: 0.0
            };

            currentPlanetData.LANDMARKS.push(newLandmark);
            initializeLandmarks(); // 重新渲染地标列表
        }

        // 更新地标字段
        function updateLandmarkField(index, field, value) {
            if (currentPlanetData?.LANDMARKS?.[index]) {
                currentPlanetData.LANDMARKS[index][field] = value;
                // 按角度排序
                currentPlanetData.LANDMARKS.sort((a, b) => a.angle - b.angle);
                initializeLandmarks(); // 重新渲染地标列表
            }
        }

        // 删除地标
        function deleteLandmark(index) {
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.splice(index, 1);
                initializeLandmarks(); // 重新渲染地标列表
            }
        }
        // 添加高度图列表管理相关函数
        async function loadHeightmaps(dirHandle) {
            try {
                const heightmapDir = await dirHandle.getDirectoryHandle('Heightmap Data');
                // 初始化全局 heightmaps 数组
                window.heightmaps = [];
                
                // 遍历Heightmap Data目录下的所有文件
                for await (const entry of heightmapDir.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                        const heightmapName = entry.name.replace('.txt', '');
                        window.heightmaps.push(heightmapName);
                        addHeightmapToList(heightmapName, entry);
                    }
                }
                // 对高度图名称进行排序
                window.heightmaps.sort();
                
            } catch (err) {
                console.error('加载高度图列表失败:', err);
                // 如果加载失败,设置默认值
                window.heightmaps = [];
            }
        }

        // 修改添加高度图到列表的函数
        function addHeightmapToList(name, fileHandle) {
            const heightmapsList = document.getElementById('heightmapsList');
            const heightmapItem = document.createElement('div');
            heightmapItem.className = 'heightmap-item';
            
            // 创建可点击的文件名
            const nameDiv = document.createElement('div');
            nameDiv.className = 'heightmap-name';
            nameDiv.textContent = name;
            nameDiv.onclick = () => viewHeightmap(name); // 点击文件名查看高度图
            
            // 创建删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.textContent = '×';
            deleteButton.onclick = () => deleteHeightmap(name);
            
            heightmapItem.appendChild(nameDiv);
            heightmapItem.appendChild(deleteButton);
            heightmapsList.appendChild(heightmapItem);
        }

        async function viewHeightmap(name) {
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                const fileHandle = await heightmapDir.getFileHandle(`${name}.txt`);
                const file = await fileHandle.getFile();
                const content = await file.text();
                const heightmapData = JSON.parse(content);
                
                // 显示高度图预览
                showHeightmapPreview(name, heightmapData.points);
            } catch (err) {
                console.error('读取高度图失败:', err);
            }
        }

        // 2. 基础工具函数
        function drawHeightmapGraph(ctx, points) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const minValue = 0.0;
            const maxValue = 1.0;
            const valueRange = maxValue - minValue; // 等于2.0
            
            const scaleX = width / (points.length - 1);
            const padding = height * 0.1;
            const scaleY = (height - 2 * padding) / valueRange;
            
            // 绘制参考线和刻度
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // 绘制水平参考线（从-1.0到1.0，步进0.2）
            for(let value = minValue; value <= maxValue; value += 0.2) {
                const y = height - padding - ((value - minValue) * scaleY);
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
                
                // 添加刻度值
                ctx.fillStyle = '#666';
                ctx.textAlign = 'right';
                ctx.fillText(value.toFixed(1), 30, y + 4);
            }
            
            // 绘制高度图
            ctx.beginPath();
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 2;
            
            points.forEach((point, index) => {
                const x = index * scaleX;
                // 将点的值限制在 -1.0 到 1.0 之间
                const clampedPoint = Math.max(minValue, Math.min(maxValue, point));
                const y = height - padding - ((clampedPoint - minValue) * scaleY);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // 添加垂直网格线
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            
            const gridCount = 10;
            for(let i = 1; i < gridCount; i++) {
                const x = (width / gridCount) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
        }

        // 3. 工具实现函数
        function applyBrush(index, points, size, strength) {
            const halfSize = Math.floor(size / 2);
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex >= 0 && targetIndex < points.length) {
                    const influence = 1 - Math.abs(i) / halfSize;
                    points[targetIndex] += strength * influence;
                    points[targetIndex] = Math.max(-1, Math.min(1, points[targetIndex]));
                }
            }
        }

        function applySmooth(index, points, size) {
            const halfSize = Math.floor(size / 2);
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex > 0 && targetIndex < points.length - 1) {
                    points[targetIndex] = (points[targetIndex-1] + points[targetIndex] + points[targetIndex+1]) / 3;
                }
            }
        }

        function applyNoise(index, points, size, strength) {
            const halfSize = Math.floor(size / 2);
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex >= 0 && targetIndex < points.length) {
                    const noise = (Math.random() - 0.5) * 2 * strength;
                    points[targetIndex] += noise;
                    points[targetIndex] = Math.max(-1, Math.min(1, points[targetIndex]));
                }
            }
        }

        function applyFlatten(index, points, size) {
            const halfSize = Math.floor(size / 2);
            const targetHeight = points[index];
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex >= 0 && targetIndex < points.length) {
                    points[targetIndex] = targetHeight;
                }
            }
        }

        // 4. 工具选择和应用函数
        function selectTool(toolId) {
            currentTool = toolId;
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${toolId}"]`).classList.add('active');
        }

        function applyTool(e, canvas, points) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const index = Math.floor((x / canvas.width) * (points.length - 1));
            const brushSize = parseInt(document.getElementById('brushSize').value) || 10; // 默认值10
            const strength = parseFloat(document.getElementById('brushStrength').value) || 0.2; // 默认值0.2
            
            switch(currentTool) {
                case 'brush':
                    applyBrush(index, points, brushSize, strength);
                    break;
                case 'smooth':
                    applySmooth(index, points, brushSize);
                    break;
                case 'noise':
                    applyNoise(index, points, brushSize, strength);
                    break;
                case 'flatten':
                    applyFlatten(index, points, brushSize);
                    break;
            }
            
            drawHeightmapGraph(canvas.getContext('2d'), points);
        }

        // 5. 界面交互函数
        function setupCanvasInteraction(canvas, points) {
            // 创建points的副本
            currentPoints = Array.from(points);  // 使用 Array.from 创建新数组
            
            canvas.onmousedown = (e) => {
                isDrawing = true;
                applyTool(e, canvas, currentPoints);
            };
            
            canvas.onmousemove = (e) => {
                if (isDrawing) {
                    applyTool(e, canvas, currentPoints);
                }
            };
            
            canvas.onmouseup = () => {
                isDrawing = false;
            };
            
            canvas.onmouseleave = () => {
                isDrawing = false;
            };
        }

        // 6. UI创建函数
        function createEditToolbar() {
            const toolbar = document.createElement('div');
            toolbar.className = 'heightmap-toolbar';
            
            const tools = [
                { id: 'brush', icon: '🖌️', name: '笔刷' },
                { id: 'smooth', icon: '🔄', name: '平滑' },
                { id: 'noise', icon: '📊', name: '噪声' },
                { id: 'flatten', icon: '📏', name: '平坦化' }
            ];
            
            tools.forEach(tool => {
                const button = document.createElement('button');
                button.className = 'tool-button';
                button.dataset.tool = tool.id;
                button.innerHTML = `${tool.icon} ${tool.name}`;
                button.onclick = () => selectTool(tool.id);
                toolbar.appendChild(button);
            });
            
            const toolProperties = document.createElement('div');
            toolProperties.className = 'tool-properties';
            
            // 笔刷大小 - 改为输入框
            const brushSize = document.createElement('div');
            brushSize.className = 'tool-property';
            brushSize.innerHTML = `
                <label>笔刷大小: </label>
                <input type="number" id="brushSize" value="10" min="1" max="100">
            `;
            
            // 强度 - 改为输入框，范围[-1,1]，默认0.2
            const brushStrength = document.createElement('div');
            brushStrength.className = 'tool-property';
            brushStrength.innerHTML = `
                <label>强度: </label>
                <input type="number" id="brushStrength" value="0.2" min="-1" max="1" step="0.1">
            `;
            
            toolProperties.appendChild(brushSize);
            toolProperties.appendChild(brushStrength);
            toolbar.appendChild(toolProperties);
            
            return toolbar;
        }

        // 7. 最后是主要的显示函数
        function showHeightmapPreview(name, points) {
            const previewContainer = document.getElementById('heightmapPreview');
            previewContainer.innerHTML = '';
            
            const title = document.createElement('h3');
            title.textContent = `高度图: ${name}`;
            previewContainer.appendChild(title);
            
            // 添加按钮
            previewContainer.appendChild(createHeightmapButtons());
            
            // 添加��具栏
            const toolbar = createEditToolbar();
            previewContainer.appendChild(toolbar);
            
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 500;
            const ctx = canvas.getContext('2d');
            
            drawHeightmapGraph(ctx, points);
            setupCanvasInteraction(canvas, points);
            
            previewContainer.appendChild(canvas);
        }

        function createHeightmapButtons() {
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'heightmap-buttons';
            
            // 加载高度图按钮
            const loadButton = document.createElement('button');
            loadButton.textContent = '加载高度图';
            loadButton.onclick = loadHeightmapFile;
            
            // 新建高度图按钮
            const newButton = document.createElement('button');
            newButton.textContent = '新建高度图';
            newButton.onclick = createNewHeightmap;
            
            // 保存高度图按钮
            const saveButton = document.createElement('button');
            saveButton.textContent = '保存高度图';
            saveButton.onclick = saveCurrentHeightmap;
            
            // 扩展高度图按钮
            const expandButton = document.createElement('button');
            expandButton.textContent = '扩展高度图';
            expandButton.onclick = expandHeightmap;
            
            buttonsDiv.appendChild(loadButton);
            buttonsDiv.appendChild(newButton);
            buttonsDiv.appendChild(saveButton);
            buttonsDiv.appendChild(expandButton);
            
            return buttonsDiv;
        }

        // 加载高度图文件
        async function loadHeightmapFile() {
            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: '高度图文件',
                        accept: {
                            'text/plain': ['.txt']
                        }
                    }]
                });
                
                const file = await fileHandle.getFile();
                const content = await file.text();
                const heightmapData = JSON.parse(content);
                
                if (!Array.isArray(heightmapData.points)) {
                    throw new Error('无效的高度图格式');
                }
                
                // 复制到高度图目录
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data', { create: true });
                const newFileHandle = await heightmapDir.getFileHandle(fileHandle.name, { create: true });
                const writable = await newFileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                // 重新加载列表
                await loadHeightmaps(currentDirHandle);
                
            } catch (err) {
                console.error('加载高度图文件失败:', err);
            }
        }

        // 新建高度图
        async function createNewHeightmap() {
            const name = prompt('请输入高度图名称:', '新高度图');
            if (!name) return;
            
            // 创建50个初始数据点
            const points = Array(50).fill(0.5); // 初始值都设为0.5
            
            const heightmapData = {
                points: points
            };
            
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data', { create: true });
                const fileHandle = await heightmapDir.getFileHandle(`${name}.txt`, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(heightmapData, null, 4));
                await writable.close();
                
                // 重新加载列表
                await loadHeightmaps(currentDirHandle);
                
                // 直接显示新建的高度图
                showHeightmapPreview(name, points);
                
            } catch (err) {
                console.error('新建高度图失败:', err);
            }
        }

        // 保存当前高度图
        async function saveCurrentHeightmap() {
            if (!currentPoints || !currentHeightmapName) {
                alert('没有可保存的高度图');
                return;
            }
            
            const heightmapData = {
                points: currentPoints
            };
            
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                const fileHandle = await heightmapDir.getFileHandle(`${currentHeightmapName}.txt`, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(heightmapData, null, 4));
                await writable.close();
                
                alert('保存成功');
                
            } catch (err) {
                console.error('保存高度图失败:', err);
                alert('保存失败');
            }
        }

        // 扩展高度图
        async function expandHeightmap() {
            if (!currentPoints) {
                alert('没有可扩展的高度图');
                return;
            }
            
            const count = parseInt(prompt('请输入要扩展的数据点数量:', '10'));
            if (isNaN(count) || count <= 0) {
                alert('请输入有效的数量');
                return;
            }
            
            // 在当前点数据末尾添加新点
            const lastValue = currentPoints[currentPoints.length - 1];
            const newPoints = Array(count).fill(lastValue);
            currentPoints = [...currentPoints, ...newPoints];
            
            // 重新绘制
            const canvas = document.querySelector('#heightmapPreview canvas');
            if (canvas) {
                drawHeightmapGraph(canvas.getContext('2d'), currentPoints);
            }
        }

        // 修改 showHeightmapPreview 函数
        function showHeightmapPreview(name, points) {
            currentHeightmapName = name; // 保存当前高度图名称
            
            const previewContainer = document.getElementById('heightmapPreview');
            previewContainer.innerHTML = '';
            
            const title = document.createElement('h3');
            title.textContent = `高度图: ${name}`;
            previewContainer.appendChild(title);
            
            // 添加按钮
            previewContainer.appendChild(createHeightmapButtons());
            
            // 添加工具栏
            const toolbar = createEditToolbar();
            previewContainer.appendChild(toolbar);
            
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 500;
            const ctx = canvas.getContext('2d');
            
            drawHeightmapGraph(ctx, points);
            setupCanvasInteraction(canvas, points);
            
            previewContainer.appendChild(canvas);
        }

        async function deleteHeightmap(name) {
            if (!confirm(`确定要删除高度图 "${name}" 吗？`)) return;
            
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                await heightmapDir.removeEntry(`${name}.txt`);
                await loadHeightmaps(currentDirHandle); // 重新加载列表
            } catch (err) {
                console.error('删除高度图失败:', err);
            }
        }
        async function loadTextures(dirHandle) {
            console.log('loadTextures 被调用'); // 调试日志
            if (!dirHandle) {
                console.error('目录句柄不存在');
                return;
            }

            try {
                console.log('尝试获取 Texture Data 目录...'); // 调试日志
                const textureDir = await dirHandle.getDirectoryHandle('Texture Data');
                console.log('成功获取 Texture Data 目录'); // 调试日志
                
                const texturesList = document.getElementById('texturesList');
                if (!texturesList) {
                    console.error('找不到 texturesList 元素');
                    return;
                }
                
                texturesList.innerHTML = '';
                console.log('已清空现有列表'); // 调试日志
                
                let fileCount = 0;
                for await (const entry of textureDir.values()) {
                    console.log('发现文件:', entry.name); // 调试日志
                    if (entry.kind === 'file' && (entry.name.endsWith('.png') || entry.name.endsWith('.jpg'))) {
                        const textureName = entry.name.replace(/\.(png|jpg)$/, '');
                        addTextureToList(textureName, entry);
                        fileCount++;
                    }
                }
                console.log(`共加载了 ${fileCount} 个图层文件`); // 调试日志
                
            } catch (err) {
                console.error('加载图层列表失败:', err.message);
                console.error(err); // 输出完整错误信息
            }
        }

        // 修改 addTextureToList 函数，添加更多的视觉反馈
        function addTextureToList(name, fileHandle) {
            const texturesList = document.getElementById('texturesList');
            if (!texturesList) {
                console.error('找不到texturesList元素');
                return;
            }

            const textureItem = document.createElement('div');
            textureItem.className = 'texture-item';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'texture-name';
            nameDiv.textContent = name;
            
            // 添加点击事件
            nameDiv.onclick = () => {
                // 移除其他项目的选中状态
                document.querySelectorAll('.texture-item').forEach(item => {
                    item.classList.remove('selected');
                });
                // 添加选中状态
                textureItem.classList.add('selected');
                viewTexture(name);
            };
            
            textureItem.appendChild(nameDiv);
            texturesList.appendChild(textureItem);
            console.log('添加图层到列表:', name); // 调试日志
        }

        // 修改 viewTexture 函数，添加更多的错误处理
        async function viewTexture(name) {
            if (!currentDirHandle) {
                console.error('未加载拓展包');
                return;
            }

            try {
                const textureDir = await currentDirHandle.getDirectoryHandle('Texture Data');
                // 尝试两种文件扩展名
                let fileHandle;
                try {
                    fileHandle = await textureDir.getFileHandle(`${name}.png`);
                } catch {
                    fileHandle = await textureDir.getFileHandle(`${name}.jpg`);
                }
                
                const file = await fileHandle.getFile();
                showTexturePreview(name, URL.createObjectURL(file));
                console.log('加载图层预览:', name); // 调试日志
            } catch (err) {
                console.error('读取图层失败:', err);
            }
        }

        // 显示图层预览
        function showTexturePreview(name, imageUrl) {
            const previewContainer = document.getElementById('texturePreview');
            previewContainer.innerHTML = '';
            
            // 创建预览标题
            const title = document.createElement('h3');
            title.textContent = `图层: ${name}`;
            previewContainer.appendChild(title);
            
            // 创建图片预览
            const img = document.createElement('img');
            img.src = imageUrl;
            img.className = 'texture-preview-image';
            img.onload = () => {
                // 图片加载完成后释放URL
                URL.revokeObjectURL(imageUrl);
            };
            
            previewContainer.appendChild(img);
        }

        // 确保在DOM加载完成后再添加事件监听器
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成'); // 调试日志
            // 初始化页面状态
            switchPage('settings');
        });

        // 公式解析函数
        function parseFormula(formulaStr) {
            if (!formulaStr || typeof formulaStr !== 'string') {
                return {
                    output: 'OUTPUT',
                    heightmap: 'Perlin',
                    scale: 6283.18530718,
                    height: 1,
                    curve: '',
                    mask: ''
                };
            }

            // 匹配公式格式
            const regex = /(\w+)\s*=\s*AddHeightMap\(\s*(\w+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:\s*,\s*(\w+)?)?(?:\s*,\s*(\w+))?\s*\)/;
            const match = formulaStr.match(regex);
            
            if (!match) {
                return {
                    output: 'OUTPUT',
                    heightmap: 'Perlin',
                    scale: 6283.18530718,
                    height: 1,
                    curve: '',
                    mask: ''
                };
            }

            return {
                output: match[1],
                heightmap: match[2],
                scale: parseFloat(match[3]),
                height: parseFloat(match[4]),
                curve: match[5] || '',
                mask: match[6] || ''
            };
        }

        // 创建公式编辑器
        function createFormulaEditor(formula = '') {
            const editor = document.createElement('div');
            editor.className = 'formula-editor';

            // 解析现有公式或使用默认值
            const parsedFormula = parseFormula(formula);

            // 创建输出变量选择器
            const outputSelect = document.createElement('select');
            outputSelect.className = 'output-select';
            ['OUTPUT', 'M'].forEach(output => {
                const option = document.createElement('option');
                option.value = output;
                option.textContent = output;
                if (output === parsedFormula.output) {
                    option.selected = true;
                }
                outputSelect.appendChild(option);
            });

            // 创建高度图选择器 - 使用 heightmaps 数组
            const heightmapSelect = document.createElement('select');
            heightmapSelect.className = 'heightmap-select';
            
            // 确保 heightmaps 存在且是数组
            if (Array.isArray(heightmaps)) {
                heightmaps.forEach(heightmap => {
                    const option = document.createElement('option');
                    option.value = heightmap;
                    option.textContent = heightmap;
                    if (heightmap === parsedFormula.heightmap) {
                        option.selected = true;
                    }
                    heightmapSelect.appendChild(option);
                });
            } else {
                // 如果 heightmaps 不可用,添加默认选项
                const defaultHeightmaps = [];
                defaultHeightmaps.forEach(heightmap => {
                    const option = document.createElement('option');
                    option.value = heightmap;
                    option.textContent = heightmap;
                    if (heightmap === parsedFormula.heightmap) {
                        option.selected = true;
                    }
                    heightmapSelect.appendChild(option);
                });
            }

            // 创建缩放输入框
            const scaleInput = document.createElement('input');
            scaleInput.type = 'number';
            scaleInput.className = 'scale-input';
            scaleInput.value = parsedFormula.scale;
            scaleInput.step = '0.1';

            // 创建高度输入框
            const heightInput = document.createElement('input');
            heightInput.type = 'number';
            heightInput.className = 'height-input';
            heightInput.value = parsedFormula.height;
            heightInput.step = '0.1';

            // 创建曲线选择器
            const curveSelect = heightmapSelect;

            // 创建遮罩选择器
            const maskSelect = document.createElement('select');
            maskSelect.className = 'mask-select';
            ['', 'M'].forEach(mask => {
                const option = document.createElement('option');
                option.value = mask;
                option.textContent = mask || 'null';
                if (mask === parsedFormula.mask) {
                    option.selected = true;
                }
                maskSelect.appendChild(option);
            });

            // 创建删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.onclick = () => editor.remove();

            // 将所有元素添加到编辑器
            editor.appendChild(outputSelect);
            editor.appendChild(document.createTextNode(' = AddHeightMap( '));
            editor.appendChild(heightmapSelect);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(scaleInput);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(heightInput);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(curveSelect);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(maskSelect);
            editor.appendChild(document.createTextNode(' )'));
            editor.appendChild(deleteButton);

            return editor;
        }

        // 生成公式字符串
        function generateFormula(output, heightmap, scale, height, curve, mask) {
            let formula = `${output} = AddHeightMap( ${heightmap}, ${scale}, ${height}`;
            if (curve || mask) {
                formula += `, ${curve || 'null'}`;
            }
            if (mask) {
                formula += `, ${mask}`;
            }
            formula += ')';
            return formula;
        }

        // 更新公式列表
        function updateFormulas(difficulty) {
            if (!currentPlanetData.TERRAIN_DATA) {
                currentPlanetData.TERRAIN_DATA = {};
            }
            if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties = {};
            }

            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            const formulas = [];

            container.querySelectorAll('.formula-editor').forEach(editor => {
                const output = editor.querySelector('.output-select').value;
                const heightmap = editor.querySelector('.heightmap-select').value;
                const scale = parseFloat(editor.querySelector('.scale-input').value);
                const height = parseFloat(editor.querySelector('.height-input').value);
                const curve = editor.querySelector('.curve-select').value;
                const mask = editor.querySelector('.mask-select').value;

                formulas.push(generateFormula(output, heightmap, scale, height, curve, mask));
            });

            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = formulas;
        }

        // 更新纹理公式
        function updateTextureFormulas() {
            if (!currentPlanetData.TERRAIN_DATA) {
                currentPlanetData.TERRAIN_DATA = {};
            }

            const container = document.getElementById('textureFormulas');
            const formulas = [];

            container.querySelectorAll('.formula-editor').forEach(editor => {
                const heightmap = editor.querySelector('.heightmap-select').value;
                const scale = parseFloat(editor.querySelector('.scale-input').value);
                const height = parseFloat(editor.querySelector('.height-input').value);
                const curve = editor.querySelector('.curve-select').value;

                formulas.push(generateFormula(heightmap, scale, height, curve));
            });

            currentPlanetData.TERRAIN_DATA.textureFormula = formulas;
        }

    </script>
</body>
</html>