<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ‹“å±•åŒ…ç®¡ç†å™¨</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
        }
        
        .sidebar {
            width: 60px;
            background-color: #333;
            height: 100vh;
            padding-top: 20px;
        }
        
        .sidebar button {
            width: 50px;
            height: 50px;
            margin: 5px;
            border: none;
            background-color: #444;
            color: white;
            cursor: pointer;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .top-buttons {
            margin-bottom: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .settings-form {
            max-width: 500px;
        }
        
        .settings-form textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group select {
            padding: 5px;
            width: 200px;
        }
        
        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .planets-container {
            display: flex;
            gap: 20px;
        }
        
        .planets-list {
            width: 250px;
            border-right: 1px solid #ccc;
        }
        
        .list-header {
            margin-bottom: 15px;
        }
        
        .planet-buttons {
            display: flex;
            gap: 10px;
        }
        
        .list-content {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .planet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .planet-item span {
            flex: 1;
        }
        
        .planet-item-buttons {
            display: flex;
            gap: 5px;
        }
        
        .planet-item-buttons button {
            padding: 2px 5px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
        
        .planet-item-buttons button:hover {
            background-color: #eee;
            border-radius: 3px;
        }
        
        .planet-item:hover {
            background-color: #f5f5f5;
        }
        
        .planet-item.selected {
            background-color: #e3e3e3;
        }
        
        .planet-editor {
            flex: 1;
        }
        
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .module-toggles {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .module-toggles button {
            margin-right: 5px;
            padding: 5px 10px;
        }
        
        .module-toggles button.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .save-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .module-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .fog-key {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .fog-key h6 {
            margin: 0 0 10px 0;
        }
        
        select {
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        
        .module-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .module-section {
            margin-bottom: 15px;
        }
        
        .module-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        /* åœ°å½¢æ¨¡å—çš„åŸºæœ¬æ ·å¼ */
        .module-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .module-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .module-section h5 {
            margin: 10px 0;
            color: #495057;
        }

        /* è¡¨å•ç»„æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .form-group label {
            display: inline-block;
            width: 120px;
            margin-right: 10px;
            color: #495057;
        }

        .form-group input[type="number"],
        .form-group input[type="text"] {
            width: 100px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 15px;
        }

        .form-group select {
            width: 200px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 15px;
            background-color: white;
        }

        .form-group input[type="checkbox"] {
            margin-right: 5px;
        }

        /* åœ°å½¢å…¬å¼ç›¸å…³æ ·å¼ */
        .difficulty-section {
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .formula-list {
            margin-bottom: 10px;
        }

        .formula-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .formula-item input {
            flex: 1;
            margin-right: 10px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .formula-item button {
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .formula-item button:hover {
            background: #c82333;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .form-group label {
                display: block;
                margin-bottom: 5px;
            }

            .form-group input[type="number"],
            .form-group input[type="text"],
            .form-group select {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        /* æ·»åŠ æ–°çš„CSSæ ·å¼ */
        .formula-editor {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .formula-editor select,
        .formula-editor input {
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .formula-editor .heightmap-select {
            width: 150px;
        }

        .formula-editor .scale-input,
        .formula-editor .height-input {
            width: 100px;
        }

        .formula-editor .curve-select {
            width: 120px;
        }

        .flat-zone-editor {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .flat-zone-editor input {
            width: 100px;
        }

        #flatZonesList,
        #textureFormulas {
            margin-top: 10px;
        }

        .formula-item,
        .flat-zone-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .formula-item button,
        .flat-zone-item button {
            padding: 2px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        /* è½¨é“æ¨¡å—çš„åŸºæœ¬æ ·å¼ */
        .module-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .field-container {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .field-container label {
            width: 150px;
            margin-right: 10px;
        }

        .field-container input,
        .field-container select {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* éš¾åº¦ç¼©æ”¾éƒ¨åˆ†çš„æ ·å¼ */
        .difficulty-scale-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .difficulty-scale-section h5 {
            margin-bottom: 10px;
            color: #333;
        }

        .difficulty-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .difficulty-group label {
            width: 100px;
            margin-right: 10px;
        }

        .difficulty-group input {
            width: 80px;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†çš„æ‚¬åœæ•ˆæœ */
        .field-container input:hover,
        .field-container select:hover,
        .difficulty-group input:hover {
            border-color: #999;
        }

        /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†çš„ç„¦ç‚¹æ•ˆæœ */
        .field-container input:focus,
        .field-container select:focus,
        .difficulty-group input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }

        /* åæœŸå¤„ç†æ¨¡å—çš„åŸºæœ¬æ ·å¼ */
        .keyframes-list {
            margin-bottom: 15px;
        }

        .keyframe-editor {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .keyframe-editor .field-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .keyframe-editor .field-container label {
            width: 100px;
            margin-right: 10px;
        }

        .keyframe-editor .field-container input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .keyframe-editor .delete-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .keyframe-editor .delete-button:hover {
            background-color: #ff0000;
        }

        /* æ·»åŠ å…³é”®å¸§æŒ‰é’®æ ·å¼ */
        #postProcessingKeyframes + button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }

        #postProcessingKeyframes + button:hover {
            background-color: #45a049;
        }

        /* è¾“å…¥æ¡†æ‚¬åœå’Œç„¦ç‚¹æ•ˆæœ */
        .keyframe-editor .field-container input:hover {
            border-color: #999;
        }

        .keyframe-editor .field-container input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (min-width: 768px) {
            .keyframe-editor .field-container {
                display: inline-flex;
                width: calc(50% - 10px);
                margin-right: 10px;
            }
        }

        @media (min-width: 1200px) {
            .keyframe-editor .field-container {
                width: calc(33.33% - 10px);
            }
        }

        /* åœ°æ ‡æ¨¡å—çš„åŸºæœ¬æ ·å¼ */
        .landmarks-list {
            margin-bottom: 15px;
        }

        .landmark-editor {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        /* åœ°æ ‡ç¼–è¾‘å™¨ä¸­çš„å­—æ®µå®¹å™¨ */
        .landmark-editor .field-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .landmark-editor .field-container label {
            width: 80px;
            margin-right: 10px;
        }

        .landmark-editor .field-container input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        /* åç§°è¾“å…¥æ¡†ç‰¹æ®Šæ ·å¼ */
        .landmark-editor .field-container input[type="text"] {
            width: 200px;
        }

        /* æ•°å­—è¾“å…¥æ¡†ç‰¹æ®Šæ ·å¼ */
        .landmark-editor .field-container input[type="number"] {
            width: 100px;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .landmark-editor .delete-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .landmark-editor .delete-button:hover {
            background-color: #ff0000;
        }

        /* æ·»åŠ åœ°æ ‡æŒ‰é’®æ ·å¼ */
        #landmarksList + button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }

        #landmarksList + button:hover {
            background-color: #45a049;
        }

        /* è¾“å…¥æ¡†æ‚¬åœå’Œç„¦ç‚¹æ•ˆæœ */
        .landmark-editor .field-container input:hover {
            border-color: #999;
        }

        .landmark-editor .field-container input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (min-width: 768px) {
            .landmark-editor {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                padding-right: 50px; /* ä¸ºåˆ é™¤æŒ‰é’®ç•™å‡ºç©ºé—´ */
            }

            .landmark-editor .field-container {
                width: calc(50% - 10px);
                margin-right: 10px;
            }
        }

        @media (min-width: 1200px) {
            .landmark-editor .field-container {
                width: calc(25% - 10px);
            }
        }

        .landmarks-group {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .landmark-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .landmark-item input[type="text"] {
            width: 200px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .landmark-item input[type="number"] {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .delete-landmark {
            padding: 2px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .add-landmark {
            margin-top: 10px;
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .delete-landmark:hover {
            background: #c82333;
        }

        .add-landmark:hover {
            background: #218838;
        }

        .heightmaps-layout {
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .heightmaps-list {
            width: 250px;
            border-right: 1px solid #ccc;
            padding-right: 20px;
        }

        .heightmap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: white;
        }

        .heightmap-name {
            flex: 1;
            padding: 5px;
            cursor: pointer;
            color: #2196F3;
        }

        .heightmap-name:hover {
            background-color: #f5f5f5;
            border-radius: 3px;
        }

        .delete-button {
            padding: 2px 8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }

        .delete-button:hover {
            background: #d32f2f;
        }

        /* é«˜åº¦å›¾é¢„è§ˆéƒ¨åˆ†çš„æ ·å¼ä¼˜åŒ– */
        .heightmap-preview-container {
            flex: 1;
            padding: 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #heightmapPreview {
            max-width: 100%;
            overflow-x: auto;
        }

        #heightmapPreview canvas {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: crosshair;
        }

        .heightmap-data {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
        }

        .heightmap-data th {
            background-color: #f5f5f5;
            padding: 12px 8px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .heightmap-data td {
            padding: 8px;
            border: 1px solid #eee;
        }

        .heightmap-data tr:nth-child(even) {
            background-color: #fafafa;
        }

        .heightmap-toolbar {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .tool-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tool-button:hover {
            background: #eee;
        }

        .tool-button.active {
            background: #2196F3;
            color: white;
        }

        .tool-properties {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-property {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-property input[type="number"] {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tool-property label {
            font-size: 14px;
            color: #333;
        }

        #brushSizeValue, #brushStrengthValue, #noiseAmountValue {
            margin-left: 10px;
        }

        .heightmap-buttons {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }

        .heightmap-buttons button {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .heightmap-buttons button:hover {
            background: #45a049;
        }

        .textures-layout {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 150px);
        }

        .textures-list {
            width: 250px;
            border-right: 1px solid #ccc;
            padding-right: 20px;
            overflow-y: auto;
        }

        .texture-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .texture-item:hover {
            background-color: #f5f5f5;
        }

        .texture-name {
            color: #2196F3;
        }

        .texture-preview-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .texture-preview-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .texture-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .texture-item:hover {
            background-color: #f5f5f5;
        }

        .texture-item.selected {
            background-color: #e3f2fd;
        }

        .texture-name {
            color: #2196F3;
        }

        .texture-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .texture-preview-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button onclick="switchPage('settings')" title="è®¾ç½®">âš™ï¸</button>
        <button onclick="switchPage('planets')" title="æ˜Ÿçƒ">ğŸŒ</button>
        <button onclick="switchPage('heightmaps')" title="é«˜åº¦å›¾">ğŸ“Š</button>
        <button onclick="switchPage('textures')" title="å›¾å±‚">ğŸ–¼ï¸</button>
    </div>
    
    <div class="main-content">
        <div class="top-buttons">
            <button onclick="loadPack()">åŠ è½½æ‹“å±•åŒ…</button>
            <button onclick="createPack()">æ–°å»ºæ‹“å±•åŒ…</button>
        </div>
        
        <div id="settings" class="page active">
            <h2>è®¾ç½®</h2>
            <div class="settings-form">
                <h3>å¯¼å…¥è®¾ç½®</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeDefaultPlanets"> 
                        åŒ…å«é»˜è®¤æ˜Ÿçƒ
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeDefaultHeightmaps"> 
                        åŒ…å«é»˜è®¤åœ°å½¢å›¾
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeDefaultTextures"> 
                        åŒ…å«é»˜è®¤çº¹ç†
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="hideStarsInAtmosphere"> 
                        åœ¨å¤§æ°”å±‚ä¸­éšè—æ˜Ÿæ˜Ÿ
                    </label>
                </div>

                <h3>å‘å°„å°è®¾ç½®</h3>
                <div class="form-group">
                    <label>æ‰€åœ¨æ˜Ÿçƒï¼š</label>
                    <select id="planetAddress">
                        <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
                <div class="form-group">
                    <label>è§’åº¦ï¼š</label>
                    <input type="number" id="launchAngle" step="0.1"> åº¦
                </div>
                <div class="form-group">
                    <label>æ°´å¹³ä½ç½®ï¼š</label>
                    <input type="number" id="horizontalPosition" step="0.1"> ç±³
                </div>
                <div class="form-group">
                    <label>é«˜åº¦ï¼š</label>
                    <input type="number" id="height" step="0.1"> ç±³
                </div>

                <h3>ç‰ˆæœ¬ä¿¡æ¯</h3>
                <div class="form-group">
                    <label>ç‰ˆæœ¬å·ï¼š</label>
                    <input type="text" id="version" placeholder="ä¾‹å¦‚: 1.5.10.2">
                </div>

                <button onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
        
        <div id="planets" class="page">
            <h2>æ˜Ÿçƒç®¡ç†</h2>
            <div class="planets-container">
                <div class="planets-list">
                    <div class="list-header">
                        <h3>æ˜Ÿçƒåˆ—è¡¨</h3>
                        <div class="planet-buttons">
                            <button onclick="loadPlanetFile()">åŠ è½½æ˜Ÿçƒ</button>
                            <button onclick="createNewPlanet()">æ–°å»ºæ˜Ÿçƒ</button>
                        </div>
                    </div>
                    <div id="planetsList" class="list-content">
                        <!-- æ˜Ÿçƒåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
                
                <div class="planet-editor">
                    <div id="noPlanetSelected" style="display: block;">
                        è¯·é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªæ˜Ÿçƒ
                    </div>
                    
                    <div id="planetEditForm" style="display: none;">
                        <h3 id="editingPlanetName"></h3>
                        
                        <div class="form-section">
                            <label>ç‰ˆæœ¬ï¼š</label>
                            <input type="text" id="planetVersion" value="1.5">
                        </div>

                        <div class="form-section">
                            <h4>åŸºç¡€æ•°æ®</h4>
                            <div class="form-group">
                                <label>åŠå¾„ (ç±³)ï¼š</label>
                                <input type="number" id="planetRadius" step="1000">
                            </div>
                            <div class="form-group">
                                <label>é‡åŠ› (m/sÂ²)ï¼š</label>
                                <input type="number" id="planetGravity" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>æ—¶é—´åŠ é€Ÿé«˜åº¦ (ç±³)ï¼š</label>
                                <input type="number" id="timewarpHeight">
                            </div>
                            <div class="form-group">
                                <label>é€Ÿåº¦ç®­å¤´é«˜åº¦ (ç±³)ï¼š</label>
                                <input type="number" id="velocityArrowsHeight">
                            </div>
                            <div class="form-group">
                                <label>åœ°å›¾é¢œè‰²ï¼š</label>
                                <input type="color" id="mapColor">
                                <input type="range" id="mapColorAlpha" min="0" max="1" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="significant">
                                    é‡è¦å¤©ä½“
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="rotateCamera">
                                    ç›¸æœºæ—‹è½¬
                                </label>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>å¯é€‰æ¨¡å—</h4>
                            <div class="module-toggles">
                                <button id="btnAtmospherePhysics" onclick="toggleModule('atmospherePhysics')">å¤§æ°”å±‚ç‰©ç†</button>
                                <button id="btnAtmosphereVisuals" onclick="toggleModule('atmosphereVisuals')">å¤§æ°”å±‚è§†è§‰</button>
                                <button id="btnTerrain" onclick="toggleModule('terrain')">åœ°å½¢</button>
                                <button id="btnOrbit" onclick="toggleModule('orbit')">è½¨é“</button>
                                <button id="btnPostProcessing" onclick="toggleModule('postProcessing')">åæœŸå¤„ç†</button>
                            </div>
                            
                            <div id="moduleContent" class="module-content">
                                <!-- æ¨¡å—å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>æˆå°±è®¾ç½®</h4>
                            <div class="achievements-group">
                                <label>
                                    <input type="checkbox" id="achieveLanded">
                                    ç€é™†æˆå°±
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveTakeoff">
                                    èµ·é£æˆå°±
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveAtmosphere">
                                    å¤§æ°”å±‚æˆå°±
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveOrbit">
                                    è½¨é“æˆå°±
                                </label>
                                <label>
                                    <input type="checkbox" id="achieveCrash">
                                    å æ¯æˆå°±
                                </label>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>åœ°æ ‡è®¾ç½®</h4>
                            <div class="landmarks-group">
                                <!-- æ·»åŠ åœ°æ ‡åˆ—è¡¨ -->
                                <div id="landmarksList"></div>
                                <!-- æ·»åŠ æ–°åœ°æ ‡æŒ‰é’® -->
                                <button class="add-landmark">æ·»åŠ åœ°æ ‡</button>
                            </div>
                        </div>

                        <button onclick="savePlanet()" class="save-button">ä¿å­˜æ˜Ÿçƒ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="heightmaps" class="page">
            <h2>é«˜åº¦å›¾</h2>
            <div class="heightmaps-layout">
                <div class="heightmaps-list">
                    <h3>é«˜åº¦å›¾åˆ—è¡¨</h3>
                    <div id="heightmapsList"></div>
                </div>
                <div class="heightmap-preview-container">
                    <div id="heightmapPreview"></div>
                </div>
            </div>
        </div>
        
        <div id="textures" class="page">
            <h2>å›¾å±‚</h2>
            <div class="textures-layout">
                <div class="textures-list">
                    <h3>å›¾å±‚åˆ—è¡¨</h3>
                    <div id="texturesList"></div>
                </div>
                <div class="texture-preview-container">
                    <div id="texturePreview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¦–å…ˆåœ¨æ–‡ä»¶é¡¶éƒ¨å£°æ˜å…¨å±€å˜é‡
        let heightmaps = ['Perlin']; // é»˜è®¤å€¼
        let currentPlanetData = null;

        // åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å…¨å±€å˜é‡
        let extensionDirHandle = null;

        // åœ¨æ–‡ä»¶æœ€é¡¶éƒ¨ï¼Œå’Œå…¶ä»–å…¨å±€å˜é‡ä¸€èµ·å£°æ˜
        let currentDirHandle = null;
        let currentTool = 'brush';
        let isDrawing = false;
        let currentPoints = [];
        let currentHeightmapName = null;  // æ·»åŠ è¿™ä¸ªå…¨å±€å˜é‡å£°æ˜

        // åœ¨æ–‡ä»¶é¡¶éƒ¨çš„å…¨å±€å˜é‡å£°æ˜ä¸­æ·»åŠ 
        let currentPage = 'settings'; // é»˜è®¤æ˜¾ç¤ºè®¾ç½®é¡µé¢

        const defaultSettings = {
            importSettings: {
                includeDefaultPlanets: false,
                includeDefaultHeightmaps: false,
                includeDefaultTextures: false,
                hideStarsInAtmosphere: false
            },
            spaceCenterData: {
                address: "",
                angle: 0.0,
                position_LaunchPad: {
                    horizontalPosition: 0.0,
                    height: 0.0
                }
            },
            version: ""
        };

        // æ·»åŠ é¡µé¢åˆ‡æ¢å‡½æ•°
        function switchPage(pageId) {
            console.log('åˆ‡æ¢é¡µé¢åˆ°:', pageId); // è°ƒè¯•æ—¥å¿—
            const targetPage = document.getElementById(pageId);
            if (!targetPage) {
                console.error(`æ‰¾ä¸åˆ°é¡µé¢: ${pageId}`);
                return;
            }
            
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„é¡µé¢
            targetPage.classList.add('active');
            
            // æ›´æ–°å½“å‰é¡µé¢
            currentPage = pageId;
            
            // å¦‚æœåˆ‡æ¢åˆ°å›¾å±‚é¡µé¢ï¼Œé‡æ–°åŠ è½½å›¾å±‚åˆ—è¡¨
            if (pageId === 'textures' && currentDirHandle) {
                console.log('å½“å‰æ˜¯å›¾å±‚é¡µé¢'); // è°ƒè¯•æ—¥å¿—
                console.log('currentDirHandle:', !!currentDirHandle); // æ£€æŸ¥ç›®å½•å¥æŸ„æ˜¯å¦å­˜åœ¨
                if (currentDirHandle) {
                    console.log('å¼€å§‹åŠ è½½å›¾å±‚åˆ—è¡¨...'); // è°ƒè¯•æ—¥å¿—
                    loadTextures(currentDirHandle);
                } else {
                    console.log('æœªåŠ è½½æ‹“å±•åŒ…ï¼Œæ— æ³•åŠ è½½å›¾å±‚åˆ—è¡¨'); // è°ƒè¯•æ—¥å¿—
                }
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        async function loadPack() {
            console.log('å¼€å§‹åŠ è½½æ‹“å±•åŒ…...'); // è°ƒè¯•æ—¥å¿—
            try {
                const dirHandle = await window.showDirectoryPicker();
                currentDirHandle = dirHandle; // ä¿å­˜ç›®å½•å¥æŸ„ä»¥ä¾›ç»­ä½¿ç”¨
                console.log('å·²è·å–ç›®å½•å¥æŸ„'); // è°ƒè¯•æ—¥å¿—
                
                // è¯»å–è®¾ç½®æ–‡ä»¶
                await loadSettingsFiles(dirHandle);
                console.log('å·²åŠ è½½è®¾ç½®æ–‡ä»¶'); // è°ƒè¯•æ—¥å¿—
                
                // åŠ è½½æ˜Ÿçƒåˆ—è¡¨
                await loadPlanets(dirHandle);
                console.log('å·²åŠ è½½æ˜Ÿçƒåˆ—è¡¨'); // è°ƒè¯•æ—¥å¿—
                
                // åŠ è½½é«˜åº¦å›¾åˆ—è¡¨
                await loadHeightmaps(dirHandle);
                console.log('å·²åŠ è½½é«˜åº¦å›¾åˆ—è¡¨'); // è°ƒè¯•æ—¥å¿—
                
                // åŠ è½½å›¾å±‚åˆ—è¡¨
                console.log('å‡†å¤‡åŠ è½½å›¾å±‚åˆ—è¡¨...'); // è°ƒè¯•æ—¥å¿—
                await loadTextures(dirHandle);
                console.log('å·²åŠ è½½å›¾å±‚åˆ—è¡¨'); // è°ƒè¯•æ—¥å¿—
                
            } catch (err) {
                console.error('åŠ è½½æ‹“å±•åŒ…å¤±è´¥:', err);
            }
        }
// åœ¨åˆ›å»ºæ–°æ‹“å±•åŒ…çš„å‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç 
        async function createInitialHeightmap(dirHandle) {
            try {
                // åˆ›å»ºTEST.txtæ–‡ä»¶çš„å†…å®¹
                const initialData = {
                    points: [0.5, 0.5]
                };
                
                // åˆ›å»ºå¹¶å†™å…¥TEST.txtæ–‡ä»¶
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data')
                const fileHandle = await heightmapDir.getFileHandle('TEST.txt', { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(initialData, null, 4));
                await writable.close();
                
                console.log('æˆåŠŸåˆ›å»ºåˆå§‹é«˜åº¦å›¾æ–‡ä»¶ TEST.txt');
            } catch (err) {
                console.error('åˆ›å»ºåˆå§‹é«˜åº¦å›¾æ–‡ä»¶å¤±è´¥:', err);
            }
        }
        async function createPack() {
            const packName = prompt('è¯·è¾“å…¥æ–°æ‹“å±•åŒ…åç§°ï¼š');
            if (!packName) return;

            try {
                const dirHandle = await window.showDirectoryPicker();
                const newDirHandle = await dirHandle.getDirectoryHandle(packName, { create: true });
                
                // åˆ›å»ºå­ç›®å½•
                await newDirHandle.getDirectoryHandle('Heightmap Data', { create: true });
                await newDirHandle.getDirectoryHandle('Planet Data', { create: true });
                await newDirHandle.getDirectoryHandle('Texture Data', { create: true });
                await createInitialHeightmap(dirHandle);
                // åˆ›å»ºè®¾ç½®æ–‡ä»¶
                await createSettingsFiles(newDirHandle);
                currentDirHandle = newDirHandle;
                await loadHeightmaps(currentDirHandle);
                alert('æ‹“å±•åŒ…åˆ›å»ºæˆåŠŸï¼');
            } catch (err) {
                console.error('é”™è¯¯:', err);
                alert('åˆ›å»ºæ‹“å±•åŒ…å¤±è´¥ï¼');
            }
        }

        async function createSettingsFiles(dirHandle) {
            const files = {
                'Import_Settings.txt': JSON.stringify(defaultSettings.importSettings, null, 2),
                'Space_Center_Data.txt': JSON.stringify(defaultSettings.spaceCenterData, null, 2),
                'Version.txt': defaultSettings.version
            };

            for (const [filename, content] of Object.entries(files)) {
                const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
            }
        }

        async function loadSettingsFiles(dirHandle) {
            try {
                const importSettingsFile = await dirHandle.getFileHandle('Import_Settings.txt');
                const spaceCenterFile = await dirHandle.getFileHandle('Space_Center_Data.txt');
                const versionFile = await dirHandle.getFileHandle('Version.txt');

                const importSettings = JSON.parse(await (await importSettingsFile.getFile()).text());
                const spaceCenterData = JSON.parse(await (await spaceCenterFile.getFile()).text());
                const versionContent = await (await versionFile.getFile()).text();

                // è®¾ç½®å¤é€‰æ¡†çŠ¶æ€
                document.getElementById('includeDefaultPlanets').checked = importSettings.includeDefaultPlanets;
                document.getElementById('includeDefaultHeightmaps').checked = importSettings.includeDefaultHeightmaps;
                document.getElementById('includeDefaultTextures').checked = importSettings.includeDefaultTextures;
                document.getElementById('hideStarsInAtmosphere').checked = importSettings.hideStarsInAtmosphere;

                // åŠ è½½è¡Œæ˜Ÿåˆ—è¡¨å¹¶è®¾ç½®å‘å°„å°æ•°æ®
                await loadPlanetList(dirHandle);
                document.getElementById('planetAddress').value = spaceCenterData.address;
                document.getElementById('launchAngle').value = spaceCenterData.angle;
                document.getElementById('horizontalPosition').value = spaceCenterData.position_LaunchPad.horizontalPosition;
                document.getElementById('height').value = spaceCenterData.position_LaunchPad.height;

                // è®¾ç½®ç‰ˆæœ¬
                document.getElementById('version').value = versionContent;
            } catch (err) {
                console.error('è¯»å–æ–‡ä»¶é”™è¯¯:', err);
                alert('è¯»å–è®¾ç½®æ–‡ä»¶å¤±è´¥ï¼');
            }
        }

        async function saveSettings() {
            try {
                // è·å–è®¾ç½®æ•°æ®
                const settings = {
                    importSettings: {
                        includeDefaultPlanets: document.getElementById('includeDefaultPlanets').checked,
                        includeDefaultHeightmaps: document.getElementById('includeDefaultHeightmaps').checked,
                        includeDefaultTextures: document.getElementById('includeDefaultTextures').checked,
                        hideStarsInAtmosphere: document.getElementById('hideStarsInAtmosphere').checked
                    },
                    spaceCenterData: {
                        address: document.getElementById('planetAddress').value,
                        angle: parseFloat(document.getElementById('launchAngle').value),
                        position_LaunchPad: {
                            horizontalPosition: parseFloat(document.getElementById('horizontalPosition').value),
                            height: parseFloat(document.getElementById('height').value)
                        }
                    },
                    version: document.getElementById('version').value
                };

                // ä¿å­˜ Import_Settings.txt
                const importSettingsFile = await currentDirHandle.getFileHandle('Import_Settings.txt', { create: true });
                const importSettingsWritable = await importSettingsFile.createWritable();
                await importSettingsWritable.write(JSON.stringify(settings.importSettings, null, 2));
                await importSettingsWritable.close();

                // ä¿å­˜ Space_Center_Data.txt  
                const spaceCenterFile = await currentDirHandle.getFileHandle('Space_Center_Data.txt', { create: true });
                const spaceCenterWritable = await spaceCenterFile.createWritable();
                await spaceCenterWritable.write(JSON.stringify(settings.spaceCenterData, null, 2));
                await spaceCenterWritable.close();

                // ä¿å­˜ Version.txt
                const versionFile = await currentDirHandle.getFileHandle('Version.txt', { create: true });
                const versionWritable = await versionFile.createWritable();
                await versionWritable.write(settings.version);
                await versionWritable.close();

                alert('è®¾ç½®å·²æˆåŠŸä¿å­˜!');
            } catch (err) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', err);
                alert('ä¿å­˜è®¾ç½®å¤±è´¥!é”™è¯¯ä¿¡æ¯: ' + err.message);
            }
        }

        async function loadPlanetList(dirHandle) {
            try {
                const planetDataDir = await dirHandle.getDirectoryHandle('Planet Data');
                const select = document.getElementById('planetAddress');
                select.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
                
                for await (const entry of planetDataDir.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                        const planetName = entry.name.replace('.txt', '');
                        const option = document.createElement('option');
                        option.value = planetName;
                        option.textContent = planetName;
                        select.appendChild(option);
                    }
                }
            } catch (err) {
                console.error('åŠ è½½è¡Œæ˜Ÿåˆ—è¡¨å¤±è´¥:', err);
            }
        }


        // åŠ è½½æ˜Ÿçƒæ–‡ä»¶
        async function loadPlanetFile() {
            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'æ˜Ÿçƒæ–‡ä»¶',
                        accept: {
                            'text/plain': ['.txt']
                        }
                    }]
                });
                
                const file = await fileHandle.getFile();
                const content = await file.text();
                const planetData = JSON.parse(content);
                
                // å°†æ–‡ä»¶åŠ åˆ°åˆ—è¡¨ä¸­
                addPlanetToList(fileHandle.name.replace('.txt', ''), planetData);
            } catch (err) {
                console.error('åŠ è½½æ˜Ÿçƒæ–‡ä»¶å¤±è´¥:', err);
            }
        }

        // åˆ›å»ºæ–°æ˜Ÿçƒ
        async function createNewPlanet() {
            const planetName = prompt('è¯·è¾“å…¥æ˜Ÿçƒåç§°ï¼š');
            if (!planetName) return;

            const newPlanetData = {
                version: "1.5",
                BASE_DATA: {
                    radius: 315000.0,
                    radiusDifficultyScale: {},
                    gravity: 9.8,
                    gravityDifficultyScale: {},
                    timewarpHeight: 25000.0,
                    velocityArrowsHeight: 5000.0,
                    mapColor: {
                        r: 0.45,
                        g: 0.68,
                        b: 1.0,
                        a: 1.0
                    },
                    significant: true,
                    rotateCamera: true
                },
                ACHIEVEMENT_DATA: {
                    Landed: false,
                    Takeoff: false,
                    Atmosphere: false,
                    Orbit: false,
                    Crash: false
                },
                LANDMARKS: []
            };

            addPlanetToList(planetName, newPlanetData);
        }

        // å°†æ˜Ÿçƒæ·»åŠ åˆ°åˆ—è¡¨ä¸­
        function addPlanetToList(planetName, planetData) {
            const planetsList = document.getElementById('planetsList');
            const planetItem = document.createElement('div');
            planetItem.className = 'planet-item';
            
            // åˆ›å»ºæ˜Ÿï¿½ï¿½ï¿½åç§°å’Œæ“ä½œæŒ‰é’®å®¹å™¨
            const nameSpan = document.createElement('span');
            nameSpan.textContent = planetName;
            nameSpan.onclick = () => selectPlanet(planetName, planetData);
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'planet-item-buttons';
            
            // å¤åˆ¶æŒ‰é’®
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'å¤ï¿½ï¿½';
            copyBtn.title = 'å¤åˆ¶';
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                copyPlanet(planetName, planetData);
            };
            
            // åˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'âŒ';
            deleteBtn.title = 'åˆ é™¤';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deletePlanet(planetName, planetItem);
            };
            
            buttonsDiv.appendChild(copyBtn);
            buttonsDiv.appendChild(deleteBtn);
            
            planetItem.appendChild(nameSpan);
            planetItem.appendChild(buttonsDiv);
            planetsList.appendChild(planetItem);
        }

        // æ·»åŠ å¤åˆ¶æ˜ŸçƒåŠŸèƒ½
        async function copyPlanet(planetName, planetData) {
            const newName = prompt('è¯·è¾“å…¥æ–°æ˜Ÿçƒåç§°ï¼š', planetName + '_copy');
            if (!newName) return;
            
            // æ·±æ‹·è´æ˜Ÿçƒæ•°æ®
            const newPlanetData = JSON.parse(JSON.stringify(planetData));
            addPlanetToList(newName, newPlanetData);
            
            // å¦‚æœæœ‰å½“å‰ç›®å½•å¥æŸ„ï¼Œä¿å­˜åˆ°æ–‡ä»¶
            if (currentDirHandle) {
                try {
                    const planetDataDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                    await savePlanetToFile(planetDataDir, newName, newPlanetData);
                } catch (err) {
                    console.error('ä¿å­˜å¤åˆ¶çš„æ˜Ÿçƒå¤±è´¥:', err);
                }
            }
        }

        // æ·»åŠ åˆ é™¤æ˜Ÿï¿½ï¿½ï¿½åŠŸèƒ½
        async function deletePlanet(planetName, planetItem) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ˜Ÿçƒ "${planetName}" å—ï¼Ÿ`)) return;
            
            if (currentDirHandle) {
                try {
                    const planetDataDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                    await planetDataDir.removeEntry(planetName + '.txt');
                } catch (err) {
                    console.error('åˆ é™¤æ˜Ÿçƒæ–‡ä»¶å¤±è´¥:', err);
                    return;
                }
            }
            
            planetItem.remove();
        }

        // æ·»åŠ æ–‡ä»¶ä¿å­˜åŠŸèƒ½
        async function savePlanetToFile(dirHandle, planetName, planetData) {
            const fileHandle = await dirHandle.getFileHandle(planetName + '.txt', { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(planetData, null, 2));
            await writable.close();
        }

        // é€‰æ‹©æ˜Ÿçƒè¿›è¡Œç¼–è¾‘
        function selectPlanet(planetName, planetData) {
            document.querySelectorAll('.planet-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            currentPlanetData = planetData;
            document.getElementById('noPlanetSelected').style.display = 'none';
            document.getElementById('planetEditForm').style.display = 'block';
            document.getElementById('editingPlanetName').textContent = planetName;

            // å¡«å……åŸºç¡€æ•°æ®
            document.getElementById('planetVersion').value = planetData.version;
            document.getElementById('planetRadius').value = planetData.BASE_DATA.radius;
            document.getElementById('planetGravity').value = planetData.BASE_DATA.gravity;
            document.getElementById('timewarpHeight').value = planetData.BASE_DATA.timewarpHeight;
            document.getElementById('velocityArrowsHeight').value = planetData.BASE_DATA.velocityArrowsHeight;
            
            // è®¾ç½®åœ°å›¾é¢œè‰²
            const color = planetData.BASE_DATA.mapColor;
            const hexColor = rgbaToHex(color.r, color.g, color.b);
            document.getElementById('mapColor').value = hexColor;
            document.getElementById('mapColorAlpha').value = color.a;
            
            document.getElementById('significant').checked = planetData.BASE_DATA.significant;
            document.getElementById('rotateCamera').checked = planetData.BASE_DATA.rotateCamera;

            // è®¾ç½®æˆå°±æ•°æ®
            document.getElementById('achieveLanded').checked = planetData.ACHIEVEMENT_DATA.Landed;
            document.getElementById('achieveTakeoff').checked = planetData.ACHIEVEMENT_DATA.Takeoff;
            document.getElementById('achieveAtmosphere').checked = planetData.ACHIEVEMENT_DATA.Atmosphere;
            document.getElementById('achieveOrbit').checked = planetData.ACHIEVEMENT_DATA.Orbit;
            document.getElementById('achieveCrash').checked = planetData.ACHIEVEMENT_DATA.Crash;

            // æ¸…ç©ºå¹¶æ›´æ–°æ¨¡å—çŠ¶æ€
            document.getElementById('moduleContent').innerHTML = '';
            updateModuleButtons(planetData);

            // åˆå§‹åŒ–åœ°æ ‡åˆ—è¡¨
            initializeLandmarks();
        }

        // ä¿®æ”¹ updateModuleButtons å‡½æ•°
        async function updateModuleButtons(planetData) {
            // æ¸…ç©ºæ‰€æœ‰æ¨¡å—å®¹å™¨
            document.getElementById('moduleContent').innerHTML = '';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const btnPhysics = document.getElementById('btnAtmospherePhysics');
            const btnVisuals = document.getElementById('btnAtmosphereVisuals');
            const btnTerrain = document.getElementById('btnTerrain');
            const btnOrbit = document.getElementById('btnOrbit');
            const btnPostProcessing = document.getElementById('btnPostProcessing');

            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            btnPhysics.classList.toggle('active', !!planetData.ATMOSPHERE_PHYSICS_DATA);
            btnVisuals.classList.toggle('active', !!planetData.ATMOSPHERE_VISUALS_DATA);
            btnTerrain.classList.toggle('active', !!planetData.TERRAIN_DATA);
            btnOrbit.classList.toggle('active', !!planetData.ORBIT_DATA);
            btnPostProcessing.classList.toggle('active', !!planetData.POST_PROCESSING);

            // æ˜¾ç¤ºæ‰€æœ‰æ¿€æ´»çš„æ¨¡å—ç¼–è¾‘ç•Œé¢
            if (btnPhysics.classList.contains('active')) {
                await showModuleEditor('atmospherePhysics');
            }
            if (btnVisuals.classList.contains('active')) {
                await showModuleEditor('atmosphereVisuals');
            }
            if (btnTerrain.classList.contains('active')) {
                await showModuleEditor('terrain');
            }
            if (btnOrbit.classList.contains('active')) {
                await showModuleEditor('orbit');
            }
            if (btnPostProcessing.classList.contains('active')) {
                await showModuleEditor('postProcessing');
            }
        }

        // ä¿®æ”¹ toggleModule å‡½æ•°
        async function toggleModule(moduleName) {
            if (!currentPlanetData) return;
            
            const btn = document.getElementById('btn' + moduleName.charAt(0).toUpperCase() + moduleName.slice(1));
            const moduleContainer = document.getElementById(`${moduleName}Container`);
            
            if (btn.classList.contains('active')) {
                // åªç§»é™¤å½“å‰æ¨¡å—
                btn.classList.remove('active');
                if (moduleContainer) {
                    moduleContainer.remove();
                }
                
                // åªåˆ é™¤å¯¹åº”çš„æ•°æ®
                switch(moduleName) {
                    case 'atmospherePhysics':
                        delete currentPlanetData.ATMOSPHERE_PHYSICS_DATA;
                        break;
                    case 'atmosphereVisuals':
                        delete currentPlanetData.ATMOSPHERE_VISUALS_DATA;
                        break;
                    case 'terrain':
                        delete currentPlanetData.TERRAIN_DATA;
                        break;
                    case 'orbit':
                        delete currentPlanetData.ORBIT_DATA;
                        break;
                    case 'postProcessing':
                        delete currentPlanetData.POST_PROCESSING;
                        break;
                }
            } else {
                // æ·»åŠ æ¨¡å—
                btn.classList.add('active');
                
                switch(moduleName) {
                    case 'atmospherePhysics':
                        currentPlanetData.ATMOSPHERE_PHYSICS_DATA = {
                            height: 30000.0,
                            density: 0.005,
                            curve: 10.0,
                            curveScale: {},
                            parachuteMultiplier: 1.0,
                            upperAtmosphere: 0.333,
                            heightDifficultyScale: {},
                            shockwaveIntensity: 1.0,
                            minHeatingVelocityMultiplier: 1.0
                        };
                        break;
                    case 'atmosphereVisuals':
                        currentPlanetData.ATMOSPHERE_VISUALS_DATA = {
                            GRADIENT: {
                                positionZ: 4000,
                                height: 45000.0,
                                texture: "Atmo_Default"
                            },
                            CLOUDS: {
                                texture: "None",
                                startHeight: 1200.0,
                                width: 40000.0,
                                height: 36000.0,
                                alpha: 0.1,
                                velocity: 2.0
                            },
                            FOG: {
                                keys: []
                            }
                        };
                        break;
                    case 'terrain':
                        currentPlanetData.TERRAIN_DATA = {
                            TERRAIN_TEXTURE_DATA: {
                                planetTexture: "Earth",
                                planetTextureCutout: 1.0,
                                surfaceTexture_A: "Blured",
                                surfaceTextureSize_A: {
                                    x: 20.0,
                                    y: 8.0
                                },
                                surfaceTexture_B: "None",
                                surfaceTextureSize_B: {
                                    x: -1.0,
                                    y: -1.0
                                },
                                terrainTexture_C: "Blured",
                                terrainTextureSize_C: {
                                    x: 100.0,
                                    y: 30.0
                                },
                                surfaceLayerSize: 40.0,
                                minFade: 0.0,
                                maxFade: 1.0,
                                shadowIntensity: 6.0,
                                shadowHeight: 15.0
                            },
                            terrainFormulaDifficulties: {},
                            textureFormula: [],
                            verticeSize: 4.0,
                            collider: true,
                            flatZones: [],
                            rocks: {}
                        };
                        break;
                    // ... å…¶ä»–æ¨¡å—çš„é»˜è®¤æ•°æ®
                }
                
                // æ˜¾ç¤ºç›¸åº”çš„ç¼–è¾‘ç•Œé¢
                await showModuleEditor(moduleName);
            }
        }

        // æ·»åŠ æ¨¡å—é¡ºåºå®šä¹‰
        const MODULE_ORDER = [
            'atmospherePhysics',
            'atmosphereVisuals',
            'terrain',
            'orbit',
            'postProcessing'
        ];

        // ä¿®æ”¹ showModuleEditor å‡½æ•°å¼€å¤´çš„å®¹å™¨åˆ›å»ºéƒ¨åˆ†


        // æ·»åŠ é›¾æ•ˆæœå…³é”®å¸§åˆ—è¡¨ç®¡ç†
        function updateFogKeysList(fogKeys) {
            const container = document.getElementById('fogKeysList');
            container.innerHTML = '';

            fogKeys.forEach((key, index) => {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'fog-key';
                keyDiv.innerHTML = `
                    <h6>å…³ï¿½ï¿½å¸§ ${index + 1}</h6>
                    <div class="form-group">
                        <label>é¢œè‰²ï¼š</label>
                        <input type="color" 
                               value="${rgbaToHex(key.color.r, key.color.g, key.color.b)}"
                               onchange="updateFogKeyColor(${index}, this.value)">
                        <input type="range" 
                               min="0" max="1" step="0.01" 
                               value="${key.color.a}"
                               onchange="updateFogKeyAlpha(${index}, this.value)">
                    </div>
                    <div class="form-group">
                        <label>è·ç¦»ï¼š</label>
                        <input type="number" 
                               value="${key.distance}"
                               onchange="updateFogKeyDistance(${index}, this.value)">
                    </div>
                    <button onclick="removeFogKey(${index})">åˆ é™¤</button>
                `;
                container.appendChild(keyDiv);
            });
        }

        // æ·»åŠ æ–°çš„é›¾æ•ˆæœå…³é”®å¸§
        function addFogKey() {
            if (!currentPlanetData.ATMOSPHERE_VISUALS_DATA) {
                currentPlanetData.ATMOSPHERE_VISUALS_DATA = {
                    FOG: { keys: [] }
                };
            }
            
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys.push({
                color: { r: 0.5, g: 0.5, b: 0.5, a: 0.5 },
                distance: 1000.0
            });
            
            updateFogKeysList(currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys);
        }

        // æ›´æ–°é›¾æ•ˆæœå…³é”®å¸§çš„é¢œè‰²
        function updateFogKeyColor(index, hexColor) {
            const keys = currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys;
            const rgb = hexToRgb(hexColor);
            keys[index].color.r = rgb.r;
            keys[index].color.g = rgb.g;
            keys[index].color.b = rgb.b;
        }

        // æ›´æ–°é›¾æ•ˆæœå…³é”®å¸§çš„é€æ˜åº¦
        function updateFogKeyAlpha(index, alpha) {
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys[index].color.a = parseFloat(alpha);
        }

        // æ›´æ–°é›¾æ•ˆæœå…³é”®å¸§çš„è·ç¦»
        function updateFogKeyDistance(index, distance) {
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys[index].distance = parseFloat(distance);
        }

        // åˆ é™¤é›¾æ•ˆæœå…³é”®å¸§
        function removeFogKey(index) {
            currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys.splice(index, 1);
            updateFogKeysList(currentPlanetData.ATMOSPHERE_VISUALS_DATA.FOG.keys);
        }

        // RGBAè½¬åå…­è¿›åˆ¶é¢œè‰²
        function rgbaToHex(r, g, b) {
            const toHex = (n) => {
                const hex = Math.round(n * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        // ä¿å­˜æ˜Ÿçƒæ•°æ®
        async function savePlanet() {
            if (!currentPlanetData || !currentDirHandle) return;

            // è·å–å½“å‰ç¼–è¾‘çš„æ˜Ÿçƒåç§°
            const planetName = document.getElementById('editingPlanetName').textContent;
            try {
                // æ›´æ–°åŸºç¡€æ•°æ®
                currentPlanetData.version = document.getElementById('planetVersion').value;
                currentPlanetData.BASE_DATA = {
                    radius: parseFloat(document.getElementById('planetRadius').value),
                    gravity: parseFloat(document.getElementById('planetGravity').value),
                    timewarpHeight: parseFloat(document.getElementById('timewarpHeight').value),
                    velocityArrowsHeight: parseFloat(document.getElementById('velocityArrowsHeight').value),
                    mapColor: {
                        r: parseInt(document.getElementById('mapColor').value.substr(1,2), 16) / 255,
                        g: parseInt(document.getElementById('mapColor').value.substr(3,2), 16) / 255,
                        b: parseInt(document.getElementById('mapColor').value.substr(5,2), 16) / 255,
                        a: parseFloat(document.getElementById('mapColorAlpha').value)
                    },
                    significant: document.getElementById('significant').checked,
                    rotateCamera: document.getElementById('rotateCamera').checked
                };
                // æ›´æ–°å¤§æ°”å±‚ç‰©ç†æ•°æ®
                if (document.getElementById('btnAtmospherePhysics').classList.contains('active')) {
                    currentPlanetData.ATMOSPHERE_PHYSICS_DATA = {
                        height: parseFloat(document.getElementById('atmoHeight').value),
                        density: parseFloat(document.getElementById('atmoDensity').value),
                        curve: parseFloat(document.getElementById('atmoCurve').value),
                        parachuteMultiplier: parseFloat(document.getElementById('atmoParachuteMultiplier').value),
                        upperAtmosphere: parseFloat(document.getElementById('atmoUpperAtmosphere').value),
                        shockwaveIntensity: parseFloat(document.getElementById('atmoShockwaveIntensity').value),
                        minHeatingVelocityMultiplier: parseFloat(document.getElementById('atmoMinHeatingVelocityMultiplier').value)
                    };
                }
                // æ›´æ–°å¤§æ°”å±‚è§†è§‰æ•°æ®
                if (document.getElementById('btnAtmosphereVisuals').classList.contains('active')) {
                    currentPlanetData.ATMOSPHERE_VISUALS_DATA = {
                        GRADIENT: {
                            positionZ: parseFloat(document.getElementById('atmoGradientPositionZ').value),
                            height: parseFloat(document.getElementById('atmoGradientHeight').value),
                            texture: document.getElementById('atmoGradientTexture').value
                        },
                        CLOUDS: {
                            texture: document.getElementById('atmoCloudTexture').value,
                            startHeight: parseFloat(document.getElementById('atmoCloudStartHeight').value),
                            width: parseFloat(document.getElementById('atmoCloudWidth').value),
                            height: parseFloat(document.getElementById('atmoCloudHeight').value),
                            alpha: parseFloat(document.getElementById('atmoCloudAlpha').value),
                            velocity: parseFloat(document.getElementById('atmoCloudVelocity').value)
                        },
                        FOG: {
                            keys: currentPlanetData.ATMOSPHERE_VISUALS_DATA?.FOG?.keys || []
                        }
                    };
                }
                // æ›´æ–°åœ°å½¢æ•°æ®
                if (document.getElementById('btnTerrain').classList.contains('active')) {
                    currentPlanetData.TERRAIN_DATA = {
                        TERRAIN_TEXTURE_DATA: {
                            planetTexture: document.getElementById('planetTexture').value,
                            planetTextureCutout: parseFloat(document.getElementById('planetTextureCutout').value),
                            surfaceTexture_A: document.getElementById('surfaceTexture_A').value,
                            surfaceTextureSize_A: {
                                x: parseFloat(document.getElementById('surfaceTextureSize_A_x').value),
                                y: parseFloat(document.getElementById('surfaceTextureSize_A_y').value)
                            },
                            surfaceTexture_B: document.getElementById('surfaceTexture_B').value,
                            surfaceTextureSize_B: {
                                x: parseFloat(document.getElementById('surfaceTextureSize_B_x').value),
                                y: parseFloat(document.getElementById('surfaceTextureSize_B_y').value)
                            },
                            terrainTexture_C: document.getElementById('terrainTexture_C').value,
                            terrainTextureSize_C: {
                                x: parseFloat(document.getElementById('terrainTextureSize_C_x').value),
                                y: parseFloat(document.getElementById('terrainTextureSize_C_y').value)
                            },
                            surfaceLayerSize: parseFloat(document.getElementById('surfaceLayerSize').value),
                            minFade: parseFloat(document.getElementById('minFade').value),
                            maxFade: parseFloat(document.getElementById('maxFade').value),
                            shadowIntensity: parseFloat(document.getElementById('shadowIntensity').value),
                            shadowHeight: parseFloat(document.getElementById('shadowHeight').value)
                        },
                        terrainFormulaDifficulties: currentPlanetData.TERRAIN_DATA?.terrainFormulaDifficulties || {},
                        textureFormula: currentPlanetData.TERRAIN_DATA?.textureFormula || [],
                        verticeSize: parseFloat(document.getElementById('verticeSize').value),
                        collider: document.getElementById('terrainCollider').checked,
                        flatZones: currentPlanetData.TERRAIN_DATA?.flatZones || [],
                        rocks: currentPlanetData.TERRAIN_DATA?.rocks || {}
                    };
                }

                // æ›´æ–°æˆå°±æ•°æ®
                currentPlanetData.ACHIEVEMENT_DATA = {
                    Landed: document.getElementById('achieveLanded').checked,
                    Takeoff: document.getElementById('achieveTakeoff').checked,
                    Atmosphere: document.getElementById('achieveAtmosphere').checked,
                    Orbit: document.getElementById('achieveOrbit').checked,
                    Crash: document.getElementById('achieveCrash').checked
                };
                // æ›´æ–°åœ°æ ‡æ•°æ®
                const landmarksList = document.getElementById('landmarksList');
                const landmarks = [];
                landmarksList.querySelectorAll('.landmark-item').forEach(item => {
                    landmarks.push({
                        name: item.querySelector('input[type="text"]').value,
                        angle: parseFloat(item.querySelector('input[type="number"]').value)
                    });
                });
                currentPlanetData.LANDMARKS = landmarks;
                // æ›´æ–°è½¨é“æ•°æ®
                if (document.getElementById('btnOrbit').classList.contains('active')) {
                    currentPlanetData.ORBIT_DATA = {
                        parent: document.getElementById('parent').value,
                        semiMajorAxis: parseFloat(document.getElementById('semiMajorAxis').value),
                        eccentricity: parseFloat(document.getElementById('eccentricity').value),
                        argumentOfPeriapsis: parseFloat(document.getElementById('argumentOfPeriapsis').value),
                        direction: parseFloat(document.getElementById('direction').value),
                        multiplierSOI: parseFloat(document.getElementById('multiplierSOI').value)
                    };
                }

                // æ›´æ–°åæœŸå¤„ç†æ•°æ®
                if (document.getElementById('btnPostProcessing').classList.contains('active')) {
                    currentPlanetData.POST_PROCESSING = {
                        keys: []
                    };

                    // è·å–æ‰€æœ‰å…³é”®å¸§ç¼–è¾‘å™¨
                    const keyframeEditors = document.querySelectorAll('.keyframe-editor');
                    keyframeEditors.forEach(editor => {
                        const inputs = editor.querySelectorAll('input[type="number"]');
                        const keyframe = {
                            height: parseFloat(inputs[0].value),
                            shadowIntensity: parseFloat(inputs[1].value), 
                            starIntensity: parseFloat(inputs[2].value),
                            hueShift: parseFloat(inputs[3].value),
                            saturation: parseFloat(inputs[4].value),
                            contrast: parseFloat(inputs[5].value),
                            red: parseFloat(inputs[6].value),
                            green: parseFloat(inputs[7].value),
                            blue: parseFloat(inputs[8].value)
                        };
                        currentPlanetData.POST_PROCESSING.keys.push(keyframe);
                    });

                    // æŒ‰é«˜åº¦æ’åº
                    currentPlanetData.POST_PROCESSING.keys.sort((a, b) => a.height - b.height);
                }

                // ä¿å­˜åˆ°æ–‡ä»¶
                const planetDataDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                await savePlanetToFile(planetDataDir, planetName, currentPlanetData);
                alert('æ˜Ÿçƒæ•°æ®å·²ä¿å­˜æˆåŠŸï¼');

            } catch (err) {
                console.error('ä¿å­˜æ˜Ÿçƒå¤±è´¥:', err);
                alert('ä¿å­˜æ˜Ÿçƒå¤±è´¥!é”™è¯¯ä¿¡æ¯: ' + err.message);
            }
        }

        // åå…­è¿›åˆ¶é¢œè‰²è½¬RGBA
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return { r, g, b, a: alpha };
        }

        // æ·»åŠ è¿™ä¸ªå‡½æ•°æ¥åŠ è½½æ‰€æœ‰æ˜Ÿçƒ
        async function loadPlanets(dirHandle) {
            try {
                const planetDataDir = await dirHandle.getDirectoryHandle('Planet Data');
                // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                document.getElementById('planetsList').innerHTML = '';
                
                // éå†Planet Dataç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
                for await (const entry of planetDataDir.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                        const file = await entry.getFile();
                        const content = await file.text();
                        const planetData = JSON.parse(content);
                        const planetName = entry.name.replace('.txt', '');
                        addPlanetToList(planetName, planetData);
                    }
                }
            } catch (err) {
                console.error('åŠ è½½æ˜Ÿçƒåˆ—è¡¨å¤±è´¥:', err);
            }
        }

        // æ›´æ–°åœ°å½¢çº¹ç†æ•°æ®
        function updateTerrainTexture(field, value) {
            if (!currentPlanetData?.TERRAIN_DATA?.TERRAIN_TEXTURE_DATA) return;
            
            const numValue = field.includes('Cutout') || field.includes('Fade') ? 
                parseFloat(value) : value;
            
            if (typeof numValue === 'number' && isNaN(numValue)) return;
            
            currentPlanetData.TERRAIN_DATA.TERRAIN_TEXTURE_DATA[field] = numValue;
        }

        // æ›´æ–°çº¹ç†å°ºå¯¸
        function updateTerrainTextureSize(type, axis, value) {
            if (!currentPlanetData?.TERRAIN_DATA?.TERRAIN_TEXTURE_DATA) return;
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return;
            
            const field = type === 'C' ? 
                `terrainTextureSize_C` : 
                `surfaceTextureSize_${type}`;
            
            currentPlanetData.TERRAIN_DATA.TERRAIN_TEXTURE_DATA[field][axis] = numValue;
        }

        // æ›´æ–°åœ°å½¢æ•°æ®
        function updateTerrainData(field, value) {
            if (!currentPlanetData?.TERRAIN_DATA) return;
            
            if (field === 'collider') {
                currentPlanetData.TERRAIN_DATA[field] = value;
            } else {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    currentPlanetData.TERRAIN_DATA[field] = numValue;
                }
            }}

        // æ›´æ–°å…¬å¼åˆ—è¡¨æ˜¾ç¤º
        function updateFormulaList(difficulty, formulas) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            formulas.forEach((formula, index) => {
                const formulaDiv = document.createElement('div');
                formulaDiv.className = 'formula-item';
                formulaDiv.innerHTML = `
                    <input type="text" value="${formula}" 
                           onchange="updateFormula('${difficulty}', ${index}, this.value)">
                    <button onclick="removeFormula('${difficulty}', ${index})">åˆ é™¤</button>
                `;
                container.appendChild(formulaDiv);
            });
        }

        // æ·»åŠ æ–°å…¬å¼
        function addTerrainFormula(difficulty) {
            if (!currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties = {};
            }
            
            if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = [];
            }
            
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].push(
                "OUTPUT = AddHeightMap(Perlin,1000, 10)"
            );
            
            updateFormulaList(
                difficulty, 
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]
            );
        }

        // æ›´æ–°å…¬å¼
        function updateFormula(difficulty, index, value) {
            if (!currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties?.[difficulty]) return;
            
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty][index] = value;
        }

        // åˆ é™¤å…¬å¼
        function removeFormula(difficulty, index) {
            if (!currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties?.[difficulty]) return;
            
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].splice(index, 1);
            updateFormulaList(
                difficulty, 
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]
            );
        }

        // æ·»åŠ æ–°çš„CSSæ ·å¼
        const additionalStyle = document.createElement('style');
        additionalStyle.textContent = `
            .formula-editor {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
            }

            .formula-editor select,
            .formula-editor input {
                padding: 5px;
                border: 1px solid #ced4da;
                border-radius: 4px;
            }

            .formula-editor .heightmap-select {
                width: 150px;
            }

            .formula-editor .scale-input,
            .formula-editor .height-input {
                width: 100px;
            }

            .formula-editor .curve-select {
                width: 120px;
            }

            .flat-zone-editor {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .flat-zone-editor input {
                width: 100px;
            }

            #flatZonesList,
            #textureFormulas {
                margin-top: 10px;
            }

            .formula-item,
            .flat-zone-item {
                display: flex;
                gap: 10px;
                align-items: center;
                margin-bottom: 5px;
                padding: 5px;
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 4px;
            }

            .formula-item button,
            .flat-zone-item button {
                padding: 2px 8px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }
        `;

        document.head.appendChild(additionalStyle);

        // æ·»åŠ æ•°æ®å¤„ç†å‡½æ•°
        function updateFormulaList(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] || [];
            formulas.forEach((formula, index) => {
                const item = document.createElement('div');
                item.className = 'formula-item';
                item.innerHTML = `
                    <span>${formula}</span>
                    <button onclick="removeFormula('${difficulty}', ${index})">åˆ é™¤</button>
                `;
                container.appendChild(item);
            });
        }

        function removeFormula(difficulty, index) {
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].splice(index, 1);
            updateFormulaList(difficulty);
        }

        function updateTextureFormulaList() {
            const container = document.getElementById('textureFormulas');
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.textureFormula || [];
            formulas.forEach((formula, index) => {
                const item = document.createElement('div');
                item.className = 'formula-item';
                item.innerHTML = `
                    <span>${formula}</span>
                    <button onclick="removeTextureFormula(${index})">åˆ é™¤</button>
                `;
                container.appendChild(item);
            });
        }

        function removeTextureFormula(index) {
            currentPlanetData.TERRAIN_DATA.textureFormula.splice(index, 1);
            updateTextureFormulaList();
        }

        function updateFlatZonesList() {
            const container = document.getElementById('flatZonesList');
            container.innerHTML = '';
            
            currentPlanetData.TERRAIN_DATA.flatZones.forEach((zone, index) => {
                const item = document.createElement('div');
                item.className = 'flat-zone-item';
                item.innerHTML = `
                    <span>é«˜åº¦: ${zone.height}, è§’åº¦: ${zone.angle}, å®½åº¦: ${zone.width}, è¿‡æ¸¡: ${zone.transition}</span>
                    <button onclick="removeFlatZone(${index})">åˆ é™¤</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFlatZone(index) {
            currentPlanetData.TERRAIN_DATA.flatZones.splice(index, 1);
            updateFlatZonesList();
        }

        function updateRocksForm() {
            const rocks = currentPlanetData.TERRAIN_DATA.rocks;
            if (!rocks) return;

            document.getElementById('rockType').value = rocks.rockType;
            document.getElementById('rockDensity').value = rocks.rockDensity;
            document.getElementById('rockMinSize').value = rocks.minSize;
            document.getElementById('rockMaxSize').value = rocks.maxSize;
            document.getElementById('rockPowerCurve').value = rocks.powerCurve;
            document.getElementById('rockMaxAngle').value = rocks.maxAngle;
        }

        // æ·»åŠ å²©çŸ³è®¾ç½®çš„æ›´æ–°å‡½æ•°
        function updateRockSetting(field, value) {
            if (!currentPlanetData.TERRAIN_DATA.rocks) return;
            
            if (field === 'rockType') {
                currentPlanetData.TERRAIN_DATA.rocks[field] = value;
            } else {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    currentPlanetData.TERRAIN_DATA.rocks[field] = numValue;
                }
            }
        }

        // ä¿®æ”¹ showModuleEditor å‡½æ•°ä¸­çš„æ•°æ®åŠ è½½éƒ¨åˆ†
        if (currentPlanetData.TERRAIN_DATA) {
            const terrainData = currentPlanetData.TERRAIN_DATA;
            
            // ... ä¹‹å‰çš„çº¹ç†æ•°æ®åŠ è½½ä»£ç  ...

            // åŠ è½½åœ°å½¢å…¬å¼
            Object.keys(terrainData.terrainFormulaDifficulties || {}).forEach(difficulty => {
                updateFormulaList(difficulty);
            });

            // åŠ è½½çº¹ç†å…¬å¼
            if (terrainData.textureFormula) {
                updateTextureFormulaList();
            }

            // åŠ è½½å¹³å¦åŒºåŸŸ
            if (terrainData.flatZones && terrainData.flatZones.length > 0) {
                document.getElementById('flatZonesContainer').style.display = 'block';
                updateFlatZonesList();
            }

            // åŠ è½½å²©çŸ³è®¾ç½®
            if (terrainData.rocks) {
                document.getElementById('rocksContainer').style.display = 'block';
                updateRocksForm();
            }
        }

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function addEventListeners() {
            // å²©çŸ³è®¾ç½®çš„äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('rockType')?.addEventListener('change', e => 
                updateRockSetting('rockType', e.target.value));
            document.getElementById('rockDensity')?.addEventListener('input', e => 
                updateRockSetting('rockDensity', e.target.value));
            document.getElementById('rockMinSize')?.addEventListener('input', e => 
                updateRockSetting('minSize', e.target.value));
            document.getElementById('rockMaxSize')?.addEventListener('input', e => 
                updateRockSetting('maxSize', e.target.value));
            document.getElementById('rockPowerCurve')?.addEventListener('input', e => 
                updateRockSetting('powerCurve', e.target.value));
            document.getElementById('rockMaxAngle')?.addEventListener('input', e => 
                updateRockSetting('maxAngle', e.target.value));
        }

        // åœ¨showModuleEditorå‡½æ•°æœ«å°¾è°ƒï¿½ï¿½ï¿½
        addEventListeners();

        // ä¿®æ”¹å…¬å¼æ·»åŠ å‡½æ•°
        function addFormula(difficulty) {
            const container = document.querySelector(`#${difficulty.toLowerCase()}Formulas`).previousElementSibling;
            const outputType = container.querySelector('.output-type').value;
            const heightmap = container.querySelector('.heightmap-select').value;
            const scale = parseFloat(container.querySelector('.scale-input').value);
            const height = parseFloat(container.querySelector('.height-input').value);
            const mask = container.querySelector('.mask-select').value;
            const curve = container.querySelector('.curve-select').value;

            // æ ¼å¼åŒ–æ•°å­—ï¼Œä¿æŒç²¾ç¡®åº¦
            const formattedScale = scale.toString().includes('e') ? 
                scale.toFixed(9) : scale.toString();

            // æ„å»ºå…¬å¼å­—ç¬¦ä¸²
            let formula = `${outputType} = AddHeightMap( ${heightmap}, ${formattedScale}, ${height}`;
            if (curve) formula += `, ${curve}`;
            if (mask) formula += `, ${mask}`;
            formula += ')';

            if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty]) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = [];
            }
            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty].push(formula);
            updateFormulaList(difficulty);
        }

        // ä¿®æ”¹å…¬å¼åˆ—è¡¨æ›´æ–°å‡½æ•°
        function updateFormulaList(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] || [];
            formulas.forEach((formula, index) => {
                const item = document.createElement('div');
                item.className = 'formula-item';
                
                // è§£æå…¬å¼ä»¥ä¾¿ç¼–è¾‘
                const parsed = parseFormula(formula);
                
                item.innerHTML = `
                    <div class="formula-display">${formula}</div>
                    <div class="formula-controls">
                        <button onclick="editFormula('${difficulty}', ${index})">ç¼–è¾‘</button>
                        <button onclick="moveFormula('${difficulty}', ${index}, -1)">â†‘</button>
                        <button onclick="moveFormula('${difficulty}', ${index}, 1)">â†“</button>
                        <button onclick="removeFormula('${difficulty}', ${index})">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // æ·»åŠ å…¬å¼è§£æå‡½æ•°
        function parseFormula(formula) {
            try {
                // åŒ¹é…æ ¼å¼: OUTPUT = AddHeightMap( Phobos, 6283.18530718, 300, Curve4, M)
                const parts = formula.trim().split('=');
                const outputType = parts[0].trim();
                
                // è§£æ AddHeightMap çš„å‚æ•°
                const params = parts[1].match(/AddHeightMap\(\s*([^,]+),\s*([^,]+),\s*([^,\)]+)(?:,\s*([^,\)]+))?(?:,\s*([^,\)]+))?\)/);
                
                if (params) {
                    return {
                        outputType: outputType,
                        heightmap: params[1].trim(),
                        scale: params[2].trim(),
                        height: params[3].trim(),
                        curve: params[4]?.trim() || '',
                        mask: params[5]?.trim() || ''
                    };
                }
            } catch (e) {
                console.error('å…¬å¼è§£æé”™è¯¯:', e);
            }
            
            // é»˜è®¤å€¼
            return {
                outputType: 'OUTPUT',
                heightmap: 'Perlin',
                scale: '6283.18530718',
                height: '1',
                curve: '',
                mask: ''
            };
        }

        // æ·»åŠ å…¬å¼ç¼–è¾‘å‡½æ•°
        function editFormula(difficulty, index) {
            const formula = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty][index];
            const parsed = parseFormula(formula);
            if (!parsed) return;

            const editor = document.querySelector(`#${difficulty.toLowerCase()}Formulas`).previousElementSibling;
            editor.querySelector('.output-type').value = parsed.outputType;
            editor.querySelector('.heightmap-select').value = parsed.heightmap;
            editor.querySelector('.scale-input').value = parsed.scale;
            editor.querySelector('.height-input').value = parsed.height;
            editor.querySelector('.curve-select').value = parsed.curve;
            editor.querySelector('.mask-select').value = parsed.mask;

            // åˆ é™¤åŸå…¬å¼
            removeFormula(difficulty, index);
        }

        // æ·»åŠ å…¬å¼ç§»åŠ¨å‡½æ•°
        function moveFormula(difficulty, index, direction) {
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty];
            if (index + direction >= 0 && index + direction < formulas.length) {
                const temp = formulas[index];
                formulas[index] = formulas[index + direction];
                formulas[index + direction] = temp;
                updateFormulaList(difficulty);
            }
        }

        // æ·»åŠ ç›¸åº”çš„CSSæ ·å¼
        const formulaStyle = document.createElement('style');
        formulaStyle.textContent = `
            .formula-editor {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 10px;
            }

            .formula-inputs {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .formula-type-select {
                margin-bottom: 10px;
            }

            .formula-item {
                background: white;
                padding: 10px;
                margin-bottom: 5px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .formula-display {
                font-family: monospace;
                white-space: pre;
            }

            .formula-controls {
                display: flex;
                gap: 5px;
            }

            .formula-controls button {
                padding: 2px 8px;
                font-size: 12px;
            }
        `;

        document.head.appendChild(formulaStyle);

        // ä¿®æ”¹å…¬å¼æ·»åŠ å‡½æ•°
        function createFormulaEditor(formula = null) {
            const editor = document.createElement('div');
            editor.className = 'formula-editor';
            
            const parsed = parseFormula(formula || '');

            // ä½¿ç”¨å·²æœ‰çš„ heightmaps æ•°ç»„ç”Ÿæˆé€‰é¡¹
            const heightmapOptions = heightmaps.map(name => 
                `<option value="${name}" ${parsed.heightmap === name ? 'selected' : ''}>${name}</option>`
            ).join('');

            editor.innerHTML = `
                <select class="output-type">
                    <option value="OUTPUT" ${parsed.outputType === 'OUTPUT' ? 'selected' : ''}>OUTPUT</option>
                    <option value="M" ${parsed.outputType === 'M' ? 'selected' : ''}>M</option>
                </select>
                =
                AddHeightMap(
                <select class="heightmap-select">
                    ${heightmapOptions}
                </select>
                ,
                <input type="number" class="scale-input" value="${parsed.scale}" step="0.00000001">
                ,
                <input type="number" class="height-input" value="${parsed.height}" step="0.1">
                ,
                <select class="curve-select">
                    <option value="" ${!parsed.curve ? 'selected' : ''}>æ— æ›²çº¿</option>
                    ${Array.from({length: 7}, (_, i) => i + 1).map(num => 
                        `<option value="Curve${num}" ${parsed.curve === `Curve${num}` ? 'selected' : ''}>Curve${num}</option>`
                    ).join('')}
                    <option value="null" ${parsed.curve === 'null' ? 'selected' : ''}>null</option>
                </select>
                ,
                <select class="mask-select">
                    <option value="" ${!parsed.mask ? 'selected' : ''}>æ— é®ç½©</option>
                    <option value="M" ${parsed.mask === 'M' ? 'selected' : ''}>M</option>
                    <option value="null" ${parsed.mask === 'null' ? 'selected' : ''}>null</option>
                </select>
                )
                <button class="delete-formula">Ã—</button>
            `;

            // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
            editor.querySelector('.delete-formula').onclick = () => {
                editor.remove();
                updateFormulas();
            };

            // æ·»åŠ æ›´æ”¹äº‹ä»¶ç›‘å¬
            editor.querySelectorAll('select, input').forEach(element => {
                element.onchange = updateFormulas;
            });

            return editor;
        }

        // æ›´æ–°å…¬å¼åˆ—è¡¨çš„å‡½æ•°
        function updateFormulas() {
            // æ›´æ–°åœ°å½¢å…¬å¼
            ['Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
                if (container) {
                    const formulas = Array.from(container.querySelectorAll('.formula-editor')).map(editor => {
                        const outputType = editor.querySelector('.output-type').value;
                        const heightmap = editor.querySelector('.heightmap-select').value;
                        const scale = editor.querySelector('.scale-input').value;
                        const height = editor.querySelector('.height-input').value;
                        const curve = editor.querySelector('.curve-select').value;
                        const mask = editor.querySelector('.mask-select').value;

                        let formula = `${outputType} = AddHeightMap( ${heightmap}, ${scale}, ${height}`;
                        if (curve) formula += `, ${curve}`;
                        if (mask) formula += `, ${mask}`;
                        formula += ')';

                        return formula;
                    });

                    if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties) {
                        currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties = {};
                    }
                    currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = formulas;
                }
            });

            // æ›´æ–°çº¹ç†å…¬å¼
            const textureContainer = document.getElementById('textureFormulas');
            if (textureContainer) {
                const formulas = Array.from(textureContainer.querySelectorAll('.formula-editor')).map(editor => {
                    // ä½¿ç”¨ç›¸åŒçš„å…¬å¼æ„å»ºé€»è¾‘
                    const outputType = editor.querySelector('.output-type').value;
                    const heightmap = editor.querySelector('.heightmap-select').value;
                    const scale = editor.querySelector('.scale-input').value;
                    const height = editor.querySelector('.height-input').value;
                    const curve = editor.querySelector('.curve-select').value;
                    const mask = editor.querySelector('.mask-select').value;

                    let formula = `${outputType} = AddHeightMap( ${heightmap}, ${scale}, ${height}`;
                    if (curve) formula += `, ${curve}`;
                    if (mask) formula += `, ${mask}`;
                    formula += ')';

                    return formula;
                });
                currentPlanetData.TERRAIN_DATA.textureFormula = formulas;
            }
        }

        function updateTextureFormulaList() {
            const container = document.getElementById('textureFormulas');
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.textureFormula || [];
            formulas.forEach(formula => {
                container.appendChild(createFormulaEditor(formula));
            });
        }

        function addFormulaEditor(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.appendChild(createFormulaEditor());
        }

        function addTextureFormulaEditor() {
            const container = document.getElementById('textureFormulas');
            container.appendChild(createFormulaEditor());
        }

        // ä¿®æ”¹å¹³å¦åŒºåŸŸå’Œå²©çŸ³è®¾ï¿½ï¿½çš„åˆ‡æ¢å‡½æ•°
        function toggleFlatZones() {
            const container = document.getElementById('flatZonesContainer');
            const button = document.getElementById('toggleFlatZonesBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'ç¦ç”¨å¹³å¦åŒºåŸŸ';
                if (!currentPlanetData.TERRAIN_DATA.flatZones) {
                    currentPlanetData.TERRAIN_DATA.flatZones = [];
                }
            } else {
                container.style.display = 'none';
                button.textContent = 'å¯ç”¨å¹³å¦åŒºåŸŸ';
                currentPlanetData.TERRAIN_DATA.flatZones = [];
            }
            updateFlatZonesList();
        }

        function toggleRocks() {
            const container = document.getElementById('rocksContainer');
            const button = document.getElementById('toggleRocksBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'ç¦ç”¨å²©çŸ³';
                if (!currentPlanetData.TERRAIN_DATA.rocks) {
                    currentPlanetData.TERRAIN_DATA.rocks = {
                        rockType: 'Rock Square',
                        rockDensity: 0.5,
                        minSize: 1,
                        maxSize: 2,
                        powerCurve: 1,
                        maxAngle: 45
                    };
                }
                updateRocksForm();
            } else {
                container.style.display = 'none';
                button.textContent = 'å¯ç”¨å²©çŸ³';
                delete currentPlanetData.TERRAIN_DATA.rocks;
            }
        }

        // ä¿®æ”¹å…¬å¼æ›´æ–°å‡½æ•°
        function updateFormulaFromEditor(button) {
            const editor = button.parentElement;
            const outputType = editor.querySelector('.output-type').value;
            const heightmap = editor.querySelector('.heightmap-select').value;
            const scale = editor.querySelector('.scale-input').value;
            const height = editor.querySelector('.height-input').value;
            const curve = editor.querySelector('.curve-select').value;
            const mask = editor.querySelector('.mask-select').value;

            let formula = `${outputType} = ${heightmap}(${scale})`;
            if (height) formula += ` * ${height}`;
            if (curve) formula += ` * ${curve}`;
            if (mask) formula += ` * ${mask}`;

            // æ›´æ–°å…¬å¼åˆ—è¡¨
            updateFormulas();
        }

        async function getPlanetsList() {
            let planets = []; // é»˜è®¤åŒ…å«å¤ªé˜³
            
            // è·å–æ‹“å±•åŒ…æ–‡ä»¶å¤¹ä¸­çš„æ˜Ÿçƒåˆ—è¡¨
            if (extensionDirHandle) {
                try {
                    const planetDir = await extensionDirHandle.getDirectoryHandle('Planet Data');
                    for await (const entry of planetDir.values()) {
                        if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                            planets.push(entry.name.replace('.txt', ''));
                        }
                    }
                } catch (err) {
                    console.error('è¯»å–æ‹“å±•åŒ…æ˜Ÿçƒç›®å½•å¤±è´¥:', err);
                }
            }
            
            // ä»å½“å‰ç›®å½•è·å–æ˜Ÿçƒåˆ—è¡¨ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
            if (currentDirHandle) {
                try {
                    const planetDir = await currentDirHandle.getDirectoryHandle('Planet Data');
                    for await (const entry of planetDir.values()) {
                        if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                            const planetName = entry.name.replace('.txt', '');
                            // é¿å…é‡å¤æ·»åŠ 
                            if (!planets.includes(planetName)) {
                                planets.push(planetName);
                            }
                        }
                    }
                } catch (err) {
                    console.error('è¯»å–å½“å‰æ˜Ÿçƒç›®å½•å¤±è´¥:', err);
                }
            }
            
            return planets;
        }
        // ä¿®æ”¹åçš„ showModuleEditor å‡½æ•°
        async function showModuleEditor(moduleName) {
            console.log(`æ˜¾ç¤ºæ¨¡å—ç¼–è¾‘å™¨: ${moduleName}`);
            let moduleContainer = document.getElementById(`${moduleName}Container`);
            if (!moduleContainer) {
                moduleContainer = document.createElement('div');
                moduleContainer.id = `${moduleName}Container`;
                moduleContainer.className = 'module-container';
                document.getElementById('moduleContent').appendChild(moduleContainer);
            }

            if (moduleName === 'atmospherePhysics') {
                // åˆ›å»ºæ‰€æœ‰å…ƒç´ 
                const section = document.createElement('div');
                section.className = 'module-section';
                
                const title = document.createElement('h4');
                title.textContent = 'å¤§æ°”å±‚ç‰©ç†å‚æ•°';
                section.appendChild(title);

                // å®šä¹‰è¦åˆ›å»ºçš„è¾“å…¥å­—æ®µ
                const fields = [
                    { id: 'atmoHeight', label: 'å¤§æ°”å±‚é«˜åº¦ (ç±³):', step: '1000' },
                    { id: 'atmoDensity', label: 'å¯†åº¦:', step: '0.001' },
                    { id: 'atmoCurve', label: 'æ›²çº¿:', step: '0.1' },
                    { id: 'atmoParachuteMultiplier', label: 'é™è½ä¼ç³»æ•°:', step: '0.1' },
                    { id: 'atmoUpperAtmosphere', label: 'ä¸Šå±‚å¤§æ°”:', step: '0.001' },
                    { id: 'atmoShockwaveIntensity', label: 'å†²å‡»æ³¢å¼ºåº¦:', step: '0.1' },
                    { id: 'atmoMinHeatingVelocityMultiplier', label: 'æœ€å°åŠ çƒ­é€Ÿåº¦ç³»æ•°:', step: '0.1' }
                ];

                // åˆ›å»ºæ¯ä¸ªï¿½ï¿½å…¥å­—æ®µ
                fields.forEach(field => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';

                    const label = document.createElement('label');
                    label.textContent = field.label;
                    formGroup.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = field.id;
                    input.step = field.step;
                    
                    // å¦‚æœæœ‰æ•°æ®ï¼Œç«‹å³è®¾ç½®å€¼
                    if (currentPlanetData?.ATMOSPHERE_PHYSICS_DATA) {
                        const dataKey = field.id.replace('atmo', '').charAt(0).toLowerCase() + 
                                      field.id.replace('atmo', '').slice(1);
                        input.value = currentPlanetData.ATMOSPHERE_PHYSICS_DATA[dataKey] || '';
                    }

                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    input.addEventListener('input', e => {
                        const dataKey = field.id.replace('atmo', '').charAt(0).toLowerCase() + 
                                      field.id.replace('atmo', '').slice(1);
                        updatePhysicsData(dataKey, parseFloat(e.target.value));
                    });

                    formGroup.appendChild(input);
                    section.appendChild(formGroup);
                });

                // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°åˆ›å»ºçš„å…ƒç´ 
                moduleContainer.innerHTML = '';
                moduleContainer.appendChild(section);
            }
            else if (moduleName === 'atmosphereVisuals') {
                // å®šä¹‰å¯ç”¨çš„çº¹ç†åˆ—è¡¨
                const defaultTextures = [
                    'None', 'Atmo_Earth', 'Earth_Clouds', 'Atmo_Europa',
                    'Atmo_Jupiter', 'Atmo_Mars', 'Atmo_Sun', 'Atmo_Venus'
                ];

                // è·å–è‡ªå®šä¹‰çº¹ç†
                let customTextures = [];
                if (currentDirHandle) {
                    try {
                        const textureDir = await currentDirHandle.getDirectoryHandle('Texture Data');
                        for await (const entry of textureDir.values()) {
                            if (entry.kind === 'file' && entry.name.match(/\.(png|jpg|jpeg)$/i)) {
                                customTextures.push(entry.name.replace(/\.[^/.]+$/, ''));
                            }
                        }
                    } catch (err) {
                        console.error('è¯»å–çº¹ç†ç›®å½•å¤±è´¥:', err);
                    }
                }

                // åˆå¹¶çº¹ç†åˆ—è¡¨
                const allTextures = [...defaultTextures, ...customTextures];

                // åˆ›å»ºä¸»å®¹å™¨
                const section = document.createElement('div');
                section.className = 'module-section';

                // åˆ›å»ºæ ‡é¢˜
                const title = document.createElement('h4');
                title.textContent = 'å¤§æ°”å±‚è§†è§‰æ•ˆæœ';
                section.appendChild(title);

                // åˆ›å»ºæ¸å˜è®¾ç½®ç»„
                const gradientGroup = document.createElement('div');
                gradientGroup.className = 'form-group';
                
                const gradientTitle = document.createElement('h5');
                gradientTitle.textContent = 'æ¸å˜';
                gradientGroup.appendChild(gradientTitle);

                // åˆ›å»ºæ¸å˜è®¾ç½®å­—æ®µ
                const gradientFields = [
                    { id: 'atmoGradientPositionZ', label: 'ä½ç½® Z:', type: 'number', step: '0.1' },
                    { id: 'atmoGradientHeight', label: 'é«˜åº¦:', type: 'number', step: '0.1' },
                    { id: 'atmoGradientTexture', label: 'çº¹ç†:', type: 'select', options: allTextures }
                ];

                gradientFields.forEach(field => {
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    gradientGroup.appendChild(label);

                    if (field.type === 'select') {
                        const select = document.createElement('select');
                        select.id = field.id;
                        field.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            select.appendChild(opt);
                        });
                        select.addEventListener('change', e => {
                            updateVisualsData('gradient', field.id.replace('atmoGradient', '').toLowerCase(), e.target.value);
                        });
                        gradientGroup.appendChild(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = field.type;
                        input.id = field.id;
                        input.step = field.step;
                        input.addEventListener('input', e => {
                            updateVisualsData('gradient', field.id.replace('atmoGradient', '').toLowerCase(), e.target.value);
                        });
                        gradientGroup.appendChild(input);
                    }
                });

                section.appendChild(gradientGroup);

                // åˆ›å»ºäº‘å±‚è®¾ç½®ç»„
                const cloudGroup = document.createElement('div');
                cloudGroup.className = 'form-group';

                const cloudTitle = document.createElement('h5');
                cloudTitle.textContent = 'äº‘å±‚';
                cloudGroup.appendChild(cloudTitle);

                // åˆ›å»ºäº‘å±‚è®¾ç½®å­—æ®µ
                const cloudFields = [
                    { id: 'atmoCloudTexture', label: 'çº¹ç†:', type: 'select', options: allTextures },
                    { id: 'atmoCloudStartHeight', label: 'èµ·å§‹é«˜åº¦:', type: 'number', step: '100' },
                    { id: 'atmoCloudWidth', label: 'å®½åº¦:', type: 'number', step: '100' },
                    { id: 'atmoCloudHeight', label: 'é«˜åº¦:', type: 'number', step: '100' },
                    { id: 'atmoCloudAlpha', label: 'é€æ˜åº¦:', type: 'number', step: '0.01', min: '0', max: '1' },
                    { id: 'atmoCloudVelocity', label: 'é€Ÿåº¦:', type: 'number', step: '0.1' }
                ];

                cloudFields.forEach(field => {
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    cloudGroup.appendChild(label);

                    if (field.type === 'select') {
                        const select = document.createElement('select');
                        select.id = field.id;
                        field.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            select.appendChild(opt);
                        });
                        select.addEventListener('change', e => {
                            updateVisualsData('clouds', field.id.replace('atmoCloud', '').toLowerCase(), e.target.value);
                        });
                        cloudGroup.appendChild(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = field.type;
                        input.id = field.id;
                        input.step = field.step;
                        if (field.min) input.min = field.min;
                        if (field.max) input.max = field.max;
                        input.addEventListener('input', e => {
                            updateVisualsData('clouds', field.id.replace('atmoCloud', '').toLowerCase(), e.target.value);
                        });
                        cloudGroup.appendChild(input);
                    }
                });

                section.appendChild(cloudGroup);

                // åˆ›å»ºé›¾æ•ˆæœè®¾ç½®ç»„
                const fogGroup = document.createElement('div');
                fogGroup.className = 'form-group';

                const fogTitle = document.createElement('h5');
                fogTitle.textContent = 'é›¾æ•ˆæœ';
                fogGroup.appendChild(fogTitle);

                const fogKeysList = document.createElement('div');
                fogKeysList.id = 'fogKeysList';
                fogGroup.appendChild(fogKeysList);

                const addFogKeyBtn = document.createElement('button');
                addFogKeyBtn.textContent = 'æ·»åŠ å…³é”®å¸§';
                addFogKeyBtn.onclick = addFogKey;
                fogGroup.appendChild(addFogKeyBtn);

                section.appendChild(fogGroup);

                // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°åˆ›å»ºçš„å…ƒç´ 
                moduleContainer.innerHTML = '';
                moduleContainer.appendChild(section);

                // è®¾ç½®åˆå§‹å€¼
                if (currentPlanetData?.ATMOSPHERE_VISUALS_DATA) {
                    const visualsData = currentPlanetData.ATMOSPHERE_VISUALS_DATA;
                    
                    // è®¾ç½®æ¸å˜å€¼
                    if (visualsData.GRADIENT) {
                        document.getElementById('atmoGradientPositionZ').value = visualsData.GRADIENT.positionZ;
                        document.getElementById('atmoGradientHeight').value = visualsData.GRADIENT.height;
                        document.getElementById('atmoGradientTexture').value = visualsData.GRADIENT.texture;
                    }

                    // è®¾ç½®äº‘å±‚å€¼
                    if (visualsData.CLOUDS) {
                        document.getElementById('atmoCloudTexture').value = visualsData.CLOUDS.texture;
                        document.getElementById('atmoCloudStartHeight').value = visualsData.CLOUDS.startHeight;
                        document.getElementById('atmoCloudWidth').value = visualsData.CLOUDS.width;
                        document.getElementById('atmoCloudHeight').value = visualsData.CLOUDS.height;
                        document.getElementById('atmoCloudAlpha').value = visualsData.CLOUDS.alpha;
                        document.getElementById('atmoCloudVelocity').value = visualsData.CLOUDS.velocity;
                    }

                    // æ›´æ–°é›¾æ•ˆæœå…³é”®å¸§åˆ—è¡¨
                    if (visualsData.FOG?.keys) {
                        updateFogKeysList(visualsData.FOG.keys);
                    }
                }
            }
            else if (moduleName === 'terrain') {
                try {
                    // é‡ç½® heightmaps
                    heightmaps = [];
                    
                    // åŠ è½½é«˜åº¦å›¾æ•°æ®
                    if (currentDirHandle) {
                        try {
                            const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                            for await (const entry of heightmapDir.values()) {
                                if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                                    heightmaps.push(entry.name.replace('.txt', ''));
                                }
                            }
                        } catch (e) {
                            console.log('No Heightmap Data directory found');
                        }
                    }

                    // å®šä¹‰é»˜è®¤çº¹ç†åˆ—è¡¨
                    const defaultPlanetTextures = [
                        'None', 'Callisto', 'Deimos', 'Earth', 'Europa', 
                        'Ganymede', 'Io', 'Jupiter', 'Mars', 'Mercury', 
                        'Moon', 'Asteroid', 'Phobos'
                    ];

                    const defaultSurfaceTextures = [
                        'None', 'Soft_Rocks', 'Limestone', 'Hard_Rocks', 
                        'Blured', 'Ice', 'Dark_Dust', 'Dust', 'Circles'
                    ];

                    // è·å–è‡ªå®šä¹‰çº¹ç†
                    let customTextures = [];
                    if (currentDirHandle) {
                        try {
                            const textureDir = await currentDirHandle.getDirectoryHandle('Texture Data');
                            for await (const entry of textureDir.values()) {
                                if (entry.kind === 'file' && entry.name.match(/\.(png|jpg|jpeg)$/i)) {
                                    customTextures.push(entry.name.replace(/\.[^/.]+$/, ''));
                                }
                            }
                        } catch (err) {
                            console.error('è¯»å–çº¹ç†ç›®å½•å¤±è´¥:', err);
                        }
                    }

                    // åˆå¹¶çº¹ç†åˆ—è¡¨
                    const allPlanetTextures = [...defaultPlanetTextures, ...customTextures];
                    const allSurfaceTextures = [...defaultSurfaceTextures, ...customTextures];

                    // åˆ›å»ºä¸»å®¹å™¨
                    const container = document.createElement('div');

                    // åˆ›å»ºåœ°å½¢çº¹ç†éƒ¨åˆ†
                    const textureSection = document.createElement('div');
                    textureSection.className = 'module-section';
                    
                    const textureTitle = document.createElement('h4');
                    textureTitle.textContent = 'åœ°å½¢çº¹ç†';
                    textureSection.appendChild(textureTitle);

                    // åˆ›å»ºè¡Œæ˜Ÿçº¹è®¾ç½®
                    const planetTextureGroup = document.createElement('div');
                    planetTextureGroup.className = 'form-group';
                    
                    // è¡Œæ˜Ÿçº¹ç†é€‰æ‹©å™¨
                    const planetTextureLabel = document.createElement('label');
                    planetTextureLabel.textContent = 'è¡Œæ˜Ÿçº¹ç†ï¼š';
                    const planetTextureSelect = document.createElement('select');
                    planetTextureSelect.id = 'planetTexture';
                    allPlanetTextures.forEach(texture => {
                        const option = document.createElement('option');
                        option.value = texture;
                        option.textContent = texture;
                        planetTextureSelect.appendChild(option);
                    });
                    planetTextureSelect.onchange = e => updateTerrainTexture('planetTexture', e.target.value);
                    
                    // çº¹ç†è£å‰ªè¾“å…¥
                    const cutoutLabel = document.createElement('label');
                    cutoutLabel.textContent = 'çº¹ç†è£å‰ªï¼š';
                    const cutoutInput = document.createElement('input');
                    cutoutInput.type = 'number';
                    cutoutInput.id = 'planetTextureCutout';
                    cutoutInput.step = '0.01';
                    cutoutInput.min = '0';
                    cutoutInput.max = '1';
                    cutoutInput.oninput = e => updateTerrainTexture('planetTextureCutout', e.target.value);

                    planetTextureGroup.appendChild(planetTextureLabel);
                    planetTextureGroup.appendChild(planetTextureSelect);
                    planetTextureGroup.appendChild(cutoutLabel);
                    planetTextureGroup.appendChild(cutoutInput);
                    textureSection.appendChild(planetTextureGroup);

                    // åˆ›å»ºè¡¨é¢çº¹ç† A/B/C è®¾ç½®
                    ['A', 'B', 'C'].forEach(type => {
                        const group = document.createElement('div');
                        group.className = 'form-group';
                        
                        const title = document.createElement('h5');
                        title.textContent = type === 'C' ? 'åœ°å½¢çº¹ç† C' : `è¡¨é¢çº¹ç† ${type}`;
                        group.appendChild(title);

                        // çº¹ç†é€‰æ‹©å™¨
                        const textureSelect = document.createElement('select');
                        textureSelect.id = type === 'C' ? 'terrainTexture_C' : `surfaceTexture_${type}`;
                        allSurfaceTextures.forEach(texture => {
                            const option = document.createElement('option');
                            option.value = texture;
                            option.textContent = texture;
                            textureSelect.appendChild(option);
                        });
                        textureSelect.onchange = e => updateTerrainTexture(textureSelect.id, e.target.value);
                        group.appendChild(textureSelect);

                        // å°ºå¯¸ X/Y è¾“å…¥
                        ['x', 'y'].forEach(axis => {
                            const label = document.createElement('label');
                            label.textContent = `å°ºå¯¸ ${axis.toUpperCase()}ï¼š`;
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.id = type === 'C' ? `terrainTextureSize_C_${axis}` : `surfaceTextureSize_${type}_${axis}`;
                            input.step = '0.1';
                            input.oninput = e => updateTerrainTextureSize(type, axis, e.target.value);
                            group.appendChild(label);
                            group.appendChild(input);
                        });

                        textureSection.appendChild(group);
                    });

                    container.appendChild(textureSection);

                    // åˆ›å»ºå…¶ä»–çº¹ç†è®¾ç½®
                    const otherTextureSettings = [
                        { id: 'surfaceLayerSize', label: 'è¡¨é¢å±‚å¤§å°ï¼š', step: '0.1' },
                        { id: 'minFade', label: 'æœ€å°æ·¡å‡ºï¼š', step: '0.1', min: '0', max: '1' },
                        { id: 'maxFade', label: 'æœ€å¤§æ·¡å‡ºï¼š', step: '0.1', min: '0', max: '1' },
                        { id: 'shadowIntensity', label: 'é˜´å½±å¼ºåº¦ï¼š', step: '0.1' },
                        { id: 'shadowHeight', label: 'é˜´å½±é«˜åº¦ï¼š', step: '0.1' }
                    ];

                    const otherSettingsGroup = document.createElement('div');
                    otherSettingsGroup.className = 'form-group';

                    otherTextureSettings.forEach(setting => {
                        const label = document.createElement('label');
                        label.textContent = setting.label;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.id = setting.id;
                        input.step = setting.step;
                        if (setting.min) input.min = setting.min;
                        if (setting.max) input.max = setting.max;
                        input.oninput = e => updateTerrainTexture(setting.id, e.target.value);
                        otherSettingsGroup.appendChild(label);
                        otherSettingsGroup.appendChild(input);
                    });

                    textureSection.appendChild(otherSettingsGroup);

                    // ... ç»§ç»­æ·»åŠ åœ°å½¢å…¬å¼ã€å¹³å¦åŒºåŸŸå’Œå²©çŸ³è®¾ç½®éƒ¨åˆ† ...

                    // åˆ›å»ºåœ°å½¢å…¬å¼éƒ¨åˆ†
                    const formulaSection = document.createElement('div');
                    formulaSection.className = 'module-section';
                    
                    const formulaTitle = document.createElement('h4');
                    formulaTitle.textContent = 'åœ°å½¢å…¬å¼';
                    formulaSection.appendChild(formulaTitle);

                    // åˆ›å»ºä¸åŒéš¾åº¦çš„å…¬å¼ç¼–ï¿½ï¿½å™¨
                    ['Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                        const difficultySection = document.createElement('div');
                        difficultySection.className = 'difficulty-section';
                        
                        const difficultyTitle = document.createElement('h5');
                        difficultyTitle.textContent = `${difficulty} éš¾åº¦`;
                        difficultySection.appendChild(difficultyTitle);

                        const formulaList = document.createElement('div');
                        formulaList.id = `${difficulty.toLowerCase()}Formulas`;
                        formulaList.className = 'formula-list';
                        difficultySection.appendChild(formulaList);

                        const addButton = document.createElement('button');
                        addButton.textContent = 'æ·»åŠ å…¬å¼';
                        addButton.onclick = () => addFormulaEditor(difficulty);
                        difficultySection.appendChild(addButton);

                        formulaSection.appendChild(difficultySection);
                    });

                    container.appendChild(formulaSection);

                    // åˆ›å»ºçº¹ç†å…¬å¼éƒ¨åˆ†
                    const textureFormulaSection = document.createElement('div');
                    textureFormulaSection.className = 'module-section';
                    
                    const textureFormulaTitle = document.createElement('h4');
                    textureFormulaTitle.textContent = 'çº¹ç†å…¬å¼';
                    textureFormulaSection.appendChild(textureFormulaTitle);

                    const textureFormulaList = document.createElement('div');
                    textureFormulaList.id = 'textureFormulas';
                    textureFormulaList.className = 'formula-list';
                    textureFormulaSection.appendChild(textureFormulaList);

                    const addTextureFormulaBtn = document.createElement('button');
                    addTextureFormulaBtn.textContent = 'æ·»åŠ çº¹ç†å…¬å¼';
                    addTextureFormulaBtn.onclick = addTextureFormulaEditor;
                    textureFormulaSection.appendChild(addTextureFormulaBtn);

                    container.appendChild(textureFormulaSection);

                    // åˆ›å»ºï¿½ï¿½ï¿½å¦åŒºï¿½ï¿½ï¿½éƒ¨åˆ†
                    const flatZoneSection = document.createElement('div');
                    flatZoneSection.className = 'module-section';
                    
                    const flatZoneTitle = document.createElement('h4');
                    flatZoneTitle.textContent = 'å¹³å¦åŒºåŸŸ';
                    flatZoneSection.appendChild(flatZoneTitle);

                    const toggleFlatZonesBtn = document.createElement('button');
                    toggleFlatZonesBtn.id = 'toggleFlatZonesBtn';
                    toggleFlatZonesBtn.textContent = 'å¯ç”¨å¹³å¦åŒºåŸŸ';
                    toggleFlatZonesBtn.onclick = toggleFlatZones;
                    flatZoneSection.appendChild(toggleFlatZonesBtn);

                    const flatZonesContainer = document.createElement('div');
                    flatZonesContainer.id = 'flatZonesContainer';
                    flatZonesContainer.style.display = 'none';

                    // åˆ›å»ºå¹³å¦åŒºåŸŸç¼–è¾‘å™¨
                    const flatZoneEditor = document.createElement('div');
                    flatZoneEditor.className = 'flat-zone-editor';

                    const flatZoneInputs = [
                        { placeholder: 'é«˜åº¦', step: '0.1', class: 'height-input' },
                        { placeholder: 'è§’åº¦', step: '0.0001', class: 'angle-input' },
                        { placeholder: 'å®½åº¦', step: '0.1', class: 'width-input' },
                        { placeholder: 'è¿‡æ¸¡', step: '0.1', class: 'transition-input' }
                    ];

                    flatZoneInputs.forEach(input => {
                        const inputElem = document.createElement('input');
                        inputElem.type = 'number';
                        inputElem.placeholder = input.placeholder;
                        inputElem.step = input.step;
                        inputElem.className = input.class;
                        flatZoneEditor.appendChild(inputElem);
                    });

                    const addFlatZoneBtn = document.createElement('button');
                    addFlatZoneBtn.textContent = 'æ·»åŠ ';
                    addFlatZoneBtn.onclick = addFlatZone;
                    flatZoneEditor.appendChild(addFlatZoneBtn);

                    flatZonesContainer.appendChild(flatZoneEditor);

                    const flatZonesList = document.createElement('div');
                    flatZonesList.id = 'flatZonesList';
                    flatZonesContainer.appendChild(flatZonesList);

                    flatZoneSection.appendChild(flatZonesContainer);
                    container.appendChild(flatZoneSection);

                    // åˆ›å»ºå²©çŸ³è®¾ç½®éƒ¨åˆ†
                    const rocksSection = document.createElement('div');
                    rocksSection.className = 'module-section';
                    
                    const rocksTitle = document.createElement('h4');
                    rocksTitle.textContent = 'å²©çŸ³è®¾ç½®';
                    rocksSection.appendChild(rocksTitle);

                    const toggleRocksBtn = document.createElement('button');
                    toggleRocksBtn.id = 'toggleRocksBtn';
                    toggleRocksBtn.textContent = 'å¯ç”¨å²©çŸ³';
                    toggleRocksBtn.onclick = toggleRocks;
                    rocksSection.appendChild(toggleRocksBtn);

                    const rocksContainer = document.createElement('div');
                    rocksContainer.id = 'rocksContainer';
                    rocksContainer.style.display = 'none';

                    const rocksForm = document.createElement('div');
                    rocksForm.className = 'form-group';

                    // åˆ›å»ºå²©çŸ³ç±»å‹é€‰æ‹©å™¨
                    const rockTypeLabel = document.createElement('label');
                    rockTypeLabel.textContent = 'å²©çŸ³ç±»å‹ï¼š';
                    const rockTypeSelect = document.createElement('select');
                    rockTypeSelect.id = 'rockType';
                    ['Rock Square', 'Rock Round'].forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type === 'Rock Square' ? 'æ–¹å½¢å²©çŸ³' : 'åœ†å½¢å²©çŸ³';
                        rockTypeSelect.appendChild(option);
                    });
                    rocksForm.appendChild(rockTypeLabel);
                    rocksForm.appendChild(rockTypeSelect);

                    // åˆ›å»ºå…¶ä»–å²©çŸ³è®¾ç½®
                    const rockSettings = [
                        { id: 'rockDensity', label: 'å¯†åº¦ï¼š', step: '0.1', min: '0', max: '1' },
                        { id: 'rockMinSize', label: 'æœ€å°å°ºå¯¸ï¼š', step: '0.01', min: '0' },
                        { id: 'rockMaxSize', label: 'æœ€å¤§å°ºå¯¸ï¼š', step: '0.01', min: '0' },
                        { id: 'rockPowerCurve', label: 'å¹‚æ›²çº¿ï¼š', step: '0.1' },
                        { id: 'rockMaxAngle', label: 'æœ€å¤§è§’åº¦ï¼š', step: '1', min: '0', max: '90' }
                    ];

                    rockSettings.forEach(setting => {
                        const label = document.createElement('label');
                        label.textContent = setting.label;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.id = setting.id;
                        input.step = setting.step;
                        if (setting.min) input.min = setting.min;
                        if (setting.max) input.max = setting.max;
                        rocksForm.appendChild(label);
                        rocksForm.appendChild(input);
                    });

                    rocksContainer.appendChild(rocksForm);
                    rocksSection.appendChild(rocksContainer);
                    container.appendChild(rocksSection);

                    // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°åˆ›å»ºçš„å…ƒç´ 
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(container);

                    // åˆå§‹åŒ–ç°æœ‰çš„å…¬å¼
                    if (currentPlanetData?.TERRAIN_DATA?.terrainFormulaDifficulties) {
                        Object.entries(currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties).forEach(([difficulty, formulas]) => {
                            const formulaContainer = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
                            if (formulaContainer && Array.isArray(formulas)) {
                                formulas.forEach(formula => {
                                    try {
                                        const editor = createFormulaEditor(formula);
                                        if (editor) {
                                            formulaContainer.appendChild(editor);
                                        }
                                    } catch (err) {
                                        console.error('Error creating formula editor:', err);
                                    }
                                });
                            }
                        });
                    }

                    // åˆå§‹åŒ–çº¹ç†å…¬å¼
                    if (currentPlanetData?.TERRAIN_DATA?.textureFormula) {
                        const textureContainer = document.getElementById('textureFormulas');
                        if (textureContainer && Array.isArray(currentPlanetData.TERRAIN_DATA.textureFormula)) {
                            currentPlanetData.TERRAIN_DATA.textureFormula.forEach(formula => {
                                try {
                                    const editor = createFormulaEditor(formula);
                                    if (editor) {
                                        textureContainer.appendChild(editor);
                                    }
                                } catch (err) {
                                    console.error('Error creating texture formula editor:', err);
                                }
                            });
                        }
                    }

                    // åˆå§‹åŒ–å¹³å¦åŒºåŸŸ
                    if (currentPlanetData?.TERRAIN_DATA?.flatZones?.length > 0) {
                        const flatZonesContainer = document.getElementById('flatZonesContainer');
                        const toggleFlatZonesBtn = document.getElementById('toggleFlatZonesBtn');
                        if (flatZonesContainer && toggleFlatZonesBtn) {
                            flatZonesContainer.style.display = 'block';
                            toggleFlatZonesBtn.textContent = 'ç¦ç”¨å¹³å¦åŒºåŸŸ';
                            updateFlatZonesList();
                        }
                    }

                    // åˆå§‹åŒ–å²©çŸ³è®¾ç½®
                    if (currentPlanetData?.TERRAIN_DATA?.rocks) {
                        const rocks = currentPlanetData.TERRAIN_DATA.rocks;
                        const rocksContainer = document.getElementById('rocksContainer');
                        const toggleRocksBtn = document.getElementById('toggleRocksBtn');
                        if (rocksContainer && toggleRocksBtn) {
                            rocksContainer.style.display = 'block';
                            toggleRocksBtn.textContent = 'ç¦ç”¨å²©çŸ³';
                            
                            const elements = {
                                'rockType': rocks.rockType,
                                'rockDensity': rocks.rockDensity,
                                'rockMinSize': rocks.minSize,
                                'rockMaxSize': rocks.maxSize,
                                'rockPowerCurve': rocks.powerCurve,
                                'rockMaxAngle': rocks.maxAngle
                            };

                            Object.entries(elements).forEach(([id, value]) => {
                                const element = document.getElementById(id);
                                if (element) {
                                    element.value = value;
                                }
                            });
                        }
                    
                    }
                    const terrainSettingsGroup = document.createElement('div');
                    terrainSettingsGroup.className = 'form-group';
                    
                    // é¡¶ç‚¹å¤§å°è®¾ç½®
                    const verticeSizeLabel = document.createElement('label');
                    verticeSizeLabel.textContent = 'é¡¶ç‚¹å¤§å°:';
                    const verticeSizeInput = document.createElement('input');
                    verticeSizeInput.type = 'number';
                    verticeSizeInput.id = 'verticeSize';
                    verticeSizeInput.step = '0.1';
                    verticeSizeInput.min = '0';
                    verticeSizeInput.value = currentPlanetData?.TERRAIN_DATA?.verticeSize || 4.0;
                    verticeSizeInput.onchange = (e) => {
                        if (!currentPlanetData.TERRAIN_DATA) {
                            currentPlanetData.TERRAIN_DATA = {};
                        }
                        currentPlanetData.TERRAIN_DATA.verticeSize = parseFloat(e.target.value);
                    };

                    // ç¢°æ’ä½“è®¾ç½®
                    const colliderLabel = document.createElement('label');
                    colliderLabel.textContent = 'å¯ç”¨ç¢°æ’:';
                    const colliderCheckbox = document.createElement('input');
                    colliderCheckbox.type = 'checkbox';
                    colliderCheckbox.id = 'terrainCollider';
                    colliderCheckbox.checked = currentPlanetData?.TERRAIN_DATA?.collider !== false; // é»˜è®¤ä¸ºtrue
                    colliderCheckbox.onchange = (e) => {
                        if (!currentPlanetData.TERRAIN_DATA) {
                            currentPlanetData.TERRAIN_DATA = {};
                        }
                        currentPlanetData.TERRAIN_DATA.collider = e.target.checked;
                    };

                    // æ·»åŠ åˆ°è®¾ç½®ç»„
                    terrainSettingsGroup.appendChild(verticeSizeLabel);
                    terrainSettingsGroup.appendChild(verticeSizeInput);
                    terrainSettingsGroup.appendChild(document.createElement('br'));
                    terrainSettingsGroup.appendChild(colliderLabel);
                    terrainSettingsGroup.appendChild(colliderCheckbox);

                    // æ·»åŠ åˆ°åœ°å½¢å®¹å™¨
                    moduleContainer.appendChild(terrainSettingsGroup);
                } catch (error) {
                    console.error('Error in terrain module:', error);
                }
            }
            else if (moduleName === 'orbit') {
                try {
                    // åˆ›å»ºï¿½ï¿½å®¹å™¨
                    const section = document.createElement('div');
                    section.className = 'module-section';

                    // åˆ›å»ºæ ‡é¢˜
                    const title = document.createElement('h4');
                    title.textContent = 'è½¨é“å‚æ•°';
                    section.appendChild(title);

                    // åˆ›å»ºè½¨é“å‚æ•°è¡¨å•
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';

                    // è·å–æ˜Ÿçƒåˆ—è¡¨å¹¶åˆ›å»ºè¡¨å•
                    const planets = await getPlanetsList();
                    
                    // å®šä¹‰ï¿½ï¿½ï¿½é“å‚æ•°å­—æ®µ
                    const orbitFields = [
                        {
                            id: 'parent',
                            label: 'æ¯æ˜Ÿï¼š',
                            type: 'select',
                            options: planets,
                            value: currentPlanetData?.ORBIT_DATA?.parent || 'Sun'
                        },
                        {
                            id: 'semiMajorAxis',
                            label: 'åŠé•¿è½´ (ç±³)ï¼š',
                            type: 'number',
                            step: '1000000',
                            value: currentPlanetData?.ORBIT_DATA?.semiMajorAxis || 0
                        },
                        {
                            id: 'eccentricity',
                            label: 'åå¿ƒç‡ï¼š',
                            type: 'number',
                            step: '0.01',
                            min: '0',
                            max: '0.99',
                            value: currentPlanetData?.ORBIT_DATA?.eccentricity || 0
                        },
                        {
                            id: 'argumentOfPeriapsis',
                            label: 'è¿‘ï¿½ï¿½å¹…è§’ (åº¦)ï¼š',
                            type: 'number',
                            step: '1',
                            min: '0',
                            max: '360',
                            value: currentPlanetData?.ORBIT_DATA?.argumentOfPeriapsis || 0
                        },
                        {
                            id: 'direction',
                            label: 'è½¨é“æ–¹å‘ï¼š',
                            type: 'select',
                            options: [
                                { value: 1, text: 'é¡ºè¡Œ' },
                                { value: -1, text: 'é€†è¡Œ' }
                            ],
                            value: currentPlanetData?.ORBIT_DATA?.direction ?? 1
                        },
                        {
                            id: 'multiplierSOI',
                            label: 'SOIç³»æ•°ï¼š',
                            type: 'number',
                            step: '0.1',
                            min: '0',
                            value: currentPlanetData?.ORBIT_DATA?.multiplierSOI || 2.5
                        }
                    ];

                    // åˆ›å»ºè¡¨å•å­—æ®µ
                    orbitFields.forEach(field => {
                        const fieldContainer = document.createElement('div');
                        fieldContainer.className = 'field-container';

                        const label = document.createElement('label');
                        label.textContent = field.label;
                        fieldContainer.appendChild(label);

                        if (field.type === 'select') {
                            const select = document.createElement('select');
                            select.id = field.id;
                            
                            if (Array.isArray(field.options) && typeof field.options[0] !== 'object') {
                                // ç®€å•é€‰é¡¹åˆ—è¡¨ï¼ˆç”¨äºæ¯æ˜Ÿé€‰æ‹©ï¼‰
                                field.options.forEach(option => {
                                    const opt = document.createElement('option');
                                    opt.value = option;
                                    opt.textContent = option;
                                    select.appendChild(opt);
                                });
                            } else {
                                // å¯¹è±¡é€‰é¡¹åˆ—è¡¨ï¼ˆç”¨äºè½¨é“æ–¹å‘ï¼‰
                                field.options.forEach(option => {
                                    const opt = document.createElement('option');
                                    opt.value = option.value;
                                    opt.textContent = option.text;
                                    select.appendChild(opt);
                                });
                            }
                            
                            select.value = field.value;
                            select.onchange = e => {
                                const value = field.id === 'direction' ? parseInt(e.target.value) : e.target.value;
                                updateOrbitData(field.id, value);
                            };
                            fieldContainer.appendChild(select);
                        } else {
                            const input = document.createElement('input');
                            input.type = field.type;
                            input.id = field.id;
                            if (field.step) input.step = field.step;
                            if (field.min) input.min = field.min;
                            if (field.max) input.max = field.max;
                            input.value = field.value;
                            input.oninput = e => updateOrbitData(field.id, parseFloat(e.target.value));
                            fieldContainer.appendChild(input);
                        }

                        formGroup.appendChild(fieldContainer);
                    });

                    // åˆ›å»ºéš¾åº¦ç¼©æ”¾éƒ¨åˆ†
                    const difficultyScaleSection = document.createElement('div');
                    difficultyScaleSection.className = 'difficulty-scale-section';

                    // SMAéš¾åº¦ç¼©æ”¾
                    const smaScaleTitle = document.createElement('h5');
                    smaScaleTitle.textContent = 'åŠé•¿è½´éš¾åº¦ç¼©æ”¾';
                    difficultyScaleSection.appendChild(smaScaleTitle);

                    const smaScaleContainer = document.createElement('div');
                    smaScaleContainer.id = 'smaScaleContainer';
                    ['Easy', 'Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                        const diffGroup = document.createElement('div');
                        diffGroup.className = 'difficulty-group';
                        
                        const label = document.createElement('label');
                        label.textContent = `${difficulty}ï¼š`;
                        
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.value = currentPlanetData?.ORBIT_DATA?.smaDifficultyScale?.[difficulty] || 1;
                        input.oninput = e => updateOrbitDifficultyScale('sma', difficulty, parseFloat(e.target.value));
                        
                        diffGroup.appendChild(label);
                        diffGroup.appendChild(input);
                        smaScaleContainer.appendChild(diffGroup);
                    });
                    difficultyScaleSection.appendChild(smaScaleContainer);

                    // SOIéš¾åº¦ç¼©æ”¾
                    const soiScaleTitle = document.createElement('h5');
                    soiScaleTitle.textContent = 'SOIéš¾åº¦ç¼©æ”¾';
                    difficultyScaleSection.appendChild(soiScaleTitle);

                    const soiScaleContainer = document.createElement('div');
                    soiScaleContainer.id = 'soiScaleContainer';
                    ['Easy', 'Normal', 'Hard', 'Realistic'].forEach(difficulty => {
                        const diffGroup = document.createElement('div');
                        diffGroup.className = 'difficulty-group';
                        
                        const label = document.createElement('label');
                        label.textContent = `${difficulty}ï¼š`;
                        
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.value = currentPlanetData?.ORBIT_DATA?.soiDifficultyScale?.[difficulty] || 1;
                        input.oninput = e => updateOrbitDifficultyScale('soi', difficulty, parseFloat(e.target.value));
                        
                        diffGroup.appendChild(label);
                        diffGroup.appendChild(input);
                        soiScaleContainer.appendChild(diffGroup);
                    });
                    difficultyScaleSection.appendChild(soiScaleContainer);

                    // æ·»åŠ æ‰€æœ‰å…ƒç´ åˆ°ä¸»å®¹å™¨
                    section.appendChild(formGroup);
                    section.appendChild(difficultyScaleSection);

                    // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°åˆ›å»ºçš„å…ƒç´ 
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(section);

                } catch (error) {
                    console.error('Error in orbit module:', error);
                }
            }
            else if (moduleName === 'postProcessing') {
                try {
                    // åˆ›å»ºä¸»å®¹å™¨
                    const section = document.createElement('div');
                    section.className = 'module-section';

                    // åˆ›å»ºæ ‡é¢˜
                    const title = document.createElement('h4');
                    title.textContent = 'åæœŸå¤„ç†';
                    section.appendChild(title);

                    // åˆ›å»ºå…³é”®å¸§åˆ—è¡¨å®¹å™¨
                    const keyframesList = document.createElement('div');
                    keyframesList.id = 'postProcessingKeyframes';
                    keyframesList.className = 'keyframes-list';

                    // åˆ›å»ºæ·»åŠ å…³é”®å¸§æŒ‰é’®
                    const addButton = document.createElement('button');
                    addButton.textContent = 'æ·»åŠ å…³å¸§';
                    addButton.onclick = addPostProcessingKeyframe;

                    // å¦‚æœå­˜åœ¨ç°æœ‰çš„å…³é”®å¸§æ•°æ®ï¼Œåˆ›å»ºå…³é”®å¸§ç¼–è¾‘å™¨
                    if (currentPlanetData?.POST_PROCESSING?.keys) {
                        currentPlanetData.POST_PROCESSING.keys.forEach((keyframe, index) => {
                            const keyframeEditor = createPostProcessingKeyframeEditor(keyframe, index);
                            keyframesList.appendChild(keyframeEditor);
                        });
                    }

                    section.appendChild(keyframesList);
                    section.appendChild(addButton);

                    // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°åˆ›å»ºçš„å…ƒç´ 
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(section);

                } catch (error) {
                    console.error('Error in post processing module:', error);
                }
            }
            else if (moduleName === 'landmarks') {
                try {
                    // åˆ›å»ºä¸»å®¹å™¨
                    const section = document.createElement('div');
                    section.className = 'module-section landmarks-section';

                    // åˆ›å»ºæ ‡é¢˜
                    const title = document.createElement('h4');
                    title.textContent = 'åœ°æ ‡è®¾ç½®';
                    section.appendChild(title);

                    // åˆ›å»ºåœ°æ ‡åˆ—è¡¨å®¹å™¨
                    const landmarksGroup = document.createElement('div');
                    landmarksGroup.className = 'landmarks-group';

                    // å¦‚æœå­˜åœ¨ç°æœ‰çš„åœ°æ ‡æ•°æ®ï¼Œåˆ›å»ºåœ°æ ‡ç¼–è¾‘å™¨
                    if (currentPlanetData?.LANDMARKS) {
                        currentPlanetData.LANDMARKS.forEach((landmark, index) => {
                            const landmarkContainer = document.createElement('div');
                            landmarkContainer.className = 'landmark-item';

                            // åœ°æ ‡åç§°
                            const nameInput = document.createElement('input');
                            nameInput.type = 'text';
                            nameInput.value = landmark.name;
                            nameInput.placeholder = 'åœ°æ ‡åç§°';
                            nameInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'name', e.target.value);
                            });

                            // è§’åº¦è¾“å…¥
                            const angleInput = document.createElement('input');
                            angleInput.type = 'number';
                            angleInput.value = landmark.angle;
                            angleInput.step = '0.1';
                            angleInput.placeholder = 'è§’åº¦';
                            angleInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'angle', parseFloat(e.target.value));
                            });

                            // èµ·å§‹è§’åº¦è¾“å…¥
                            const startAngleInput = document.createElement('input');
                            startAngleInput.type = 'number';
                            startAngleInput.value = landmark.startAngle;
                            startAngleInput.step = '0.1';
                            startAngleInput.placeholder = 'èµ·å§‹è§’åº¦';
                            startAngleInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'startAngle', parseFloat(e.target.value));
                            });

                            // ç»“æŸè§’åº¦è¾“å…¥
                            const endAngleInput = document.createElement('input');
                            endAngleInput.type = 'number';
                            endAngleInput.value = landmark.endAngle;
                            endAngleInput.step = '0.1';
                            endAngleInput.placeholder = 'ç»“æŸè§’ï¿½ï¿½ï¿½';
                            endAngleInput.addEventListener('change', function(e) {
                                updateLandmark(index, 'endAngle', parseFloat(e.target.value));
                            });

                            // åˆ é™¤æŒ‰é’®
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Ã—';
                            deleteButton.className = 'delete-landmark';
                            deleteButton.addEventListener('click', function() {
                                removeLandmark(index);
                            });

                            // å°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
                            landmarkContainer.appendChild(nameInput);
                            landmarkContainer.appendChild(angleInput);
                            landmarkContainer.appendChild(startAngleInput);
                            landmarkContainer.appendChild(endAngleInput);
                            landmarkContainer.appendChild(deleteButton);

                            landmarksGroup.appendChild(landmarkContainer);
                        });
                    }

                    // æ·»åŠ æ–°åœ°æ ‡æŒ‰é’®
                    const addButton = document.createElement('button');
                    addButton.textContent = 'æ·»åŠ åœ°æ ‡';
                    addButton.className = 'add-landmark';
                    addButton.addEventListener('click', function() {
                        if (!currentPlanetData.LANDMARKS) {
                            currentPlanetData.LANDMARKS = [];
                        }

                        const newLandmark = {
                            name: "æ–°åœ°æ ‡",
                            angle: 0.0,
                            startAngle: 0.0,
                            endAngle: 0.0
                        };

                        currentPlanetData.LANDMARKS.push(newLandmark);
                        showModuleEditor('landmarks'); // é‡æ–°æ¸²æŸ“åœ°æ ‡æ¨¡å—
                    });

                    section.appendChild(landmarksGroup);
                    section.appendChild(addButton);

                    // æ¸…ç©ºå®¹å™¨å¹¶æ·»ï¿½ï¿½ï¿½æ–°åˆ›å»ºçš„å…ƒç´ 
                    moduleContainer.innerHTML = '';
                    moduleContainer.appendChild(section);

                } catch (error) {
                    console.error('Error in landmarks module:', error);
                }
            }
        }

        // æ·»åŠ å¹³å¦åŒºåŸŸç›¸å…³å‡½æ•°
        function addFlatZone() {
            console.log('æ·»åŠ å¹³å¦åŒºåŸŸ');
            const editor = document.querySelector('.flat-zone-editor');
            const inputs = editor.querySelectorAll('input');
            
            const flatZone = {
                height: parseFloat(inputs[0].value),
                angle: parseFloat(inputs[1].value),
                width: parseFloat(inputs[2].value),
                transition: parseFloat(inputs[3].value)
            };

            if (!currentPlanetData.TERRAIN_DATA.flatZones) {
                currentPlanetData.TERRAIN_DATA.flatZones = [];
            }
            
            currentPlanetData.TERRAIN_DATA.flatZones.push(flatZone);
            updateFlatZonesList();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            inputs.forEach(input => input.value = '');
        }

        function updateFlatZonesList() {
            const list = document.getElementById('flatZonesList');
            list.innerHTML = '';
            
            currentPlanetData.TERRAIN_DATA.flatZones.forEach((zone, index) => {
                const item = document.createElement('div');
                item.className = 'flat-zone-item';
                item.innerHTML = `
                    <span>é«˜åº¦: ${zone.height}, è§’åº¦: ${zone.angle}, å®½åº¦: ${zone.width}, è¿‡æ¸¡: ${zone.transition}</span>
                    <button onclick="removeFlatZone(${index})">åˆ é™¤</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFlatZone(index) {
            currentPlanetData.TERRAIN_DATA.flatZones.splice(index, 1);
            updateFlatZonesList();
        }

        function toggleFlatZones() {
            const container = document.getElementById('flatZonesContainer');
            const button = document.getElementById('toggleFlatZonesBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'ç¦ç”¨å¹³å¦åŒºåŸŸ';
                if (!currentPlanetData.TERRAIN_DATA.flatZones) {
                    currentPlanetData.TERRAIN_DATA.flatZones = [];
                }
            } else {
                container.style.display = 'none';
                button.textContent = 'å¯ç”¨å¹³å¦åŒºåŸŸ';
                delete currentPlanetData.TERRAIN_DATA.flatZones;
            }
        }

        // æ·»åŠ å²©çŸ³ç›¸å…³å‡½æ•°
        function toggleRocks() {
            console.log('åˆ‡æ¢å²©çŸ³æ˜¾ç¤ºçŠ¶æ€');
            const container = document.getElementById('rocksContainer');
            const button = document.getElementById('toggleRocksBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'ç¦ç”¨å²©çŸ³';
                if (!currentPlanetData.TERRAIN_DATA.rocks) {
                    currentPlanetData.TERRAIN_DATA.rocks = {
                        rockType: 'Rock Square',
                        rockDensity: 0.5,
                        minSize: 1,
                        maxSize: 2,
                        powerCurve: 1,
                        maxAngle: 45
                    };
                }
                updateRocksForm();
            } else {
                container.style.display = 'none';
                button.textContent = 'å¯ç”¨å²©çŸ³';
                delete currentPlanetData.TERRAIN_DATA.rocks;
            }
        }

        function updateRocksForm() {
            const rocks = currentPlanetData.TERRAIN_DATA.rocks;
            if (rocks) {
                document.getElementById('rockType').value = rocks.rockType;
                document.getElementById('rockDensity').value = rocks.rockDensity;
                document.getElementById('rockMinSize').value = rocks.minSize;
                document.getElementById('rockMaxSize').value = rocks.maxSize;
                document.getElementById('rockPowerCurve').value = rocks.powerCurve;
                document.getElementById('rockMaxAngle').value = rocks.maxAngle;
            }
        }

        // æ·»åŠ å…¬å¼ç›¸å…³å‡½æ•°
        function addFormulaEditor(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.appendChild(createFormulaEditor());
        }

        function addTextureFormulaEditor() {
            const container = document.getElementById('textureFormulas');
            container.appendChild(createFormulaEditor());
        }

        function updateFormulaList(difficulty) {
            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty];
            if (formulas) {
                formulas.forEach(formula => {
                    container.appendChild(createFormulaEditor(formula));
                });
            }
        }

        function updateTextureFormulaList() {
            const container = document.getElementById('textureFormulas');
            container.innerHTML = '';
            
            const formulas = currentPlanetData.TERRAIN_DATA.textureFormula;
            if (formulas) {
                formulas.forEach(formula => {
                    container.appendChild(createFormulaEditor(formula));
                });
            }
        }
        function updateOrbitData(field, value) {
            console.log(`æ›´æ–°è½¨é“æ•°æ®: ${field} = ${value}`);
            if (!currentPlanetData.ORBIT_DATA) {
                currentPlanetData.ORBIT_DATA = {};
            }
            
            if (field === 'direction' || field === 'parent') {
                currentPlanetData.ORBIT_DATA[field] = value;
            } else {
                currentPlanetData.ORBIT_DATA[field] = parseFloat(value);
            }
        }

        function updateOrbitDifficultyScale(type, difficulty, value) {
            if (!currentPlanetData.ORBIT_DATA) {
                currentPlanetData.ORBIT_DATA = {};
            }
            
            const scaleType = type === 'sma' ? 'smaDifficultyScale' : 'soiDifficultyScale';
            
            if (!currentPlanetData.ORBIT_DATA[scaleType]) {
                currentPlanetData.ORBIT_DATA[scaleType] = {};
            }
            
            currentPlanetData.ORBIT_DATA[scaleType][difficulty] = value;
        }

        // ä¿®æ”¹æ‰“å¼€æ‹“å±•åŒ…æ–‡ä»¶å¤¹çš„å‡½æ•°
        async function openExtensionFolder() {
            try {
                extensionDirHandle = await window.showDirectoryPicker();
                console.log('æˆåŠŸæ‰“å¼€æ‹“å±•åŒ…æ–‡ä»¶å¤¹');
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–åˆå§‹åŒ–é€»è¾‘
            } catch (err) {
                console.error('æ‰“å¼€æ‹“å±•åŒ…æ–‡ä»¶å¤¹å¤±è´¥:', err);
            }
        }

        // åˆ›å»ºå…³é”®å¸§ç¼–è¾‘å™¨
        function createPostProcessingKeyframeEditor(keyframe, index) {
            const editor = document.createElement('div');
            editor.className = 'keyframe-editor';
            editor.dataset.index = index;

            // å®šä¹‰å…³é”®å¸§å‚æ•°
            const fields = [
                { id: 'height', label: 'é«˜åº¦', step: '1000', value: keyframe.height },
                { id: 'shadowIntensity', label: 'é˜´å½±å¼ºåº¦', step: '0.05', value: keyframe.shadowIntensity },
                { id: 'starIntensity', label: 'æ˜Ÿç©ºå¼ºåº¦', step: '0.1', value: keyframe.starIntensity },
                { id: 'hueShift', label: 'è‰²ç›¸åç§»', step: '0.1', value: keyframe.hueShift },
                { id: 'saturation', label: 'é¥±å’Œåº¦', step: '0.05', value: keyframe.saturation },
                { id: 'contrast', label: 'å¯¹æ¯”åº¦', step: '0.05', value: keyframe.contrast },
                { id: 'red', label: 'çº¢è‰²', step: '0.01', value: keyframe.red },
                { id: 'green', label: 'ç»¿è‰²', step: '0.01', value: keyframe.green },
                { id: 'blue', label: 'è“è‰²', step: '0.01', value: keyframe.blue }
            ];

            // åˆ›å»ºè¡¨å•å­—æ®µ
            fields.forEach(field => {
                const container = document.createElement('div');
                container.className = 'field-container';

                const label = document.createElement('label');
                label.textContent = field.label;

                const input = document.createElement('input');
                input.type = 'number';
                input.step = field.step;
                input.value = field.value;
                input.onchange = e => updatePostProcessingKeyframe(index, field.id, parseFloat(e.target.value));

                container.appendChild(label);
                container.appendChild(input);
                editor.appendChild(container);
            });

            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'åˆ é™¤';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => removePostProcessingKeyframe(index);
            editor.appendChild(deleteButton);

            return editor;
        }

        // æ·»åŠ æ–°å…³é”®å¸§
        function addPostProcessingKeyframe() {
            if (!currentPlanetData.POST_PROCESSING) {
                currentPlanetData.POST_PROCESSING = { keys: [] };
            }

            const newKeyframe = {
                height: 0.0,
                shadowIntensity: 1.0,
                starIntensity: 0.0,
                hueShift: 0.0,
                saturation: 1.0,
                contrast: 1.0,
                red: 1.0,
                green: 1.0,
                blue: 1.0
            };

            currentPlanetData.POST_PROCESSING.keys.push(newKeyframe);
            const keyframesList = document.getElementById('postProcessingKeyframes');
            const editor = createPostProcessingKeyframeEditor(newKeyframe, currentPlanetData.POST_PROCESSING.keys.length - 1);
            keyframesList.appendChild(editor);
        }

        // æ›´æ–°å…³é”®å¸§æ•°æ®
        function updatePostProcessingKeyframe(index, field, value) {
            if (currentPlanetData?.POST_PROCESSING?.keys?.[index]) {
                currentPlanetData.POST_PROCESSING.keys[index][field] = value;
                // æŒ‰é«˜åº¦æ’åº
                currentPlanetData.POST_PROCESSING.keys.sort((a, b) => a.height - b.height);
                // é‡æ–°æ¸²æŸ“å…³é”®å¸§åˆ—è¡¨
                const keyframesList = document.getElementById('postProcessingKeyframes');
                keyframesList.innerHTML = '';
                currentPlanetData.POST_PROCESSING.keys.forEach((keyframe, idx) => {
                    const editor = createPostProcessingKeyframeEditor(keyframe, idx);
                    keyframesList.appendChild(editor);
                });
            }
        }

        // åˆ é™¤å…³ï¿½ï¿½ï¿½å¸§
        function removePostProcessingKeyframe(index) {
            if (currentPlanetData?.POST_PROCESSING?.keys) {
                currentPlanetData.POST_PROCESSING.keys.splice(index, 1);
                // é‡æ–°æ¸²æŸ“å…³é”®å¸§åˆ—è¡¨
                const keyframesList = document.getElementById('postProcessingKeyframes');
                keyframesList.innerHTML = '';
                currentPlanetData.POST_PROCESSING.keys.forEach((keyframe, idx) => {
                    const editor = createPostProcessingKeyframeEditor(keyframe, idx);
                    keyframesList.appendChild(editor);
                });
            }
        }

        // åˆ›å»ºåœ°æ ‡ç¼–è¾‘å™¨
        function createLandmarkEditor(landmark, index) {
            console.log(`åˆ›å»ºåœ°æ ‡ç¼–è¾‘å™¨: ç´¢å¼•=${index}`);
            const editor = document.createElement('div');
            editor.className = 'landmark-editor';
            editor.dataset.index = index;

            // å®šä¹‰åœ°æ ‡å‚æ•°
            const fields = [
                { id: 'name', label: 'åç§°', type: 'text', value: landmark.name },
                { id: 'angle', label: 'è§’åº¦', type: 'number', step: '0.1', value: landmark.angle },
                { id: 'startAngle', label: 'èµ·å§‹è§’åº¦', type: 'number', step: '0.1', value: landmark.startAngle },
                { id: 'endAngle', label: 'ç»“æŸè§’åº¦', type: 'number', step: '0.1', value: landmark.endAngle }
            ];

            // åˆ›å»ºè¡¨å•å­—æ®µ
            fields.forEach(field => {
                const container = document.createElement('div');
                container.className = 'field-container';

                const label = document.createElement('label');
                label.textContent = field.label;

                const input = document.createElement('input');
                input.type = field.type;
                if (field.type === 'number') {
                    input.step = field.step;
                }
                input.value = field.value;
                input.onchange = e => updateLandmark(
                    index, 
                    field.id, 
                    field.type === 'number' ? parseFloat(e.target.value) : e.target.value
                );

                container.appendChild(label);
                container.appendChild(input);
                editor.appendChild(container);
            });

            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'åˆ é™¤';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => removeLandmark(index);
            editor.appendChild(deleteButton);

            return editor;
        }

        // æ·»åŠ æ–°åœ°æ ‡
        function addLandmark() {
            if (!currentPlanetData.LANDMARKS) {
                currentPlanetData.LANDMARKS = [];
            }

            const newLandmark = {
                name: "æ–°åœ°æ ‡",
                angle: 0.0,
                startAngle: 0.0,
                endAngle: 0.0
            };

            currentPlanetData.LANDMARKS.push(newLandmark);
            updatePlanetEditForm(); // é‡æ–°æ¸²æŸ“åœ°æ ‡æ¨¡å—
        }

        // æ›´æ–°åœ°æ ‡æ•°æ®
        function updateLandmark(index, field, value) {
            if (currentPlanetData?.LANDMARKS?.[index]) {
                currentPlanetData.LANDMARKS[index][field] = value;
                // æŒ‰è§’åº¦æ’åº
                currentPlanetData.LANDMARKS.sort((a, b) => a.angle - b.angle);
                // é‡æ–°æ¸²æŸ“åœ°æ ‡æ¨¡å—
                showModuleEditor('landmarks');
            }
        }

        // åˆ é™¤åœ°æ ‡
        function removeLandmark(index) {
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.splice(index, 1);
                // é‡æ–°æ¸²æŸ“åœ°æ ‡æ¨¡å—
                showModuleEditor('landmarks');
            }
        }

        // åœ¨æ˜Ÿçƒç¼–è¾‘è¡¨å•ä¸­æ·»ï¿½ï¿½åœ°æ ‡éƒ¨åˆ†
        function updatePlanetEditForm() {
            // ... å…¶ä»–è¡¨å•éƒ¨åˆ†çš„ä»£ç  ...

            // è·å–æˆ–åˆ›å»ºåœ°æ ‡éƒ¨åˆ†å®¹å™¨
            let landmarksSection = document.querySelector('.form-section.landmarks-section');
            if (!landmarksSection) {
                landmarksSection = document.createElement('div');
                landmarksSection.className = 'form-section landmarks-section';
                document.querySelector('#planetEditForm').appendChild(landmarksSection);
            }

            // æ¸…ç©ºç°æœ‰å†…å®¹
            landmarksSection.innerHTML = '';
            
            // åˆ›å»ºæ ‡é¢˜
            const landmarksTitle = document.createElement('h4');
            landmarksTitle.textContent = 'åœ°æ ‡è®¾ç½®';
            landmarksSection.appendChild(landmarksTitle);

            // åˆ›å»ºåœ°æ ‡ç»„
            const landmarksGroup = document.createElement('div');
            landmarksGroup.className = 'landmarks-group';

            // æ·»åŠ ç°æœ‰åœ°æ ‡
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.forEach((landmark, index) => {
                    const landmarkContainer = document.createElement('div');
                    landmarkContainer.className = 'landmark-item';

                    // åœ°æ ‡åç§°
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = landmark.name;
                    nameInput.placeholder = 'åœ°æ ‡åç§°';
                    nameInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'name', e.target.value);
                    });

                    // è§’åº¦è¾“å…¥
                    const angleInput = document.createElement('input');
                    angleInput.type = 'number';
                    angleInput.value = landmark.angle;
                    angleInput.step = '0.1';
                    angleInput.placeholder = 'è§’åº¦';
                    angleInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'angle', parseFloat(e.target.value));
                    });

                    // èµ·å§‹è§’åº¦è¾“å…¥
                    const startAngleInput = document.createElement('input');
                    startAngleInput.type = 'number';
                    startAngleInput.value = landmark.startAngle;
                    startAngleInput.step = '0.1';
                    startAngleInput.placeholder = 'èµ·å§‹è§’åº¦';
                    startAngleInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'startAngle', parseFloat(e.target.value));
                    });

                    // ç»“æŸè§’åº¦è¾“å…¥
                    const endAngleInput = document.createElement('input');
                    endAngleInput.type = 'number';
                    endAngleInput.value = landmark.endAngle;
                    endAngleInput.step = '0.1';
                    endAngleInput.placeholder = 'ç»“æŸè§’';
                    endAngleInput.addEventListener('change', function(e) {
                        updateLandmark(index, 'endAngle', parseFloat(e.target.value));
                    });

                    // åˆ é™¤æŒ‰é’®
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Ã—';
                    deleteButton.className = 'delete-landmark';
                    deleteButton.addEventListener('click', function() {
                        removeLandmark(index);
                    });

                    // å°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
                    landmarkContainer.appendChild(nameInput);
                    landmarkContainer.appendChild(angleInput);
                    landmarkContainer.appendChild(startAngleInput);
                    landmarkContainer.appendChild(endAngleInput);
                    landmarkContainer.appendChild(deleteButton);

                    landmarksGroup.appendChild(landmarkContainer);
                });
            }

            // æ·»åŠ æ–°åœ°æ ‡æŒ‰é’®
            const addButton = document.createElement('button');
            addButton.textContent = 'æ·»åŠ åœ°æ ‡';
            addButton.className = 'add-landmark';
            addButton.addEventListener('click', function() {
                if (!currentPlanetData.LANDMARKS) {
                    currentPlanetData.LANDMARKS = [];
                }

                const newLandmark = {
                    name: "æ–°åœ°æ ‡",
                    angle: 0.0,
                    startAngle: 0.0,
                    endAngle: 0.0
                };

                currentPlanetData.LANDMARKS.push(newLandmark);
                showModuleEditor('landmarks'); // é‡æ–°æ¸²æŸ“åœ°æ ‡æ¨¡å—
            });

            landmarksSection.appendChild(landmarksGroup);
            landmarksSection.appendChild(addButton);
        }

        // æ·»åŠ ç›¸åº”çš„ CSS æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .landmarks-group {
                margin: 10px 0;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 4px;
            }

            .landmark-item {
                display: flex;
                gap: 10px;
                margin-bottom: 8px;
                align-items: center;
            }

            .landmark-item input[type="text"] {
                width: 200px;
                padding: 5px;
                border: 1px solid #ddd;
                border-radius: 3px;
            }

            .landmark-item input[type="number"] {
                width: 100px;
                padding: 5px;
                border: 1px solid #ddd;
                border-radius: 3px;
            }

            .delete-landmark {
                padding: 2px 8px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .add-landmark {
                margin-top: 10px;
                padding: 8px 15px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .delete-landmark:hover {
                background: #c82333;
            }

            .add-landmark:hover {
                background: #218838;
            }
        `;
        document.head.appendChild(style);

        // ä¿®æ”¹åŸºç¡€æ•°æ®å­—æ®µçš„å¤„ç†
        function updateBaseData(field, value) {
            console.log(`æ›´æ–°åŸºç¡€æ•°æ®: ${field} = ${value}`);
            if (!currentPlanetData.BASE_DATA) {
                currentPlanetData.BASE_DATA = {};
            }

            // ç‰¹æ®Šå¤„ç† velocityArrowsHeight å­—æ®µ
            if (field === 'velocityArrowsHeight') {
                // å¦‚æœå€¼æ˜¯ "NaN"ï¼Œç›´æ¥å­˜å‚¨å­—ç¬¦ä¸² "NaN"
                if (value === "NaN" || value === "") {
                    currentPlanetData.BASE_DATA[field] = "NaN";
                } else {
                    currentPlanetData.BASE_DATA[field] = parseFloat(value);
                }
            } else {
                // å…¶ä»–å­—æ®µæ­£å¸¸å¤„ç†
                currentPlanetData.BASE_DATA[field] = parseFloat(value);
            }
        }

        // ä¿®æ”¹åŸºç¡€æ•°æ®å­—æ®µçš„åˆ›å»º
        const baseFields = [
            // ... å…¶ä»–å­—æ®µ ...
            {
                id: 'velocityArrowsHeight',
                label: 'é€Ÿåº¦ç®­å¤´é«˜åº¦ï¼š',
                type: 'text', // æ”¹ä¸º text ç±»å‹è€Œä¸æ˜¯ number
                value: currentPlanetData?.BASE_DATA?.velocityArrowsHeight || "NaN"
            },
            // ... å…¶ä»–å­—æ®µ ...
        ];

        // ä¿®æ”¹å­—æ®µåˆ›å»ºé€»è¾‘
        if (field.type === 'number') {
            input.type = 'number';
            if (field.step) input.step = field.step;
            if (field.min) input.min = field.min;
            if (field.max) input.max = field.max;
            input.value = field.value;
            input.oninput = e => updateBaseData(field.id, e.target.value);
        } else {
            input.type = 'text';
            input.value = field.value;
            input.oninput = e => updateBaseData(field.id, e.target.value);
        }

        // æ·»åŠ åœ°æ ‡åˆå§‹åŒ–å‡½æ•°
        function initializeLandmarks() {
            const landmarksList = document.getElementById('landmarksList');
            const addLandmarkButton = document.querySelector('.add-landmark');
            
            // æ¸…ç©ºç°æœ‰åˆ—è¡¨
            landmarksList.innerHTML = '';
            
            // æ˜¾ç¤ºç°æœ‰åœ°æ ‡
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.forEach((landmark, index) => {
                    const landmarkItem = createLandmarkItem(landmark, index);
                    landmarksList.appendChild(landmarkItem);
                });
            }

            // ç»‘å®šæ·»åŠ åœ°æ ‡æŒ‰é’®äº‹ä»¶
            addLandmarkButton.onclick = addNewLandmark;
        }

        // åˆ›å»ºå•ä¸ªåœ°æ ‡é¡¹
        function createLandmarkItem(landmark, index) {
            const item = document.createElement('div');
            item.className = 'landmark-item';

            // åç§°è¾“å…¥
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = landmark.name;
            nameInput.placeholder = 'åœ°æ ‡åç§°';
            nameInput.addEventListener('change', (e) => updateLandmarkField(index, 'name', e.target.value));

            // è§’åº¦è¾“å…¥
            const angleInput = document.createElement('input');
            angleInput.type = 'number';
            angleInput.value = landmark.angle;
            angleInput.step = '0.1';
            angleInput.placeholder = 'è§’åº¦';
            angleInput.addEventListener('change', (e) => updateLandmarkField(index, 'angle', parseFloat(e.target.value)));

            // èµ·å§‹è§’åº¦è¾“å…¥
            const startAngleInput = document.createElement('input');
            startAngleInput.type = 'number';
            startAngleInput.value = landmark.startAngle;
            startAngleInput.step = '0.1';
            startAngleInput.placeholder = 'èµ·å§‹è§’åº¦';
            startAngleInput.addEventListener('change', (e) => updateLandmarkField(index, 'startAngle', parseFloat(e.target.value)));

            // ç»“æŸè§’åº¦è¾“å…¥
            const endAngleInput = document.createElement('input');
            endAngleInput.type = 'number';
            endAngleInput.value = landmark.endAngle;
            endAngleInput.step = '0.1';
            endAngleInput.placeholder = 'ç»“æŸè§’åº¦';
            endAngleInput.addEventListener('change', (e) => updateLandmarkField(index, 'endAngle', parseFloat(e.target.value)));

            // åˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Ã—';
            deleteButton.className = 'delete-landmark';
            deleteButton.addEventListener('click', () => deleteLandmark(index));

            // æ·»åŠ æ‰€æœ‰å…ƒç´ åˆ°å®¹å™¨
            item.appendChild(nameInput);
            item.appendChild(angleInput);
            item.appendChild(startAngleInput);
            item.appendChild(endAngleInput);
            item.appendChild(deleteButton);

            return item;
        }

        // æ·»åŠ æ–°åœ°æ ‡
        function addNewLandmark() {
            if (!currentPlanetData.LANDMARKS) {
                currentPlanetData.LANDMARKS = [];
            }

            const newLandmark = {
                name: "æ–°åœ°æ ‡",
                angle: 0.0,
                startAngle: 0.0,
                endAngle: 0.0
            };

            currentPlanetData.LANDMARKS.push(newLandmark);
            initializeLandmarks(); // é‡æ–°æ¸²æŸ“åœ°æ ‡åˆ—è¡¨
        }

        // æ›´æ–°åœ°æ ‡å­—æ®µ
        function updateLandmarkField(index, field, value) {
            if (currentPlanetData?.LANDMARKS?.[index]) {
                currentPlanetData.LANDMARKS[index][field] = value;
                // æŒ‰è§’åº¦æ’åº
                currentPlanetData.LANDMARKS.sort((a, b) => a.angle - b.angle);
                initializeLandmarks(); // é‡æ–°æ¸²æŸ“åœ°æ ‡åˆ—è¡¨
            }
        }

        // åˆ é™¤åœ°æ ‡
        function deleteLandmark(index) {
            if (currentPlanetData?.LANDMARKS) {
                currentPlanetData.LANDMARKS.splice(index, 1);
                initializeLandmarks(); // é‡æ–°æ¸²æŸ“åœ°æ ‡åˆ—è¡¨
            }
        }
        // æ·»åŠ é«˜åº¦å›¾åˆ—è¡¨ç®¡ç†ç›¸å…³å‡½æ•°
        async function loadHeightmaps(dirHandle) {
            try {
                const heightmapDir = await dirHandle.getDirectoryHandle('Heightmap Data');
                // åˆå§‹åŒ–å…¨å±€ heightmaps æ•°ç»„
                window.heightmaps = [];
                
                // éå†Heightmap Dataç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
                for await (const entry of heightmapDir.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                        const heightmapName = entry.name.replace('.txt', '');
                        window.heightmaps.push(heightmapName);
                        addHeightmapToList(heightmapName, entry);
                    }
                }
                // å¯¹é«˜åº¦å›¾åç§°è¿›è¡Œæ’åº
                window.heightmaps.sort();
                
            } catch (err) {
                console.error('åŠ è½½é«˜åº¦å›¾åˆ—è¡¨å¤±è´¥:', err);
                // å¦‚æœåŠ è½½å¤±è´¥,è®¾ç½®é»˜è®¤å€¼
                window.heightmaps = [];
            }
        }

        // ä¿®æ”¹æ·»åŠ é«˜åº¦å›¾åˆ°åˆ—è¡¨çš„å‡½æ•°
        function addHeightmapToList(name, fileHandle) {
            const heightmapsList = document.getElementById('heightmapsList');
            const heightmapItem = document.createElement('div');
            heightmapItem.className = 'heightmap-item';
            
            // åˆ›å»ºå¯ç‚¹å‡»çš„æ–‡ä»¶å
            const nameDiv = document.createElement('div');
            nameDiv.className = 'heightmap-name';
            nameDiv.textContent = name;
            nameDiv.onclick = () => viewHeightmap(name); // ç‚¹å‡»æ–‡ä»¶åæŸ¥çœ‹é«˜åº¦å›¾
            
            // åˆ›å»ºåˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.textContent = 'Ã—';
            deleteButton.onclick = () => deleteHeightmap(name);
            
            heightmapItem.appendChild(nameDiv);
            heightmapItem.appendChild(deleteButton);
            heightmapsList.appendChild(heightmapItem);
        }

        async function viewHeightmap(name) {
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                const fileHandle = await heightmapDir.getFileHandle(`${name}.txt`);
                const file = await fileHandle.getFile();
                const content = await file.text();
                const heightmapData = JSON.parse(content);
                
                // æ˜¾ç¤ºé«˜åº¦å›¾é¢„è§ˆ
                showHeightmapPreview(name, heightmapData.points);
            } catch (err) {
                console.error('è¯»å–é«˜åº¦å›¾å¤±è´¥:', err);
            }
        }

        // 2. åŸºç¡€å·¥å…·å‡½æ•°
        function drawHeightmapGraph(ctx, points) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const minValue = 0.0;
            const maxValue = 1.0;
            const valueRange = maxValue - minValue; // ç­‰äº2.0
            
            const scaleX = width / (points.length - 1);
            const padding = height * 0.1;
            const scaleY = (height - 2 * padding) / valueRange;
            
            // ç»˜åˆ¶å‚è€ƒçº¿å’Œåˆ»åº¦
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // ç»˜åˆ¶æ°´å¹³å‚è€ƒçº¿ï¼ˆä»-1.0åˆ°1.0ï¼Œæ­¥è¿›0.2ï¼‰
            for(let value = minValue; value <= maxValue; value += 0.2) {
                const y = height - padding - ((value - minValue) * scaleY);
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
                
                // æ·»åŠ åˆ»åº¦å€¼
                ctx.fillStyle = '#666';
                ctx.textAlign = 'right';
                ctx.fillText(value.toFixed(1), 30, y + 4);
            }
            
            // ç»˜åˆ¶é«˜åº¦å›¾
            ctx.beginPath();
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 2;
            
            points.forEach((point, index) => {
                const x = index * scaleX;
                // å°†ç‚¹çš„å€¼é™åˆ¶åœ¨ -1.0 åˆ° 1.0 ä¹‹é—´
                const clampedPoint = Math.max(minValue, Math.min(maxValue, point));
                const y = height - padding - ((clampedPoint - minValue) * scaleY);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // æ·»åŠ å‚ç›´ç½‘æ ¼çº¿
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            
            const gridCount = 10;
            for(let i = 1; i < gridCount; i++) {
                const x = (width / gridCount) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
        }

        // 3. å·¥å…·å®ç°å‡½æ•°
        function applyBrush(index, points, size, strength) {
            const halfSize = Math.floor(size / 2);
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex >= 0 && targetIndex < points.length) {
                    const influence = 1 - Math.abs(i) / halfSize;
                    points[targetIndex] += strength * influence;
                    points[targetIndex] = Math.max(-1, Math.min(1, points[targetIndex]));
                }
            }
        }

        function applySmooth(index, points, size) {
            const halfSize = Math.floor(size / 2);
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex > 0 && targetIndex < points.length - 1) {
                    points[targetIndex] = (points[targetIndex-1] + points[targetIndex] + points[targetIndex+1]) / 3;
                }
            }
        }

        function applyNoise(index, points, size, strength) {
            const halfSize = Math.floor(size / 2);
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex >= 0 && targetIndex < points.length) {
                    const noise = (Math.random() - 0.5) * 2 * strength;
                    points[targetIndex] += noise;
                    points[targetIndex] = Math.max(-1, Math.min(1, points[targetIndex]));
                }
            }
        }

        function applyFlatten(index, points, size) {
            const halfSize = Math.floor(size / 2);
            const targetHeight = points[index];
            for(let i = -halfSize; i <= halfSize; i++) {
                const targetIndex = index + i;
                if(targetIndex >= 0 && targetIndex < points.length) {
                    points[targetIndex] = targetHeight;
                }
            }
        }

        // 4. å·¥å…·é€‰æ‹©å’Œåº”ç”¨å‡½æ•°
        function selectTool(toolId) {
            currentTool = toolId;
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${toolId}"]`).classList.add('active');
        }

        function applyTool(e, canvas, points) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const index = Math.floor((x / canvas.width) * (points.length - 1));
            const brushSize = parseInt(document.getElementById('brushSize').value) || 10; // é»˜è®¤å€¼10
            const strength = parseFloat(document.getElementById('brushStrength').value) || 0.2; // é»˜è®¤å€¼0.2
            
            switch(currentTool) {
                case 'brush':
                    applyBrush(index, points, brushSize, strength);
                    break;
                case 'smooth':
                    applySmooth(index, points, brushSize);
                    break;
                case 'noise':
                    applyNoise(index, points, brushSize, strength);
                    break;
                case 'flatten':
                    applyFlatten(index, points, brushSize);
                    break;
            }
            
            drawHeightmapGraph(canvas.getContext('2d'), points);
        }

        // 5. ç•Œé¢äº¤äº’å‡½æ•°
        function setupCanvasInteraction(canvas, points) {
            // åˆ›å»ºpointsçš„å‰¯æœ¬
            currentPoints = Array.from(points);  // ä½¿ç”¨ Array.from åˆ›å»ºæ–°æ•°ç»„
            
            canvas.onmousedown = (e) => {
                isDrawing = true;
                applyTool(e, canvas, currentPoints);
            };
            
            canvas.onmousemove = (e) => {
                if (isDrawing) {
                    applyTool(e, canvas, currentPoints);
                }
            };
            
            canvas.onmouseup = () => {
                isDrawing = false;
            };
            
            canvas.onmouseleave = () => {
                isDrawing = false;
            };
        }

        // 6. UIåˆ›å»ºå‡½æ•°
        function createEditToolbar() {
            const toolbar = document.createElement('div');
            toolbar.className = 'heightmap-toolbar';
            
            const tools = [
                { id: 'brush', icon: 'ğŸ–Œï¸', name: 'ç¬”åˆ·' },
                { id: 'smooth', icon: 'ğŸ”„', name: 'å¹³æ»‘' },
                { id: 'noise', icon: 'ğŸ“Š', name: 'å™ªå£°' },
                { id: 'flatten', icon: 'ğŸ“', name: 'å¹³å¦åŒ–' }
            ];
            
            tools.forEach(tool => {
                const button = document.createElement('button');
                button.className = 'tool-button';
                button.dataset.tool = tool.id;
                button.innerHTML = `${tool.icon} ${tool.name}`;
                button.onclick = () => selectTool(tool.id);
                toolbar.appendChild(button);
            });
            
            const toolProperties = document.createElement('div');
            toolProperties.className = 'tool-properties';
            
            // ç¬”åˆ·å¤§å° - æ”¹ä¸ºè¾“å…¥æ¡†
            const brushSize = document.createElement('div');
            brushSize.className = 'tool-property';
            brushSize.innerHTML = `
                <label>ç¬”åˆ·å¤§å°: </label>
                <input type="number" id="brushSize" value="10" min="1" max="100">
            `;
            
            // å¼ºåº¦ - æ”¹ä¸ºè¾“å…¥æ¡†ï¼ŒèŒƒå›´[-1,1]ï¼Œé»˜è®¤0.2
            const brushStrength = document.createElement('div');
            brushStrength.className = 'tool-property';
            brushStrength.innerHTML = `
                <label>å¼ºåº¦: </label>
                <input type="number" id="brushStrength" value="0.2" min="-1" max="1" step="0.1">
            `;
            
            toolProperties.appendChild(brushSize);
            toolProperties.appendChild(brushStrength);
            toolbar.appendChild(toolProperties);
            
            return toolbar;
        }

        // 7. æœ€åæ˜¯ä¸»è¦çš„æ˜¾ç¤ºå‡½æ•°
        function showHeightmapPreview(name, points) {
            const previewContainer = document.getElementById('heightmapPreview');
            previewContainer.innerHTML = '';
            
            const title = document.createElement('h3');
            title.textContent = `é«˜åº¦å›¾: ${name}`;
            previewContainer.appendChild(title);
            
            // æ·»åŠ æŒ‰é’®
            previewContainer.appendChild(createHeightmapButtons());
            
            // æ·»åŠ ï¿½ï¿½å…·æ 
            const toolbar = createEditToolbar();
            previewContainer.appendChild(toolbar);
            
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 500;
            const ctx = canvas.getContext('2d');
            
            drawHeightmapGraph(ctx, points);
            setupCanvasInteraction(canvas, points);
            
            previewContainer.appendChild(canvas);
        }

        function createHeightmapButtons() {
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'heightmap-buttons';
            
            // åŠ è½½é«˜åº¦å›¾æŒ‰é’®
            const loadButton = document.createElement('button');
            loadButton.textContent = 'åŠ è½½é«˜åº¦å›¾';
            loadButton.onclick = loadHeightmapFile;
            
            // æ–°å»ºé«˜åº¦å›¾æŒ‰é’®
            const newButton = document.createElement('button');
            newButton.textContent = 'æ–°å»ºé«˜åº¦å›¾';
            newButton.onclick = createNewHeightmap;
            
            // ä¿å­˜é«˜åº¦å›¾æŒ‰é’®
            const saveButton = document.createElement('button');
            saveButton.textContent = 'ä¿å­˜é«˜åº¦å›¾';
            saveButton.onclick = saveCurrentHeightmap;
            
            // æ‰©å±•é«˜åº¦å›¾æŒ‰é’®
            const expandButton = document.createElement('button');
            expandButton.textContent = 'æ‰©å±•é«˜åº¦å›¾';
            expandButton.onclick = expandHeightmap;
            
            buttonsDiv.appendChild(loadButton);
            buttonsDiv.appendChild(newButton);
            buttonsDiv.appendChild(saveButton);
            buttonsDiv.appendChild(expandButton);
            
            return buttonsDiv;
        }

        // åŠ è½½é«˜åº¦å›¾æ–‡ä»¶
        async function loadHeightmapFile() {
            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'é«˜åº¦å›¾æ–‡ä»¶',
                        accept: {
                            'text/plain': ['.txt']
                        }
                    }]
                });
                
                const file = await fileHandle.getFile();
                const content = await file.text();
                const heightmapData = JSON.parse(content);
                
                if (!Array.isArray(heightmapData.points)) {
                    throw new Error('æ— æ•ˆçš„é«˜åº¦å›¾æ ¼å¼');
                }
                
                // å¤åˆ¶åˆ°é«˜åº¦å›¾ç›®å½•
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data', { create: true });
                const newFileHandle = await heightmapDir.getFileHandle(fileHandle.name, { create: true });
                const writable = await newFileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                // é‡æ–°åŠ è½½åˆ—è¡¨
                await loadHeightmaps(currentDirHandle);
                
            } catch (err) {
                console.error('åŠ è½½é«˜åº¦å›¾æ–‡ä»¶å¤±è´¥:', err);
            }
        }

        // æ–°å»ºé«˜åº¦å›¾
        async function createNewHeightmap() {
            const name = prompt('è¯·è¾“å…¥é«˜åº¦å›¾åç§°:', 'æ–°é«˜åº¦å›¾');
            if (!name) return;
            
            // åˆ›å»º50ä¸ªåˆå§‹æ•°æ®ç‚¹
            const points = Array(50).fill(0.5); // åˆå§‹å€¼éƒ½è®¾ä¸º0.5
            
            const heightmapData = {
                points: points
            };
            
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data', { create: true });
                const fileHandle = await heightmapDir.getFileHandle(`${name}.txt`, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(heightmapData, null, 4));
                await writable.close();
                
                // é‡æ–°åŠ è½½åˆ—è¡¨
                await loadHeightmaps(currentDirHandle);
                
                // ç›´æ¥æ˜¾ç¤ºæ–°å»ºçš„é«˜åº¦å›¾
                showHeightmapPreview(name, points);
                
            } catch (err) {
                console.error('æ–°å»ºé«˜åº¦å›¾å¤±è´¥:', err);
            }
        }

        // ä¿å­˜å½“å‰é«˜åº¦å›¾
        async function saveCurrentHeightmap() {
            if (!currentPoints || !currentHeightmapName) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„é«˜åº¦å›¾');
                return;
            }
            
            const heightmapData = {
                points: currentPoints
            };
            
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                const fileHandle = await heightmapDir.getFileHandle(`${currentHeightmapName}.txt`, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(heightmapData, null, 4));
                await writable.close();
                
                alert('ä¿å­˜æˆåŠŸ');
                
            } catch (err) {
                console.error('ä¿å­˜é«˜åº¦å›¾å¤±è´¥:', err);
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        // æ‰©å±•é«˜åº¦å›¾
        async function expandHeightmap() {
            if (!currentPoints) {
                alert('æ²¡æœ‰å¯æ‰©å±•çš„é«˜åº¦å›¾');
                return;
            }
            
            const count = parseInt(prompt('è¯·è¾“å…¥è¦æ‰©å±•çš„æ•°æ®ç‚¹æ•°é‡:', '10'));
            if (isNaN(count) || count <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            // åœ¨å½“å‰ç‚¹æ•°æ®æœ«å°¾æ·»åŠ æ–°ç‚¹
            const lastValue = currentPoints[currentPoints.length - 1];
            const newPoints = Array(count).fill(lastValue);
            currentPoints = [...currentPoints, ...newPoints];
            
            // é‡æ–°ç»˜åˆ¶
            const canvas = document.querySelector('#heightmapPreview canvas');
            if (canvas) {
                drawHeightmapGraph(canvas.getContext('2d'), currentPoints);
            }
        }

        // ä¿®æ”¹ showHeightmapPreview å‡½æ•°
        function showHeightmapPreview(name, points) {
            currentHeightmapName = name; // ä¿å­˜å½“å‰é«˜åº¦å›¾åç§°
            
            const previewContainer = document.getElementById('heightmapPreview');
            previewContainer.innerHTML = '';
            
            const title = document.createElement('h3');
            title.textContent = `é«˜åº¦å›¾: ${name}`;
            previewContainer.appendChild(title);
            
            // æ·»åŠ æŒ‰é’®
            previewContainer.appendChild(createHeightmapButtons());
            
            // æ·»åŠ å·¥å…·æ 
            const toolbar = createEditToolbar();
            previewContainer.appendChild(toolbar);
            
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 500;
            const ctx = canvas.getContext('2d');
            
            drawHeightmapGraph(ctx, points);
            setupCanvasInteraction(canvas, points);
            
            previewContainer.appendChild(canvas);
        }

        async function deleteHeightmap(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é«˜åº¦å›¾ "${name}" å—ï¼Ÿ`)) return;
            
            try {
                const heightmapDir = await currentDirHandle.getDirectoryHandle('Heightmap Data');
                await heightmapDir.removeEntry(`${name}.txt`);
                await loadHeightmaps(currentDirHandle); // é‡æ–°åŠ è½½åˆ—è¡¨
            } catch (err) {
                console.error('åˆ é™¤é«˜åº¦å›¾å¤±è´¥:', err);
            }
        }
        async function loadTextures(dirHandle) {
            console.log('loadTextures è¢«è°ƒç”¨'); // è°ƒè¯•æ—¥å¿—
            if (!dirHandle) {
                console.error('ç›®å½•å¥æŸ„ä¸å­˜åœ¨');
                return;
            }

            try {
                console.log('å°è¯•è·å– Texture Data ç›®å½•...'); // è°ƒè¯•æ—¥å¿—
                const textureDir = await dirHandle.getDirectoryHandle('Texture Data');
                console.log('æˆåŠŸè·å– Texture Data ç›®å½•'); // è°ƒè¯•æ—¥å¿—
                
                const texturesList = document.getElementById('texturesList');
                if (!texturesList) {
                    console.error('æ‰¾ä¸åˆ° texturesList å…ƒç´ ');
                    return;
                }
                
                texturesList.innerHTML = '';
                console.log('å·²æ¸…ç©ºç°æœ‰åˆ—è¡¨'); // è°ƒè¯•æ—¥å¿—
                
                let fileCount = 0;
                for await (const entry of textureDir.values()) {
                    console.log('å‘ç°æ–‡ä»¶:', entry.name); // è°ƒè¯•æ—¥å¿—
                    if (entry.kind === 'file' && (entry.name.endsWith('.png') || entry.name.endsWith('.jpg'))) {
                        const textureName = entry.name.replace(/\.(png|jpg)$/, '');
                        addTextureToList(textureName, entry);
                        fileCount++;
                    }
                }
                console.log(`å…±åŠ è½½äº† ${fileCount} ä¸ªå›¾å±‚æ–‡ä»¶`); // è°ƒè¯•æ—¥å¿—
                
            } catch (err) {
                console.error('åŠ è½½å›¾å±‚åˆ—è¡¨å¤±è´¥:', err.message);
                console.error(err); // è¾“å‡ºå®Œæ•´é”™è¯¯ä¿¡æ¯
            }
        }

        // ä¿®æ”¹ addTextureToList å‡½æ•°ï¼Œæ·»åŠ æ›´å¤šçš„è§†è§‰åé¦ˆ
        function addTextureToList(name, fileHandle) {
            const texturesList = document.getElementById('texturesList');
            if (!texturesList) {
                console.error('æ‰¾ä¸åˆ°texturesListå…ƒç´ ');
                return;
            }

            const textureItem = document.createElement('div');
            textureItem.className = 'texture-item';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'texture-name';
            nameDiv.textContent = name;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            nameDiv.onclick = () => {
                // ç§»é™¤å…¶ä»–é¡¹ç›®çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.texture-item').forEach(item => {
                    item.classList.remove('selected');
                });
                // æ·»åŠ é€‰ä¸­çŠ¶æ€
                textureItem.classList.add('selected');
                viewTexture(name);
            };
            
            textureItem.appendChild(nameDiv);
            texturesList.appendChild(textureItem);
            console.log('æ·»åŠ å›¾å±‚åˆ°åˆ—è¡¨:', name); // è°ƒè¯•æ—¥å¿—
        }

        // ä¿®æ”¹ viewTexture å‡½æ•°ï¼Œæ·»åŠ æ›´å¤šçš„é”™è¯¯å¤„ç†
        async function viewTexture(name) {
            if (!currentDirHandle) {
                console.error('æœªåŠ è½½æ‹“å±•åŒ…');
                return;
            }

            try {
                const textureDir = await currentDirHandle.getDirectoryHandle('Texture Data');
                // å°è¯•ä¸¤ç§æ–‡ä»¶æ‰©å±•å
                let fileHandle;
                try {
                    fileHandle = await textureDir.getFileHandle(`${name}.png`);
                } catch {
                    fileHandle = await textureDir.getFileHandle(`${name}.jpg`);
                }
                
                const file = await fileHandle.getFile();
                showTexturePreview(name, URL.createObjectURL(file));
                console.log('åŠ è½½å›¾å±‚é¢„è§ˆ:', name); // è°ƒè¯•æ—¥å¿—
            } catch (err) {
                console.error('è¯»å–å›¾å±‚å¤±è´¥:', err);
            }
        }

        // æ˜¾ç¤ºå›¾å±‚é¢„è§ˆ
        function showTexturePreview(name, imageUrl) {
            const previewContainer = document.getElementById('texturePreview');
            previewContainer.innerHTML = '';
            
            // åˆ›å»ºé¢„è§ˆæ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = `å›¾å±‚: ${name}`;
            previewContainer.appendChild(title);
            
            // åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
            const img = document.createElement('img');
            img.src = imageUrl;
            img.className = 'texture-preview-image';
            img.onload = () => {
                // å›¾ç‰‡åŠ è½½å®Œæˆåé‡Šæ”¾URL
                URL.revokeObjectURL(imageUrl);
            };
            
            previewContainer.appendChild(img);
        }

        // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåå†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆ'); // è°ƒè¯•æ—¥å¿—
            // åˆå§‹åŒ–é¡µé¢çŠ¶æ€
            switchPage('settings');
        });

        // å…¬å¼è§£æå‡½æ•°
        function parseFormula(formulaStr) {
            if (!formulaStr || typeof formulaStr !== 'string') {
                return {
                    output: 'OUTPUT',
                    heightmap: 'Perlin',
                    scale: 6283.18530718,
                    height: 1,
                    curve: '',
                    mask: ''
                };
            }

            // åŒ¹é…å…¬å¼æ ¼å¼
            const regex = /(\w+)\s*=\s*AddHeightMap\(\s*(\w+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:\s*,\s*(\w+)?)?(?:\s*,\s*(\w+))?\s*\)/;
            const match = formulaStr.match(regex);
            
            if (!match) {
                return {
                    output: 'OUTPUT',
                    heightmap: 'Perlin',
                    scale: 6283.18530718,
                    height: 1,
                    curve: '',
                    mask: ''
                };
            }

            return {
                output: match[1],
                heightmap: match[2],
                scale: parseFloat(match[3]),
                height: parseFloat(match[4]),
                curve: match[5] || '',
                mask: match[6] || ''
            };
        }

        // åˆ›å»ºå…¬å¼ç¼–è¾‘å™¨
        function createFormulaEditor(formula = '') {
            const editor = document.createElement('div');
            editor.className = 'formula-editor';

            // è§£æç°æœ‰å…¬å¼æˆ–ä½¿ç”¨é»˜è®¤å€¼
            const parsedFormula = parseFormula(formula);

            // åˆ›å»ºè¾“å‡ºå˜é‡é€‰æ‹©å™¨
            const outputSelect = document.createElement('select');
            outputSelect.className = 'output-select';
            ['OUTPUT', 'M'].forEach(output => {
                const option = document.createElement('option');
                option.value = output;
                option.textContent = output;
                if (output === parsedFormula.output) {
                    option.selected = true;
                }
                outputSelect.appendChild(option);
            });

            // åˆ›å»ºé«˜åº¦å›¾é€‰æ‹©å™¨ - ä½¿ç”¨ heightmaps æ•°ç»„
            const heightmapSelect = document.createElement('select');
            heightmapSelect.className = 'heightmap-select';
            
            // ç¡®ä¿ heightmaps å­˜åœ¨ä¸”æ˜¯æ•°ç»„
            if (Array.isArray(heightmaps)) {
                heightmaps.forEach(heightmap => {
                    const option = document.createElement('option');
                    option.value = heightmap;
                    option.textContent = heightmap;
                    if (heightmap === parsedFormula.heightmap) {
                        option.selected = true;
                    }
                    heightmapSelect.appendChild(option);
                });
            } else {
                // å¦‚æœ heightmaps ä¸å¯ç”¨,æ·»åŠ é»˜è®¤é€‰é¡¹
                const defaultHeightmaps = [];
                defaultHeightmaps.forEach(heightmap => {
                    const option = document.createElement('option');
                    option.value = heightmap;
                    option.textContent = heightmap;
                    if (heightmap === parsedFormula.heightmap) {
                        option.selected = true;
                    }
                    heightmapSelect.appendChild(option);
                });
            }

            // åˆ›å»ºç¼©æ”¾è¾“å…¥æ¡†
            const scaleInput = document.createElement('input');
            scaleInput.type = 'number';
            scaleInput.className = 'scale-input';
            scaleInput.value = parsedFormula.scale;
            scaleInput.step = '0.1';

            // åˆ›å»ºé«˜åº¦è¾“å…¥æ¡†
            const heightInput = document.createElement('input');
            heightInput.type = 'number';
            heightInput.className = 'height-input';
            heightInput.value = parsedFormula.height;
            heightInput.step = '0.1';

            // åˆ›å»ºæ›²çº¿é€‰æ‹©å™¨
            const curveSelect = heightmapSelect;

            // åˆ›å»ºé®ç½©é€‰æ‹©å™¨
            const maskSelect = document.createElement('select');
            maskSelect.className = 'mask-select';
            ['', 'M'].forEach(mask => {
                const option = document.createElement('option');
                option.value = mask;
                option.textContent = mask || 'null';
                if (mask === parsedFormula.mask) {
                    option.selected = true;
                }
                maskSelect.appendChild(option);
            });

            // åˆ›å»ºåˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'åˆ é™¤';
            deleteButton.onclick = () => editor.remove();

            // å°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°ç¼–è¾‘å™¨
            editor.appendChild(outputSelect);
            editor.appendChild(document.createTextNode(' = AddHeightMap( '));
            editor.appendChild(heightmapSelect);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(scaleInput);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(heightInput);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(curveSelect);
            editor.appendChild(document.createTextNode(', '));
            editor.appendChild(maskSelect);
            editor.appendChild(document.createTextNode(' )'));
            editor.appendChild(deleteButton);

            return editor;
        }

        // ç”Ÿæˆå…¬å¼å­—ç¬¦ä¸²
        function generateFormula(output, heightmap, scale, height, curve, mask) {
            let formula = `${output} = AddHeightMap( ${heightmap}, ${scale}, ${height}`;
            if (curve || mask) {
                formula += `, ${curve || 'null'}`;
            }
            if (mask) {
                formula += `, ${mask}`;
            }
            formula += ')';
            return formula;
        }

        // æ›´æ–°å…¬å¼åˆ—è¡¨
        function updateFormulas(difficulty) {
            if (!currentPlanetData.TERRAIN_DATA) {
                currentPlanetData.TERRAIN_DATA = {};
            }
            if (!currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties) {
                currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties = {};
            }

            const container = document.getElementById(`${difficulty.toLowerCase()}Formulas`);
            const formulas = [];

            container.querySelectorAll('.formula-editor').forEach(editor => {
                const output = editor.querySelector('.output-select').value;
                const heightmap = editor.querySelector('.heightmap-select').value;
                const scale = parseFloat(editor.querySelector('.scale-input').value);
                const height = parseFloat(editor.querySelector('.height-input').value);
                const curve = editor.querySelector('.curve-select').value;
                const mask = editor.querySelector('.mask-select').value;

                formulas.push(generateFormula(output, heightmap, scale, height, curve, mask));
            });

            currentPlanetData.TERRAIN_DATA.terrainFormulaDifficulties[difficulty] = formulas;
        }

        // æ›´æ–°çº¹ç†å…¬å¼
        function updateTextureFormulas() {
            if (!currentPlanetData.TERRAIN_DATA) {
                currentPlanetData.TERRAIN_DATA = {};
            }

            const container = document.getElementById('textureFormulas');
            const formulas = [];

            container.querySelectorAll('.formula-editor').forEach(editor => {
                const heightmap = editor.querySelector('.heightmap-select').value;
                const scale = parseFloat(editor.querySelector('.scale-input').value);
                const height = parseFloat(editor.querySelector('.height-input').value);
                const curve = editor.querySelector('.curve-select').value;

                formulas.push(generateFormula(heightmap, scale, height, curve));
            });

            currentPlanetData.TERRAIN_DATA.textureFormula = formulas;
        }

    </script>
</body>
</html>